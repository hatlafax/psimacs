# -*- mode: org; coding: utf-8; -*-
#+TITLE: Psimacs Emacs configuration
#+DESCRIPTION: Loading Emacs configuration using org-babel
#+TAGS: Emacs
#+CATEGORIES: editing
#+STARTUP: showeverything
#+OPTIONS: toc:4 h:4 tags:nil
#+EXPORT_EXCLUDE_TAGS: noexport
#+HTML_HEAD: <style type="text/css">
#+HTML_HEAD: .styledtable col:nth-of-type(1) { width: 15% }
#+HTML_HEAD: .styledtable col:nth-of-type(2) { width: 30% }
#+HTML_HEAD: .styledtable col:nth-of-type(3) { width: 55% }
#+HTML_HEAD: </style>
# #+SETUPFILE: site-lisp/org-html-themes/org/theme-readtheorg.setup
# #+SETUPFILE: site-lisp/org-html-themes/org/theme-bigblow.setup
# #+HTML_HEAD: <link rel="stylesheet" type="text/css" href="https://gongzhitaao.org/orgcss/org.css"/>
#+HTML_HEAD: <link rel="stylesheet" href="http://dakrone.github.io/org.css" type="text/css" />

* Introduction
This is *Psimacs*, a /modern/ *Emacs* configuration build from the ground up using a [[https://de.wikipedia.org/wiki/Literate_programming][literate programming]] technique.
The complete configuration [[https://www.gnu.org/software/emacs/manual/html_node/elisp/][Elisp]] code is embedded into a single [[https://orgmode.org/][org-mode]] file. This is the file that your are
currently reading.

Additionally, *Psimacs* allows the synchronization of the user's local *Emacs* configuration with a configuration
repository residing on [[https://www.dropbox.com/][Dropbox]]. This comes quite handy if sharing of one configuration with multiple machines is
desired.

This document not only describes the *Psimacs* configuration, but also some additional information useful
for working with *Emacs* in general. In this respect it serves as a kind of mind map for the author.

Some great useful *Emacs* references:
- [[http://ergoemacs.org/][Xah Emacs Site]]

** Motivation

A lot of *Emacs* configurations can be found on the Internet. Many of them are well crafted and could be used out of
the box. Especially, the great *Emacs* distributions like [[https://www.spacemacs.org/][Spacemacs]], [[https://github.com/hlissner/doom-emacs][Doom-Emacs]] and [[https://github.com/seagle0128/.emacs.d][Centaur-Emacs]] are worth giving a try.
But I wanted to craft my own configuration that is tailored to my needs and that allowed me to learn more about the
vast *Emacs* universe. My configuration it not perfect for everyone and it will not be able to compete against the big
frameworks that are build by a lot of talented people. So feel free to use it or blame it. I am fine with it.

The name *Psimacs* is arbitrarily. I was in search for a catchy name with just one syllable in front of the *macs*.

** Installation

This configuration uses *Emacs* >= 27. Clone the git repository into your *.emcas.d* directory

#+BEGIN_EXAMPLE
mv ~/.emacs.d ~/.emacs.d.bak
git clone https://github.com/hatlafax/psimacs.git ~/.emacs.d
#+END_EXAMPLE

and just run *Emacs*.

The only file really needed is the =early-init.el= file. On startup, it reads the file =init.org= and extracts all the
initialization code into the main =init.el= and various additionally =config/init-*.el= files. The created =init.el=
file is then read and evaluated in the further startup procedure. The =init.el= file loads the other =config/init-*.el=
files on evaluation.

Never edit transient file =init.el= or =config/init-*.el= directly. They will be overridden by the next run of
*Psimacs*. Instead modify the =init.org= file to change your configuration.

You can create a HTML document =init.html= of this file by simply typing =C-c C-e h h= in the *Emacs* buffer for
this file. It is recommended to use this =init.html= for browser reading.

** Usage

All functions and variables that are defined in *Psimacs* are prefixed by a path like string  =psimacs/category=.
The /category/ is used to order the functions and variables by topic. For example the /string/ related function
/starts-with/ is defined as =psimacs/string/starts-with=.

** Dependencies

The configuration does have some dependencies that should be installed separately and beforehand of *Psimacs*.
On default the non *Emacs* dependencies are expected to be installed into directory *c:/utils/* on /Windows OS/.
A directory constant =psimacs/config/dependencies-dir= will be defined by the configuration that allows to change
the default location of the dependencies.

** Disclaimer

This is an *Emacs* beginners configuration and the usage is at one's own risk. It is not tested thoroughly. Please
bear in mind.

Many of the configuration settings are borrowed from other similar endeavors out there.

This is work in progress. Sometimes this *Readme* is ahead of times or not yet updated.

** Limitations / Known Issues

- Tested on Windows operating system only

** License (GPL v3)

Copyright (C) 2020-2021 Johannes Brunen (hatlafax@gmx.de)

License: GNU GENERAL PUBLIC LICENSE Version 3, 29 June 2007

This program is free software; you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.

* Working with Org-Mode
** Embedding code
[[https://orgmode.org/][Org-mode]] allows embedding of source code blocks into =.org=-files and evaluating them by [[https://orgmode.org/worg/org-contrib/babel/][babel]] a core feature build
into [[https://orgmode.org/manual/Working-with-Source-Code.html][org]]. The [[https://www.gnu.org/software/emacs/manual/html_node/elisp/][Elisp]] code is embedded into special code blocks:

#+BEGIN_EXAMPLE
#+BEGIN_SRC emacs-lisp :tangle no
<BODY>
#+END_SRC
#+END_EXAMPLE

Code block with =:tangle yes= or with =:tangle filename= are part of the configuration. However, any code block
can be deactivated, i.e. omitted from the configuration, by using =:tangle no= in the
block declaration.

#+BEGIN_EXAMPLE
#+BEGIN_SRC emacs-lisp :tangle no
(message "this should never be seen in the Message buffer!")
#+END_SRC
#+END_EXAMPLE

Additionally, a whole section can also be deactivated by a /CANCELED/ or a /DISABLED/ item, e.g.:

*** CANCELED Avoid generating /Emacs Lisp/ code per section

The following [[https://www.gnu.org/software/emacs/manual/html_node/elisp/][Elisp]] block should therefore also not be part of the generated =.el= file although the =:tangle yes=
attribute was used. Same is true for /Disabled/ as well as tag /:noexport:/

#+BEGIN_EXAMPLE
#+BEGIN_SRC emacs-lisp :tangle yes
(message "this should not be seen in the Message buffer!")
#+END_SRC
#+END_EXAMPLE

** Debugging the configuration

Loading of the configuration can always be halted on spot by entering and activating the following source code block
which will enter enter the debugger on execution.

#+BEGIN_EXAMPLE
#+BEGIN_SRC emacs-lisp :tangle no
(debug)
#+END_SRC
#+END_EXAMPLE

*** Debugging ELisp with EDebug
[[https://www.gnu.org/software/emacs/manual/html_node/elisp/Edebug.html#Edebug][Edebug]] is a source-level debugger for Emacs Lisp programs that is very useful developing /Lisp/ code. In the following
you can find a some useful commands and settings for debugging with [[https://www.gnu.org/software/emacs/manual/html_node/elisp/Edebug.html#Edebug][Edebug]]:

Embedding a breakpoint into source code: =(edebug)=

| Keybinding        | Command                                 | Description                                                                                                                                                                                  |
|-------------------+-----------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| =C-u C-M-x=       | =M-x eval-defun=                        | Instrument the Lisp code at point. Any call to the function activates Edebug.                                                                                                                |
|-------------------+-----------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| =h=               | =M-x edebug-goto-here=                  | Proceed to the stop point near where point is.                                                                                                                                               |
| =f=               | =M-x edebug-forward-sexp=               | Run the program for one expression.                                                                                                                                                          |
| =o=               | =M-x edebug-step-out=                   | Run the program until the end of the containing sexp.                                                                                                                                        |
| =i=               | =M-x edebug-step-in=                    | Step into the function or macro called by the form after point.                                                                                                                              |
|-------------------+-----------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| =b=               | =M-x edebug-set-breakpoint=             | Set a breakpoint at the stop point at or after point. If you use a prefix argument, the breakpoint is temporary -- it turns off the first time it stops the program.                         |
| =u=               | =M-x edebug-unset-breakpoint=           | Unset the breakpoint (if any) at the stop point at or after point.                                                                                                                           |
| =U=               | =M-x edebug-unset-breakpoints=          | Unset any breakpoints in the current form.                                                                                                                                                   |
| =D=               | =M-x edebug-toggle-disable-breakpoint=  | Toggle whether to disable the breakpoint near point.                                                                                                                                         |
| =x condition RET= | =M-x edebug-set-conditional-breakpoint= | Set a conditional breakpoint which stops the program only if evaluating condition produces a non-nil value.                                                                                  |
| =B=               | =M-x edebug-next-breakpoint=            | Move point to the next breakpoint in the current definition.                                                                                                                                 |
|-------------------+-----------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| =S=               | =M-x edebug-stop=                       | Stop: don't execute any more of the program, but wait for more Edebug commands                                                                                                               |
| =SPC=             | =M-x edebug-step-mode=                  | Step: stop at the next stop point encountered.                                                                                                                                               |
| =n=               | =M-x edebug-next-mode=                  | Next: stop at the next stop point encountered after an expression.                                                                                                                           |
| =t=               | =M-x edebug-trace-mode=                 | Trace: pause (normally one second) at each Edebug stop point.                                                                                                                                |
| =T=               | =M-x edebug-Trace-fast-mode=            | Rapid trace: update the display at each stop point, but don't actually pause.                                                                                                                |
| =g=               | =M-x edebug-go-mode=                    | Go: run until the next breakpoint.                                                                                                                                                           |
| =c=               | =M-x edebug-continue-mode=              | Continue: pause one second at each breakpoint, and then continue.                                                                                                                            |
| =C=               | =M-x edebug-Continue-fast-mode=         | Rapid continue: move point to each breakpoint, but don't pause.                                                                                                                              |
| =G=               | =M-x edebug-Go-nonstop-mode=            | Go non-stop: ignore breakpoints. You can still stop the program by typing S, or any editing command.                                                                                         |
|-------------------+-----------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| =?=               | =M-x edebug-help=                       | Display the help message for Edebug.                                                                                                                                                         |
| =C-]=             | =M-x abort-recursive-edit=              | Abort one level back to the previous command level                                                                                                                                           |
| =q=               | =M-x top-level=                         | Return to the top level editor command loop. This exits all recursive editing levels, including all levels of Edebug activity.                                                               |
| =Q=               | =M-x edebug-top-level-nonstop=          | Like q, but don't stop even for protected code. Like q, but don't stop even for protected code.                                                                                              |
| =r=               | =M-x edebug-previous-result=            | Redisplay the most recently known expression result in the echo area.                                                                                                                        |
| =d=               | =M-x edebug-backtrace=                  | Display a backtrace, excluding Edebug's own functions for clarity.                                                                                                                           |
|-------------------+-----------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| =v=               | =M-x edebug-view-outside=               | Switch to viewing the outside window configuration.  Type =C-x X w= to return to Edebug.                                                                                                     |
| =p=               | =M-x edebug-bounce-point=               | Temporarily display the outside current buffer with point at its outside position, pausing for one second before returning to Edebug. With a prefix argument n, pause for n seconds instead. |
| =w=               | =M-x edebug-where=                      | Move point back to the current stop point in the source code buffer.                                                                                                                         |
| =W=               | =M-x edebug-toggle-save-windows=        | Toggle whether Edebug saves and restores the outside window configuration.                                                                                                                   |
|-------------------+-----------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| =e exp RET=       | =M-x edebug-eval-expression=            | Evaluate expression exp in the context outside of Edebug. That is, Edebug tries to minimize its interference with the evaluation.                                                            |
| =M-: exp RET=     | =M-x eval-expression=                   | Evaluate expression exp in the context of Edebug itself.                                                                                                                                     |
| =C-x C-e=         | =M-x edebug-eval-last-sexp=             | Evaluate the expression before point, in the context outside of Edebug.                                                                                                                      |
| =C-u 0 C-x C-e=   | =C-u 0 M-x edebug-eval-last-sexp=       | Dito, but don't shorten long items (like strings and lists).                                                                                                                                 |
| =E=               | =M-x edebug-visit-eval-list=            | Switch to the evaluation list buffer *edebug*                                                                                                                                                |
| =C-j=             | =M-x edebug-eval-print-last-sexp=       | Evaluate the expression before point, in the outside context, and insert the value in the buffer.                                                                                            |
| =C-u 0 C-j=       | =C-u 0 M-x edebug-eval-print-last-sexp= | Dito, but don't shorten long items (like strings and lists).                                                                                                                                 |
| =C-c C-u=         | =M-x edebug-update-eval-list=           | Build a new evaluation list from the contents of the buffer.                                                                                                                                 |
| =C-c C-d=         | =M-x edebug-delete-eval-item=           | Delete the evaluation list group that point is in.                                                                                                                                           |
| =C-c C-w=         | =M-x edebug-where=                      | Switch back to the source code buffer at the current stop point.                                                                                                                             |
|-------------------+-----------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|

** References to Org-Mode markup
An [[https://writequit.org/denver-emacs/presentations/files/example.org.html][example org-mode file]] used to show basic [[https://orgmode.org][org-mode]] usage. [[https://orgmode.org/manual/Markup-for-Rich-Contents.html][Markup for Rich Contents]] gives detail explanation about
the markup rules used in [[https://orgmode.org][org-mode]] files.

** References to Org-Mode
The following links might be useful for diving deeper into [[http://orgmode.org/][Org-Mode]]:
- [[http://orgmode.org/manual/index.html][Org Mode Manual]]
- [[http://orgmode.org/worg/][Worg, the Org Mode Community]]
- [[https://www.emacswiki.org/emacs/OrgMode][EmacsWiki: Org Mode]]
- [[https://www.suenkler.info/notes/emacs-orgmode/][Aufgabenverwaltung im Emacs Org mode]]
- [[https://blog.aaronbieber.com/2016/01/30/dig-into-org-mode.html][Dig Into Org Mode]]
- [[http://orgmode.org/worg/org-contrib/babel/][Org Mode Babel]]
- [[http://www.howardism.org/Technical/Emacs/literate-programming-tutorial.html][Introduction to Literate Programming]]
- [[https://org-babel.readthedocs.io/en/latest/][Readthedocs about Org Babel]]
- [[http://orgmode.org/worg/orgcard.html][Org Mode reference card]]
- [[http://orgmode.org/orgcard.pdf][Org Mode Ref Card]]
- [[http://ergoemacs.org/emacs/emacs_org_markup.html][Org Mode Markup Cheatsheet]]
- [[http://pragmaticemacs.com/][Pragmatic Emacs]]
- [[http://doc.norang.ca/org-mode.html][Org Mode - Organize Your Life In Plain Text!]]

** References to Emacs Lisp
The following links might be useful for diving deeper into [[https://www.gnu.org/software/emacs/manual/html_node/elisp/][Elisp]]:
- [[https://www.gnu.org/software/emacs/manual/eintr.html][Introduction to Programming in Emacs Lisp]]
- [[https://www.emacswiki.org/emacs/ElispCookbook][EmacsWiki: Lisp Cookbook]]
- [[http://wikemacs.org/wiki/Emacs_Lisp_Cookbook][WikEmacs: Emacs Lisp Cookbook]]
- [[https://github.com/chrisdone/elisp-guide][Emacs Lisp Guide]]
- [[https://www.masteringemacs.org/article/evaluating-elisp-emacs][Evaluating Elisp in Emacs]]
- [[http://ergoemacs.org/emacs/elisp.html][Practical Emacs Lisp]]

* Key binding
I am trying to setup keybinding in a /mnemonics/ way so it's easy to remember (and use).
I am staying with the /standard/ emacs keybinding as much as possible.

*Emacs*'s keybindings has well-defined conventions listed at [[https://www.gnu.org/software/emacs/manual/html%5Fnode/elisp/Key-Binding-Conventions.html][Emacs Key Bindings Convention]].
In summary, the general rules are:
- =C-x= reserved for Emacs native essential keybindings: buffer, window, frame, file, directory, etc.
- =F5= ... =F9= without modifier keys are reserved for users to define.
- =C-c=
    - =C-c C-letter=, =C-c digit= are reserved for major modes.
    - =C-c punctuation= with punctuation in { } < > : ; are also reserved for major modes.
    - =C-c punctuation= with any other punctuation are allocated for minor modes.
    - =C-c letter= are reserved for users. In practice most third-party packages don't give a hoot
      and will gladly stuff their own key binds in there.
- Don't rebind =C-g=, =C-h= and =ESC=.
- =hyper= and =super= are two prefix keys reserved to you. They are remnants from ancient keyboards used in the 80s,
  but live on today in Emacs. Most PC-compatible  keyboards won't have a =super= or =hyper= key so we rebind
  the =<lwindow>= and =<rwindow>= /Windows/ keys and the =<apps> /Application Context/ key to be the =super=
  and =hyper= prefix keys instead.

*Psimacs* uses the =super= and =hyper= key prefixes for all of its own key bindings.

Worth readings about *Emacs* keybindings:
- [[https://karl-voit.at/2018/07/08/emacs-key-bindings/][UOMF: My Emacs Key Binding Strategy]]
- [[https://www.masteringemacs.org/article/mastering-key-bindings-emacs][Mastering Key Bindings in Emacs]]
- [[https://www.gnu.org/software/emacs/manual/html_node/emacs/Windows-Keyboard.html][Keyboard Usage on MS-Windows]]
- [[http://www.wilfred.me.uk/blog/2018/01/06/the-emacs-guru-guide-to-key-bindings/][The Emacs Guru Guide to Key Bindings]]
- [[http://ergoemacs.org/emacs/emacs_hyper_super_keys.html][Emacs: How to Bind Super Hyper Keys]]

* Early initialization

Starting with *Emacs* 27, an early-init.el file can be used to do early configuration and optimization.
For more information read [[https://www.gnu.org/software/emacs/manual/html_node/elisp/Starting-Up.html#Starting-Up][Starting Up Emacs]] and [[https://www.gnu.org/software/emacs/manual/html_node/elisp/Init-File.html][The Init File]].

#+BEGIN_QUOTE
Emacs can now be configured using an early init file. The file is called early-init.el, in user-emacs-directory.
It is loaded very early in the startup process: before graphical elements such as the tool bar are initialized,
and before the package manager is initialized. The primary purpose is to allow customizing how the package
system is initialized given that initialization now happens before loading the regular init file (see below).

We recommend against putting any customizations in this file that don't need to be set up before initializing
installed add-on packages, because the early init file is read too early into the startup process, and some
important parts of the Emacs session, such as 'window-system' and other GUI features, are not yet set up,
which could make some customization fail to work.
#+END_QUOTE

*Psimacs* uses the =early-init.el= for three purposes. At first, the evaluation of this file tangles the =init.org= file's
embedded elips source code into the corresponding elips files. Especially, the =early-init.el= file is itself
updated on this way, as it is also described in the =init.org= file. Crazy isn't is :-). Secondly, the =early-init.el=
is responsible for synchronizing with a *Psimacs* /dropbox/ repository. This is quite useful when working with multiple
machines and sharing the very same *Emacs* environment. Thirdly, the primary duty of the =early-init.el= file is to
optimize the *Emacs* startup procedure.

As mentioned above, the elisp source of this section is tangled directly into the =early-init.el= file. Since the
tangling happens at startup time on evaluation of the =early-init.el= file, the =early-init.el= might overwritten
itself at startup.

** Preamble

#+BEGIN_SRC emacs-lisp :tangle early-init.el :var file-description="Early initialization"
;;; Commentary:
;;
;; Emacs 27 introduces early-init.el, which is run before init.el,
;; before package and UI initialization happens.
;;
#+END_SRC

** Some basic constants

*** Tangle anything at startup

*Psimacs* allows the tangling of the configuration source code at startup time. The following flag allows to suppresses
this feature completely.

#+BEGIN_SRC emacs-lisp :tangle early-init.el
;;
;; Tangling procedure constants.
;;
(defconst psimacs/config/tangle-anything t
  "If this flag is nil no code is generated by the startup.
This flag allows to only use the 'init-*.el' files of the framework.")
#+END_SRC

*** Tangle early-init.el at startup

*Psimacs* allows the tangling of the =early-init.el= file itself at startup. The following flag suppresses
this feature.

#+BEGIN_SRC emacs-lisp :tangle early-init.el
(defconst psimacs/config/tangle-early-init-file t
  "If this flag is t the 'early-init.el' file is generated at startup.
If nil, only the 'early-init.el' file is omitted from the code generation process.")
#+END_SRC

*** Synchronize with Dropbox at startup

*Psimacs* allows the synchronization of files and folders with a /Dropbox/ repository at startup time.
The following flag allows inhibition of this feature.

#+BEGIN_SRC emacs-lisp :tangle early-init.el
;;
;; Synchronization procedure constants.
;;
(defconst psimacs/config/synchronize-at-startup t
  "If this flag is t the 'early-init.el' file synchronizes the configuration with Dropbox.
The local configuration can be synchronized with a mirror configuration on Dropbox. This
allows sharing of a single configuration on multiple machines.")
#+END_SRC

*** Some size numbers

Huge byte sizes are conveniently written in /Mega Bytes/ or even in /Giga Bytes/ by *Psimacs*. Therefore we define
some size constants early.

#+BEGIN_SRC emacs-lisp :tangle early-init.el
;;
;; Conveniency byte size constants
;;
(defconst   1MB (* 1024 1024))
(defconst   4MB (*   4 1MB))
(defconst  20MB (*  20 1MB))
(defconst  30MB (*  30 1MB))
(defconst  50MB (*  50 1MB))
(defconst  64MB (*  64 1MB))
(defconst 128MB (* 128 1MB))
#+END_SRC

*** Primary initalization files and directories

The primary initialization files and directories must be known by the initialization process early in time in order
to allow the =early-init.el= to full fill its duty. These files are evaluated and/or synchronized with a possible
/dropbox/ repository.

#+BEGIN_SRC emacs-lisp :tangle early-init.el
;;
;; Primary Psimacs file and directory constants use for tangling and synchronization
;;
(defconst psimacs/config/main-org-file-name "init.org"
  "The psimacs initialization file.")

(defconst psimacs/config/main-html-file-name "init.html"
  "The psimacs htmlized initialization file.")

(defconst psimacs/config/icon-file-name "psi.ico"
  "The psimacs icon file.")

(defconst psimacs/config/license-file-name "LICENSE"
  "The psimacs license file.")

(defconst psimacs/config/custom-file-name "custom.el"
  "The psimacs custom elips file.")

(defconst psimacs/config/agenda-folder "agenda"
  "The psimacs agenda directory.")

(defconst psimacs/config/latex-folder "latex"
  "The psimacs latex directory.")

(defconst psimacs/config/assets-folder "assets"
  "The psimacs assets directory.")
 #+END_SRC

*** Copyright and author information

Copyright information that should be inserted into all tangled code.

#+BEGIN_SRC emacs-lisp :tangle early-init.el
(defconst psimacs/config/copyright/year       "2020-2021")
(defconst psimacs/config/copyright/author     "Johannes Brunen")
(defconst psimacs/config/copyright/pseudonyme "hatlafax")
(defconst psimacs/config/copyright/email      "hatlafax@gmx.de")
(defconst psimacs/config/copyright/url        "https://github.com/hatlafax/psimacs")
(defconst psimacs/config/copyright/license    "GNU GENERAL PUBLIC LICENSE")
(defconst psimacs/config/copyright/version    "Version 3, 29 June 2007")
 #+END_SRC

*** Garbage collection

Fine tuning the garbage collection after startup initialization.

#+BEGIN_SRC emacs-lisp :tangle early-init.el
;;
;; Psimacs default garbage collection parameters
;;
(defconst psimacs/config/gc-cons-threshold 64MB
  "The default value to use for 'gc-cons-threshold'.
If you experience freezing, decrease this. If you experience stuttering,
increase this.")

(defconst psimacs/config/gc-cons-percentage 0.1
  "This variable specifies the amount of consing before garbage collection occurs.
It is the fraction of the current heap size."
)
#+END_SRC

** Some early optimization settings

- Lexical Scope and binding

  [[https://www.gnu.org/software/emacs/manual/html_node/elisp/Lexical-Binding.html][Lexical Binding]] is condensed to the following quote:

#+BEGIN_QUOTE
  A lexically-bound variable has /lexical scope/, meaning that any reference to the variable must be located
  textually within the binding construct.
#+END_QUOTE

  Its usage is explained in the [[https://www.gnu.org/software/emacs/manual/html_node/elisp/Using-Lexical-Binding.html][Emacs manual]].

Use lexical-binding. [[https://nullprogram.com/blog/2016/12/22/][Why? Explanation]].

=lexical-binding: t= has significant advantages, both in performance and static analysis,
and so it should be used for all future Elisp code. The only reason it's not the default
is because it breaks some old (badly written) code.

#+BEGIN_SRC emacs-lisp :tangle early-init.el
;;
;; Use lexical binding instead of dynamic binding.
;;
(setq-default lexical-binding t)
#+END_SRC

-  Before *Emacs* 27, the init file was responsible for initializing the package manager by calling
  =package-initialize=. *Emacs* 27 changed the default behavior: It now calls =package-initialize= before loading the
  init file. Since we use the =straight= package manager in *Psimacs*, we inhibit the package manager initialization
  at all.

#+BEGIN_SRC emacs-lisp :tangle early-init.el
;;
;; Inhibit the package manager at all
;;
(setq package-enable-at-startup nil)
#+END_SRC

- Let's inhibit resizing the frame at early stage.

  [[https://www.gnu.org/software/emacs/manual/html_node/elisp/Implied-Frame-Resizing.html][Implied Frame Resizing]]:
#+BEGIN_QUOTE
  By default, Emacs tries to keep the number of lines and columns of a frame's text area unaltered when, for example,
  toggling its menu or tool bar, changing its default font or setting the width of any of its scroll bars. This means
  that in such case Emacs must ask the window manager to resize the frame's window in order to accommodate the size
  change.

  Occasionally, such implied frame resizing may be unwanted, for example, when a frame has been maximized or made
   full-screen (where it's turned off by default). In general, users can disable implied resizing with the following
  option:
#+END_QUOTE

#+BEGIN_SRC emacs-lisp :tangle early-init.el
;;
;; If this option is nil, changing a frame' font, menu bar, tool bar, internal borders,
;; fringes or scroll bars may resize its outer frame in order to keep the number of
;; columns or lines of its text area unaltered. If this option is t, no such resizing
;; is done.
;;
(setq frame-inhibit-implied-resize t)
#+END_SRC

- Never use the menu-bar, the tool-bar or the scroll-bar:

  It will be faster to disable them here before they've been initialized.

  *Psimacs* does disable these features by default because these items make Emacs really beautiful on every platform.

#+BEGIN_SRC emacs-lisp :tangle early-init.el
;;
;; Beautify Emacs
;;
(menu-bar-mode -1)
(tool-bar-mode -1)
(scroll-bar-mode -1)
(horizontal-scroll-bar-mode -1)
#+END_SRC

- Avoid flickering of the screen

  Set theme colors early. The colors are taken from the alect-colors found in the 'alect-themes.el'.
  If another theme is used on default, these settings should be adapted, accordingly.

#+BEGIN_SRC emacs-lisp :tangle early-init.el
;;
;; Change color to avoid screen flickering
;;
(when (display-graphic-p)
  (set-face-background 'default "#4f4f4f" nil)
  (set-face-foreground 'default "#f0dfaf" nil)
)
#+END_SRC

- Avoid garbage collection at startup

  For detail information read the [[https://www.gnu.org/software/emacs/manual/html_node/elisp/Garbage-Collection.html][Garbage Collection manual entry]].

  Later in the initialization process the garbage collection procedure is even more fine tuned.

#+BEGIN_SRC emacs-lisp :tangle early-init.el
;;
;; Garbage collection optimization
;;
(setq gc-cons-threshold  most-positive-fixnum
      ;; The value of this variable is the number of bytes of storage that must
      ;; be allocated for Lisp objects after one garbage collection in order to
      ;; trigger another garbage collection.

      gc-cons-percentage 0.6
      ;; The value of this variable specifies the amount of consing before a
      ;; garbage collection occurs, as a fraction of the current heap size.
)


;;
;; After initialization set the garbage collection threshold to a reasonable value.
;;
(add-hook 'add-init-hook
          `(lambda ()
            (setq gc-cons-threshold  psimacs/config/gc-cons-threshold
                  gc-cons-percentage psimacs/config/gc-cons-percentage)
            (garbage-collect)
                  ) t)
#+END_SRC


- Another small optimization concerns on =file-name-handler-alist=

  On every .el and .elc file loaded during start up, it has to runs those regexps against the filename;
  setting it to nil and after initialization finished put the value back make the initialization process quicker.

#+BEGIN_SRC emacs-lisp :tangle early-init.el
(defvar psimacs/config/file-name-handler-alist file-name-handler-alist)
(setq file-name-handler-alist nil)

;;
;; After initialization reset the file-name-handler-alist
;;
(add-hook 'emacs-startup-hook
          (lambda ()
            (setq file-name-handler-alist psimacs/config/file-name-handler-alist)
            (makunbound 'psimacs/config/file-name-handler-alist)
            ))
#+END_SRC

- Disable warnings generated when functions are redefined with defadvice

  Defines what to do with redefinitions during Advice de/activation.
  Redefinition occurs if a previously activated function that already has an
  original definition associated with it gets redefined and then de/activated.
  In such a case we can either accept the current definition as the new
  original definition, discard the current definition and replace it with the
  old original, or keep it and raise an error. The values `accept', `discard',
  `error' or `warn' govern what will be done. `warn' is just like `accept' but
  it additionally prints a warning message. All other values will be
  interpreted as `error'.

#+BEGIN_SRC emacs-lisp :tangle early-init.el
;;
;; Suppressing ad-handle-definition warnings
;;
(setq ad-redefinition-action 'accept)
#+END_SRC


- Debugging on error and message buffer limit

#+BEGIN_SRC emacs-lisp :tangle early-init.el
(setq debug-on-error  t                 ; That will open the debugger when the error is raised.
      message-log-max t                 ; Specifies how many lines to keep in the *Messages* buffer.
                                        ; The value t means there is no limit on how many lines to keep.
)
#+END_SRC

** Preamble for any /.el/ file

Any generated initialization file should start with the same preamble concerning author, license etc.

#+BEGIN_SRC emacs-lisp :tangle early-init.el
;;
;; Preamble support
;;
(defun psimacs/config/generate-preamble (file org-file description)
  "Generate a proper preamble string for the given file.
FILE        : el file that get generated
ORG-FILE    : org mode file that is prints
DESCRIPTION : short description text"
  (let (
        (preamble (concat (format ";;; %s ---%s-*- coding: utf-8 -*- lexical-binding: t -*-\n" (file-name-nondirectory file) description)
                                  ";;\n"
                          (format ";; Don't edit this file, edit %s instead ...\n" (file-name-nondirectory org-file))
                                  ";;\n"
                                  "\n"
                          (format ";; Copyright (C) %s %s (%s)\n"
                                  psimacs/config/copyright/year
                                  psimacs/config/copyright/author
                                  psimacs/config/copyright/pseudonyme)
                                  "\n"
                          (format ";; Author:  %s <%s>\n"
                                  psimacs/config/copyright/author
                                  psimacs/config/copyright/email)
                          (format ";; URL:     %s\n" psimacs/config/copyright/url)
                          (format ";; License: %s %s\n"
                                  psimacs/config/copyright/license
                                  psimacs/config/copyright/version)
                                  "\n"
                                  ";; This file is not part of GNU Emacs.\n"
                                  ";;\n"
                                  ";; This program is free software; you can redistribute it and/or\n"
                          (format ";; modify it under the terms of the %s\n"
                                  psimacs/config/copyright/license)
                          (format ";; %s published by the Free Software Foundation.\n" psimacs/config/copyright/version)
                                  ";;\n"
                                  ";; This program is distributed in the hope that it will be useful,\n"
                                  ";; but WITHOUT ANY WARRANTY; without even the implied warranty of\n"
                                  ";; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n"
                                  ";; General Public License for more details.\n"
                                  ";;\n"
                                  ";; You should have received a copy of the GNU General Public License\n"
                                  ";; along with this program; see the file LICENSE.  If not, write to\n"
                                  ";; the Free Software Foundation, Inc., 51 Franklin Street, Fifth\n"
                                  ";; Floor, Boston, MA 02110-1301, USA.\n"
                                  ";;\n"
                                  "\n")))
    preamble
  )
)
#+END_SRC

** Tangling support without org-bable

The code generation process is not performed with the [[http://orgmode.org/worg/org-contrib/babel/][Org Mode Babel]] functionality. That is because the startup
should be pretty fast and not rely on loading [[https://orgmode.org][org-mode]] only for this task. Additionally, the tangling function
does do some special stuff that is not supported by the  [[http://orgmode.org/worg/org-contrib/babel/][Org Mode Babel]] framework.

Sections and its subsections that are prefixed with =Canceled= or =Disabled= tokens get filtered out. The
same happens if a section is attributed by the tag =:noexport:=.

Sections that are tagged by =:noexport:= are not exported to html.

#+BEGIN_SRC emacs-lisp :tangle early-init.el
(defun psimacs/config/tangle-canceled-p (token)
    "Return t if token is matching the 'canceled' criteria."
    (when (or (string-prefix-p "CANCELED" token t)
              (string-prefix-p "DISABLED" token t)
              (string-match-p "^.*:NOEXPORT:.*$" (upcase token))
          )
        t
    )
)

(defun psimacs/config/tangle-section-canceled ()
  "Return t if the current section header is 'CANCELED' or 'DISABLED' ':noexport:', else nil.

Section headers starts with '*', '**', etc, e.g.:

'** CANCELED Some section header text'

This function searches the header tree up to the root. The current header is
regarded 'canceled' if he or any of its parent headers is regarded 'canceled'.
"
    ;;(save-excursion (if (re-search-backward "^\\*+\\s-+\\(.*?\\)?\\s-*$" nil t)
    ;;                   (or (string-prefix-p "CANCELED" (match-string 1) t)
    ;;                       (string-prefix-p "DISABLED" (match-string 1) t)
    ;;                       (string-match-p "^.*:NOEXPORT:.*$" (match-string 1))
    ;;                   ) nil))
    ;;(message "---------------------------------------------------------------------------------------------")
    (save-excursion
        (let ( (result nil) (loop t) (n 0) (i 0) )
            (while (and (not result) loop)
                (if (re-search-backward "^\\(\\*+\\)\\s-+\\(.*?\\)?\\s-*$" nil t)
                    (progn
                        ;;(message "%s" (match-string 0))
                        (setq i (length (match-string 1)))
                        (if (= n 0)
                            (progn
                                (setq n i)
                                (when (psimacs/config/tangle-canceled-p (match-string 2))
                                    (setq result t)
                                    (setq loop nil)
                                    ;;(message "=> early canceled -> result t %s" (match-string 0))
                                )
                            )
                            ;; else n > 0
                            (when (not result)
                                (if (< i n)
                                    (progn
                                        (when (psimacs/config/tangle-canceled-p (match-string 2))
                                            (setq result t)
                                            ;;(message "=> canceled!!! %s" (match-string 0))
                                        )

                                        (when (<= i 1)
                                            (setq loop nil)
                                            ;;(message "=> stopped!!! %s" (match-string 0))
                                        )

                                        (setq n i)
                                    )
                                  ;;(message "=> discarded i = %s, n = %s" i n)
                                )
                            )
                        )
                    )
                  (setq loop nil)
                )
            )
            ;;(message "=> final result %s" result)
            result
        )
    )
)
#+END_SRC

The main tangling function.

#+BEGIN_SRC emacs-lisp :tangle early-init.el
(defun psimacs/config/tangle-config-org (orgfile elfile)
  "This function will write all source blocks from 'file.org' into 'file.el' that are ...
        - not marked as :tangle no
        - have a source-code of =emacs-lisp=
        - doesn't have the todo-markers CANCELED or DISABLED
        - doesn't be tagged by :noexport:

Elisp source code blocks that are marked as ':tangle foo.el' are written to file 'foo.el' instead.
For these files extra header and footer are written. In this case, also an additional header argument
':var file-description \"text\" is evaluated and used in the file header.

Shortly, all tangled source code blocks for file foo.el are written to one file 'foo.el' that look like

;; foo.el --- text -*- coding: utf-8 -*- lexical-binding: t -*-
;;
;; Don't edit this file, edit file.org instead ...
;;
...
(provide 'foo)

Source code blocks that tangle to early-init.el are handled differently. In this case neither a
'require' statement in file.el nor the 'provide' clause is added to the file early-init.el.
"
  (let* ((body-list ())
         (src-block-regexp   (concat
                              ;; (1) indentation                 (2) lang
                              "^\\([ \t]*\\)#\\+begin_src[ \t]+\\([^ \f\t\n\r\v]+\\)[ \t]*"
                              ;; (3) switches
                              "\\([^\":\n]*\"[^\"\n*]*\"[^\":\n]*\\|[^\":\n]*\\)"
                              ;; (4) header arguments
                              "\\([^\n]*\\)\n"
                              ;; (5) body
                              "\\([^\000]*?\n\\)??[ \t]*#\\+end_src"))
         (found-files-alist ())
         (found-load-dir-alist ()))
    (with-temp-buffer (insert-file-contents orgfile)
                      (goto-char (point-min))
                      (while (re-search-forward src-block-regexp nil t)
                        (let ((lang (match-string 2))
                              (args (match-string 4))
                              (body (match-string 5))
                              (canc (psimacs/config/tangle-section-canceled)))
                          (when (and (string= lang "emacs-lisp")
                                     (not (string-match-p "^.*:tangle\\s-+no.*$" args))
                                     (not canc))
                            (when (string-match "^.*:tangle\\s-+\\([^:]+\\).*$" args)
                              (let ((dst (string-trim (match-string 1 args)))
                                    (dst-file)
                                    (dst-dir)
                                    (line)
                                    (package-name)
                                    (relative-dir))
                                (if (string= dst "yes")
                                    (progn
                                      (setq body (concat body "\n"))
                                      (add-to-list 'body-list body))
                                  ;; ...else a .el file is requested explicitly.
                                  (progn
                                    (setq dst-file (expand-file-name (concat user-emacs-directory dst)))
                                    (setq dst-dir  (file-name-directory dst-file))
                                    (setq package-name (file-name-sans-extension (file-name-nondirectory dst-file)))

                                    (when (or
                                           (not (equal package-name "early-init"))
                                           (and
                                            (equal package-name "early-init")
                                            psimacs/config/tangle-early-init-file))
                                      (unless (cdr (assoc dst-file found-files-alist))
                                        (when (file-exists-p dst-file)
                                          (delete-file dst-file))

                                        (unless (file-exists-p dst-dir)
                                          (make-directory dst-dir t))

                                        (setq relative-dir (file-relative-name (file-name-directory dst-dir)
                                                                               user-emacs-directory))

                                        (unless (or
                                                 (cdr (assoc dst-dir found-load-dir-alist))
                                                 (equal relative-dir "./"))
                                          (setq line (format
                                                      "(add-to-list 'load-path (concat user-emacs-directory \"%s\"))\n\n"
                                                      relative-dir))
                                          (add-to-list 'body-list line)
                                          (map-put found-load-dir-alist dst-dir t)
                                        )

                                        (let ((description " "))
                                          (when (string-match
                                                 "^.*:var\\s-+file-description\\s-*=\\s-*\"\\([^\"]+\\).*$"
                                                 args)
                                            (setq description (concat " " (string-trim (match-string 1
                                                                                                     args))
                                                                      " ")))

                                          (unless (equal package-name "early-init")
                                            (if (equal description " ")
                                                (setq line (format "(require '%s)\n\n" package-name))
                                              (progn
                                               (setq line (format "(require '%s)" package-name))
                                               (setq line (concat line (make-string (- 42 (length line)) ?\s) (format ";;%s\n\n" description)))
                                               ))
                                            (add-to-list 'body-list line))

                                          (with-temp-buffer (insert (psimacs/config/generate-preamble
                                                                     dst-file
                                                                     orgfile
                                                                     description))
                                                            (write-region (point-min)
                                                                          (point-max) dst-file t))
                                        )
                                        (map-put found-files-alist dst-file t)
                                      )
                                      (with-temp-buffer (insert body)
                                                        (insert "\n")
                                                        (write-region (point-min)
                                                                      (point-max) dst-file t)))))))))))

    ;;
    ;; Add the config pathes to Emacs load path list and add the final provide-clause to the
    ;; written emacs package files.
    ;;
    (dolist (element found-files-alist)
      (let* ((file (car element))
             (package-name (file-name-sans-extension (file-name-nondirectory file))))

        (unless (equal package-name "early-init")
          (with-temp-buffer (insert (format "(provide '%s)\n" package-name))
                            (write-region (point-min)
                                          (point-max) file t)))))
    (with-temp-file elfile
      (insert (psimacs/config/generate-preamble elfile orgfile " Initialization file "))
      (apply 'insert (reverse body-list))
      (insert "\n"))

    ;; Byte compiling the init file is not recommendet
    ;; https://www.gnu.org/software/emacs/manual/html_node/emacs/Init-File.html
    ;;(byte-compile-file elfile)
    ))
#+END_SRC


In case that the resulting configuration file is named =init.el= no explicit loading is necessary. Otherwise, we
must load the =.el= file.

#+BEGIN_SRC emacs-lisp :tangle early-init.el
;;
;; Next function extracts the elips code from the org-file and possibly loads the
;; resulting elips file.
;;
(defun psimacs/config/load-configuration-file (orgfile)
  "Load the given configuration file unless it equals to 'init.el' itself.

File 'init.el' is loaded automatically at startup. No extra loading is necessary.
This function is basically an efficient replacement of org-babel-load-file.
However, it performs some extra task on extraction of the elisp source code blocks.
This happens in the tangle-config-org function.
No byte compiling is performed for any elips file generated by the tangling procedure.
"
  (let* ((base-name (file-name-sans-extension orgfile))
         (elfile    (concat base-name ".el"))
         ;;(elcfile (concat base-name ".elc")) ;; Byte compiling the init file is not recommendet
         )
    (when (and psimacs/config/tangle-anything
               (or (not (file-exists-p elfile))
                   (file-newer-than-file-p orgfile elfile)))

      ;; Byte compiling the init file is not recommendet
      ;;(file-newer-than-file-p orgfile elcfile)
      ;;(file-newer-than-file-p elfile  elcfile)

      (psimacs/config/tangle-config-org orgfile elfile))
    (unless (equal (file-name-nondirectory elfile) "init.el")
      (load (file-name-sans-extension elfile)))))
#+END_SRC

** Directory synchronization system functions

Two useful functions that allow one or two way directory synchronizations.

#+BEGIN_SRC emacs-lisp :tangle early-init.el
(defun psimacs/file-system/copy-directory-files (src dst &optional only-newer-files)
  "Copy all files from SRC directory into DST directory recursively.
If optional argument ONLY-NEWER-FILES is non nil source files are copied only if their time stamp is
newer then the time stamp of the destination file."
  (if (file-exists-p src)
      (progn
        (unless (file-exists-p dst)
          (make-directory dst t))
        (dolist (f (directory-files-recursively src ".*" t))
          (if (file-directory-p f)
              (let ((f-relative (file-relative-name f src)))
                (when f-relative (let ((dst-dir (concat (file-name-as-directory dst) f-relative)))
                                   (unless (file-exists-p dst-dir)
                                     (make-directory dst-dir t)))))
            ;; ...else is file
            (let* ((src-dir (file-name-directory f))
                   (f-relative (file-relative-name src-dir src))
                   (dst-dir dst)
                   (dst-file))
              (when f-relative
                (setq dst-dir (concat (file-name-as-directory dst) f-relative)))
              (unless (file-exists-p dst-dir)
                (make-directory dst-dir t))
              (setq dst-file (concat (file-name-as-directory dst-dir)
                                     (file-name-nondirectory f)))

                                        ;(if (file-exists-p dst-file)
              (if only-newer-files (when (file-newer-than-file-p f dst-file)
                                     (copy-file f dst-file t t))
                ;; ...else always copy
                (copy-file f dst-file t t))
                                        ;)
              )))
        )
    (make-directory src t)))
#+END_SRC

Two way synchronization if possible with the following function.

#+BEGIN_SRC emacs-lisp :tangle early-init.el
(defun psimacs/file-system/synchronize-directories(src dst)
  "This function synchronizes two directories.
All files that are found in SRC and that are either not in DST or newer in SRC are copied to DST.
All files that are found in DST and that are either not in SRC or newer in DST are copied to SRC.

After this function is finished the two directories are identical.
 "
  (psimacs/file-system/copy-directory-files src dst t)
  (psimacs/file-system/copy-directory-files dst src t))
#+END_SRC

** Dropbox configuration sharing support

The following functionality allows the synchronization between the user *Psimacs* configuration and a shared
/Dropbox/ configuration repository. Basically, allowing multiple machines to share the same *Psimacs* setup.

The /Dropbox/ location is determined at run time.

#+BEGIN_SRC emacs-lisp :tangle early-init.el
;;
;; Sync with dropbox
;;   The main config file is taken from the dropbox folder but it is loaded from
;;   the local directory (see below). Therefore we copy the main config file from
;;   the dropbox emacs folder into the emacs home directory. If the main config
;;   file in the emacs home directory is newer than the file in the dropbox folder
;;   we update that one with the newer local one.
;;   The agenda files are worked on the dropbox directly, but a local copy is made
;;   for backup purpose.
;;
(defun psimacs/config/find-dropbox-folder ()
  "Get the current dropbox folder on the running machine. Otherwise nil"
  (interactive)
  (let* ((db-appdat-info-file      (concat (expand-file-name (file-name-as-directory (getenv
                                                                                      "APPDATA")))
                                           "Dropbox/info.json"))
         (db-localappdat-info-file (concat (expand-file-name (file-name-as-directory (getenv
                                                                                      "LOCALAPPDATA")))
                                           "Dropbox/info.json"))
         (db-user-home-info-file   "~/Dropbox/info.json")
         (json-path (cond ((eq system-type 'windows-nt)
                           (if (file-exists-p db-appdat-info-file) db-appdat-info-file (if
                                                                                           (file-exists-p
                                                                                            db-localappdat-info-file)
                                                                                           db-localappdat-info-file
                                                                                         (if
                                                                                             (file-exists-p
                                                                                              db-user-home-info-file)
                                                                                             db-user-home-info-file
                                                                                           nil))))
                          ((or
                            (eq system-type 'darwin)
                            (eq system-type 'gnu-linux))
                           (if (file-exists-p db-user-home-info-file) db-user-home-info-file
                             nil)))))
    (if (and json-path
             (file-exists-p json-path))
        (progn
          (require 'json)
          (cdr (assoc 'path (car (json-read-file json-path))))) nil)))
#+END_SRC

*Psimacs* is expected to reside in sub-directory =emacs/psimacs/emacs=. The author uses the same sub-directory
in its home directory and avoids the =.emcad.d= directory completely. Instead the use of environment variable
=XDG_CONFIG_HOME= allows to run various *Emacs* configuration simultaneously.

The following /Windows Batch-File/ is used for starting *Psimacs*:

#+BEGIN_SRC
@echo off

set XDG_CONFIG_HOME=c:\home\emacs\psimacs
C:\utils\Emacs\bin\runemacs.exe
#+END_SRC

The constant =psimacs/config/dropbox-dir= is the actual /Dropbox/ directory found on your machine. It is determined by
the function =psimacs/config/find-dropbox-folder= at initialization time. The constant
=psimacs/config/dropbox-emacs-dir= is a sub directory to =psimacs/config/dropbox-dir=. For a multiple configuration
setup it should be =emacs/psimacs/emacs=. In a traditional Emacs setup, it would be set to =.emacs.d=.
Other configurations then can exchange the /psimacs/ string to something other.

#+BEGIN_SRC emacs-lisp :tangle early-init.el
;;
;; Initialize the directory constants for dropbox...
;;
(defconst psimacs/config/dropbox-dir
  (let ( (f (psimacs/config/find-dropbox-folder)) )
    (if f (file-name-as-directory f) nil))
  "The psimacs dropbox directory or nil.")

;;
;; ... and the its emacs configuration directory
;;
(defconst psimacs/config/dropbox-emacs-dir
  (if psimacs/config/dropbox-dir (file-name-as-directory (concat psimacs/config/dropbox-dir
                                                                 "emacs/psimacs/emacs")) nil)
  "The psimacs dropbox emacs configuration directory or nil.")
#+END_SRC

The actual synchronization function. In its preamble it creates list of files and directories that should be
synchronized. These list might be adapted in the future as the configuration evolves.

#+BEGIN_SRC emacs-lisp :tangle early-init.el
;;
;; The synchronization function.
;;
(defun psimacs/config/sync-with-dropbox ()
  "Synchronize with dropbox directory if it exists.

The expected place in the dropbox directory is 'emacs/psimacs/emacs'.
"
  (if (and psimacs/config/dropbox-dir
           (file-directory-p psimacs/config/dropbox-dir))
      (let* ((db-dir psimacs/config/dropbox-emacs-dir)
             (sync-files-alist ())
             (sync-dirs-alist  ()))
        (add-to-list 'sync-files-alist (cons (concat user-emacs-directory
                                                     psimacs/config/main-org-file-name)
                                             (concat db-dir psimacs/config/main-org-file-name)))
        (add-to-list 'sync-files-alist (cons (concat user-emacs-directory
                                                     psimacs/config/main-html-file-name)
                                             (concat db-dir psimacs/config/main-html-file-name)))
        (add-to-list 'sync-files-alist (cons (concat user-emacs-directory psimacs/config/icon-file-name)
                                             (concat db-dir psimacs/config/icon-file-name)))
        (add-to-list 'sync-files-alist (cons (concat user-emacs-directory
                                                     psimacs/config/license-file-name)
                                             (concat db-dir psimacs/config/license-file-name)))
        (add-to-list 'sync-files-alist (cons (concat user-emacs-directory
                                                     psimacs/config/custom-file-name)
                                             (concat db-dir psimacs/config/custom-file-name)))
        (add-to-list 'sync-dirs-alist  (cons (file-name-as-directory (concat user-emacs-directory
                                                                             psimacs/config/agenda-folder))
                                             (file-name-as-directory (concat db-dir
                                                                             psimacs/config/agenda-folder))))
        (add-to-list 'sync-dirs-alist  (cons (file-name-as-directory (concat user-emacs-directory
                                                                             psimacs/config/latex-folder))
                                             (file-name-as-directory (concat db-dir
                                                                             psimacs/config/latex-folder))))
        (add-to-list 'sync-dirs-alist  (cons (file-name-as-directory (concat user-emacs-directory
                                                                             psimacs/config/assets-folder))
                                             (file-name-as-directory (concat db-dir
                                                                             psimacs/config/assets-folder))))

        ;;
        ;; Create missing dropbox emacs directory
        ;;
        (unless (file-directory-p db-dir)
          (make-directory db-dir t))
        (dolist (files sync-files-alist)
          (let ((file    (car files))
                (db-file (cdr files)))
            ;;
            ;; Try to copy the file from dropbox to emacs directory...
            ;;
            (if (file-exists-p db-file)
                (progn
                  ;;
                  ;; If the local file is newer, we update dropbox first
                  ;;
                  (when (file-newer-than-file-p file db-file)
                    (copy-file file db-file t t))
                  (when (or (not (file-exists-p file))
                            (file-newer-than-file-p db-file file))
                    (copy-file db-file file t t)))

              ;; ...else try to upload to dropbox
              (if (file-exists-p file)
                  (copy-file file db-file t t)))))
        (dolist (files sync-dirs-alist)
          (let ((directory    (car files))
                (db-directory (cdr files)))
            (psimacs/file-system/synchronize-directories db-directory directory))))))
#+END_SRC

** Execution of the Dropbox synchronization

This starts the synchronization between the user *Psimacs* configuration and the Dropbox configuration repository.

#+BEGIN_SRC emacs-lisp :tangle early-init.el
;;
;; Synchronize with dropbox
;;
(when psimacs/config/synchronize-at-startup
  (psimacs/config/sync-with-dropbox))
#+END_SRC

** Tangling the main /init.org/ file.

This starts the processing of this org file (=init.org=), resulting in tbe final configuration files for *Psimacs*.

#+BEGIN_SRC emacs-lisp :tangle early-init.el
;;
;; Extract elisp code from org files if necessary and load that code into
;; emacs.
;;
(psimacs/config/load-configuration-file (expand-file-name (concat user-emacs-directory
                                                                  psimacs/config/main-org-file-name)))
#+END_SRC

* Preamble to the /init.el/ file

Until this point, all *Psimacs* source code tangled to the =early-inti.el= file. From now on, the actual configuration
file is setup. It starts with a commentary preamble written to the primary =init.el= file.

#+BEGIN_SRC emacs-lisp :tangle yes
;;; Commentary:
;;
;; Emacs 27 introduces early-init.el, which is run before init.el,
;; before package and UI initialization happens.
;;
#+END_SRC

*Psimacs* splits the configuration into various =init-*.el=-files. This will allow better looking up specific
settings or perform some experimentation. Each of these configuration files will be properly documented and it
is possible to completely relinquish the tangling process and work with the =init-*.el = initialization files
alone.

The main configuration starts now. It is sectioned into different topics. Each topic starts with a prime section
of its own.

* System helpers

This has to be provided early in the initialization process so that it is available for the subsequent code.

** Startup frame size and position

Early up we set the *Psimacs* frame's size and position in order to avoid distracting frame repositioning and resizing.
*Psimacs* provides three simple strategies for positioning and sizing new frames. These strategies can be activated
by the following function which are actually defined in section [[Frame size and position][Frame size and position]].

| Key binding       | Command                                                 | Description                                                                               |
|-------------------+---------------------------------------------------------+-------------------------------------------------------------------------------------------|
| =H-m C-w C-x 5 l= | =M-x psimacs/window/set-frame-creation-strategy-layout= | Place and size new frames left and right to the main frame. This is the default strategy. |
| =H-m C-w C-x 5 m= | =M-x psimacs/window/set-frame-creation-strategy-main=   | Always use the same placement and size as the initial main frame.                         |
| =H-m C-w C-x 5 s= | =M-x psimacs/window/set-frame-creation-strategy-system= | Let Emacs and the operating system decide.                                                |
|-------------------+---------------------------------------------------------+-------------------------------------------------------------------------------------------|

If you do not like the =layout= preset, change variable =psimacs/config/default-frame-creation-strategy= according
to it's documentation string.

#+BEGIN_SRC emacs-lisp :tangle config/init-config-helper.el :var file-description="Configuration helper"
;;
;; Define initial Emacs frame size and position...
;;
(setq frame-resize-pixelwise t)

(let* ((primary-monitor (car (display-monitor-attributes-list)))
       (geometry        (assoc 'geometry primary-monitor))
       (width           (nth 3 geometry))
       (height          (nth 4 geometry)))

  (defconst psimacs/config/default-frame-offset 20)

  (defconst psimacs/config/initial-frame-pos-x  (round (* 28 (/ width 100))))
  (defconst psimacs/config/initial-frame-pos-y  0)
  (defconst psimacs/config/initial-frame-size-x (round (* 60 (/ width 100))))
  (defconst psimacs/config/initial-frame-size-y (- height 80))

  (defconst psimacs/config/default-frame-1-pos-x  0)
  (defconst psimacs/config/default-frame-1-pos-y  psimacs/config/initial-frame-pos-y)
  (defconst psimacs/config/default-frame-1-size-x (- psimacs/config/initial-frame-pos-x  (+ psimacs/config/default-frame-1-pos-x psimacs/config/default-frame-offset)))
  (defconst psimacs/config/default-frame-1-size-y (round (/ psimacs/config/initial-frame-size-y 2)))

  (defconst psimacs/config/default-frame-2-pos-x  0)
  (defconst psimacs/config/default-frame-2-pos-y  (+ psimacs/config/default-frame-1-size-y psimacs/config/initial-frame-pos-y (round (* psimacs/config/default-frame-offset 1.75))))
  (defconst psimacs/config/default-frame-2-size-x (- psimacs/config/initial-frame-pos-x  (+ psimacs/config/default-frame-2-pos-x psimacs/config/default-frame-offset)))
  (defconst psimacs/config/default-frame-2-size-y (- psimacs/config/initial-frame-size-y psimacs/config/default-frame-2-pos-y))


  (defconst psimacs/config/default-frame-3-pos-x  (+ psimacs/config/initial-frame-pos-x psimacs/config/initial-frame-size-x psimacs/config/default-frame-offset))
  (defconst psimacs/config/default-frame-3-pos-y  psimacs/config/initial-frame-pos-y)
  (defconst psimacs/config/default-frame-3-size-x (- width (+ psimacs/config/default-frame-3-pos-x (round (* psimacs/config/default-frame-offset 1.5)))))
  (defconst psimacs/config/default-frame-3-size-y (round (/ psimacs/config/initial-frame-size-y 2)))

  (defconst psimacs/config/default-frame-4-pos-x  (+ psimacs/config/initial-frame-pos-x psimacs/config/initial-frame-size-x psimacs/config/default-frame-offset))
  (defconst psimacs/config/default-frame-4-pos-y  (+ psimacs/config/default-frame-1-size-y psimacs/config/initial-frame-pos-y (round (* psimacs/config/default-frame-offset 1.75))))
  (defconst psimacs/config/default-frame-4-size-x (- width (+ psimacs/config/default-frame-4-pos-x (round (* psimacs/config/default-frame-offset 1.5)))))
  (defconst psimacs/config/default-frame-4-size-y (- psimacs/config/initial-frame-size-y psimacs/config/default-frame-2-pos-y))

  (defvar psimacs/config/default-frame-placement-counter 1)

  ;;
  ;; The initial frame
  ;;
  (set-frame-position (selected-frame) psimacs/config/initial-frame-pos-x  psimacs/config/initial-frame-pos-y)
  (set-frame-size     (selected-frame) psimacs/config/initial-frame-size-x psimacs/config/initial-frame-size-y t)

  ;;
  ;; Somewhat redundant
  ;;
  (add-to-list 'initial-frame-alist `(left   . ,psimacs/config/initial-frame-pos-x))
  (add-to-list 'initial-frame-alist `(top    . ,psimacs/config/initial-frame-pos-y))
  (add-to-list 'initial-frame-alist `(width  . (text-pixels . ,psimacs/config/initial-frame-size-x)))
  (add-to-list 'initial-frame-alist `(height . (text-pixels . ,psimacs/config/initial-frame-size-y)))

  ;;
  ;; Track the current frame creation strategy
  ;;
  (defvar psimacs/config/default-frame-creation-strategy "layout"
    "The strategy that is used for placing and sizing new frames.

Supported strategies are:
  'layout'      -> new frames surround the main frame
  'main'        -> new frames get always the same size and position of the main frame
  'system'      -> let emacs decide")

  ;;
  ;; Prepare for the choosen frame creation strategy
  ;;
  (defun psimacs/window/set-frame-creation-strategy ()
    "Apply the current frame creation strategy."
    (cond ((string= psimacs/config/default-frame-creation-strategy "layout")
           (psimacs/window/set-frame-creation-strategy-layout))
          ((string= psimacs/config/default-frame-creation-strategy "main")
           (psimacs/window/set-frame-creation-strategy-main))
          ((string= psimacs/config/default-frame-creation-strategy "system")
           (psimacs/window/set-frame-creation-strategy-system)))
    )

  (defun psimacs/window/set-frame-creation-strategy-layout ()
    "Set the frame layout creation strategy to 'layout'."
    (interactive)
    (setq default-frame-alist (assq-delete-all 'left   default-frame-alist))
    (setq default-frame-alist (assq-delete-all 'top    default-frame-alist))
    (setq default-frame-alist (assq-delete-all 'width  default-frame-alist))
    (setq default-frame-alist (assq-delete-all 'height default-frame-alist))

    (when (= psimacs/config/default-frame-placement-counter 1)
      (add-to-list 'default-frame-alist `(left   . ,psimacs/config/default-frame-1-pos-x))
      (add-to-list 'default-frame-alist `(top    . ,psimacs/config/default-frame-1-pos-y))
      (add-to-list 'default-frame-alist `(width  . (text-pixels . ,psimacs/config/default-frame-1-size-x)))
      (add-to-list 'default-frame-alist `(height . (text-pixels . ,psimacs/config/default-frame-1-size-y)))
      )

    (when (= psimacs/config/default-frame-placement-counter 2)
      (add-to-list 'default-frame-alist `(left   . ,psimacs/config/default-frame-2-pos-x))
      (add-to-list 'default-frame-alist `(top    . ,psimacs/config/default-frame-2-pos-y))
      (add-to-list 'default-frame-alist `(width  . (text-pixels . ,psimacs/config/default-frame-2-size-x)))
      (add-to-list 'default-frame-alist `(height . (text-pixels . ,psimacs/config/default-frame-2-size-y)))
      )

    (when (= psimacs/config/default-frame-placement-counter 3)
      (add-to-list 'default-frame-alist `(left   . ,psimacs/config/default-frame-3-pos-x))
      (add-to-list 'default-frame-alist `(top    . ,psimacs/config/default-frame-3-pos-y))
      (add-to-list 'default-frame-alist `(width  . (text-pixels . ,psimacs/config/default-frame-3-size-x)))
      (add-to-list 'default-frame-alist `(height . (text-pixels . ,psimacs/config/default-frame-3-size-y)))
      )

    (when (= psimacs/config/default-frame-placement-counter 4)
      (add-to-list 'default-frame-alist `(left   . ,psimacs/config/default-frame-4-pos-x))
      (add-to-list 'default-frame-alist `(top    . ,psimacs/config/default-frame-4-pos-y))
      (add-to-list 'default-frame-alist `(width  . (text-pixels . ,psimacs/config/default-frame-4-size-x)))
      (add-to-list 'default-frame-alist `(height . (text-pixels . ,psimacs/config/default-frame-4-size-y)))
      )
    (setq psimacs/config/default-frame-creation-strategy "layout")
    (message "Switched to frame layout creation strategy."))

  (defun psimacs/window/set-frame-creation-strategy-main ()
    "Set the frame layout creation strategy to 'main'."
    (interactive)
    (setq default-frame-alist (assq-delete-all 'left   default-frame-alist))
    (setq default-frame-alist (assq-delete-all 'top    default-frame-alist))
    (setq default-frame-alist (assq-delete-all 'width  default-frame-alist))
    (setq default-frame-alist (assq-delete-all 'height default-frame-alist))
    (add-to-list 'default-frame-alist `(left   . ,psimacs/config/initial-frame-pos-x))
    (add-to-list 'default-frame-alist `(top    . ,psimacs/config/initial-frame-pos-y))
    (add-to-list 'default-frame-alist `(width  . (text-pixels . ,psimacs/config/initial-frame-size-x)))
    (add-to-list 'default-frame-alist `(height . (text-pixels . ,psimacs/config/initial-frame-size-y)))
    (setq psimacs/config/default-frame-creation-strategy "main")
    (message "Switched to main frame creation strategy."))

  (defun psimacs/window/set-frame-creation-strategy-system ()
    "Set the frame layout creation strategy to 'system'."
    (interactive)
    (setq default-frame-alist (assq-delete-all 'left   default-frame-alist))
    (setq default-frame-alist (assq-delete-all 'top    default-frame-alist))
    (setq default-frame-alist (assq-delete-all 'width  default-frame-alist))
    (setq default-frame-alist (assq-delete-all 'height default-frame-alist))
    (setq psimacs/config/default-frame-creation-strategy "system")
    (message "Switched to system frame creation strategy."))

  ;;
  ;; Initialize the frame creation strategy
  ;;
  (psimacs/window/set-frame-creation-strategy-layout)

  ;;
  ;; Prepare for the next frame creation
  ;;
  (add-hook 'after-make-frame-functions
            #'(lambda (frame)
                (when (equal psimacs/config/default-frame-creation-strategy "layout")
                  (setq default-frame-alist (assq-delete-all 'left   default-frame-alist))
                  (setq default-frame-alist (assq-delete-all 'top    default-frame-alist))
                  (setq default-frame-alist (assq-delete-all 'width  default-frame-alist))
                  (setq default-frame-alist (assq-delete-all 'height default-frame-alist))

                  (setq psimacs/config/default-frame-placement-counter (+ psimacs/config/default-frame-placement-counter 1))

                  (when (> psimacs/config/default-frame-placement-counter 4)
                    (setq psimacs/config/default-frame-placement-counter 1)
                    )

                  (when (= psimacs/config/default-frame-placement-counter 1)
                    (add-to-list 'default-frame-alist `(left   . ,psimacs/config/default-frame-1-pos-x))
                    (add-to-list 'default-frame-alist `(top    . ,psimacs/config/default-frame-1-pos-y))
                    (add-to-list 'default-frame-alist `(width  . (text-pixels . ,psimacs/config/default-frame-1-size-x)))
                    (add-to-list 'default-frame-alist `(height . (text-pixels . ,psimacs/config/default-frame-1-size-y)))
                    )

                  (when (= psimacs/config/default-frame-placement-counter 2)
                    (add-to-list 'default-frame-alist `(left   . ,psimacs/config/default-frame-2-pos-x))
                    (add-to-list 'default-frame-alist `(top    . ,psimacs/config/default-frame-2-pos-y))
                    (add-to-list 'default-frame-alist `(width  . (text-pixels . ,psimacs/config/default-frame-2-size-x)))
                    (add-to-list 'default-frame-alist `(height . (text-pixels . ,psimacs/config/default-frame-2-size-y)))
                    )

                  (when (= psimacs/config/default-frame-placement-counter 3)
                    (add-to-list 'default-frame-alist `(left   . ,psimacs/config/default-frame-3-pos-x))
                    (add-to-list 'default-frame-alist `(top    . ,psimacs/config/default-frame-3-pos-y))
                    (add-to-list 'default-frame-alist `(width  . (text-pixels . ,psimacs/config/default-frame-3-size-x)))
                    (add-to-list 'default-frame-alist `(height . (text-pixels . ,psimacs/config/default-frame-3-size-y)))
                    )

                  (when (= psimacs/config/default-frame-placement-counter 4)
                    (add-to-list 'default-frame-alist `(left   . ,psimacs/config/default-frame-4-pos-x))
                    (add-to-list 'default-frame-alist `(top    . ,psimacs/config/default-frame-4-pos-y))
                    (add-to-list 'default-frame-alist `(width  . (text-pixels . ,psimacs/config/default-frame-4-size-x)))
                    (add-to-list 'default-frame-alist `(height . (text-pixels . ,psimacs/config/default-frame-4-size-y)))
                    )
                  )
                )
  )

  (add-hook 'after-delete-frame-functions
            #'(lambda (frame)
                (when (equal psimacs/config/default-frame-creation-strategy "layout")
                  (setq default-frame-alist (assq-delete-all 'left   default-frame-alist))
                  (setq default-frame-alist (assq-delete-all 'top    default-frame-alist))
                  (setq default-frame-alist (assq-delete-all 'width  default-frame-alist))
                  (setq default-frame-alist (assq-delete-all 'height default-frame-alist))

                  (setq psimacs/config/default-frame-placement-counter (- psimacs/config/default-frame-placement-counter 1))

                  (when (< psimacs/config/default-frame-placement-counter 1)
                    (setq psimacs/config/default-frame-placement-counter 1)
                    )

                  (when (= psimacs/config/default-frame-placement-counter 1)
                    (add-to-list 'default-frame-alist `(left   . ,psimacs/config/default-frame-1-pos-x))
                    (add-to-list 'default-frame-alist `(top    . ,psimacs/config/default-frame-1-pos-y))
                    (add-to-list 'default-frame-alist `(width  . (text-pixels . ,psimacs/config/default-frame-1-size-x)))
                    (add-to-list 'default-frame-alist `(height . (text-pixels . ,psimacs/config/default-frame-1-size-y)))
                    )

                  (when (= psimacs/config/default-frame-placement-counter 2)
                    (add-to-list 'default-frame-alist `(left   . ,psimacs/config/default-frame-2-pos-x))
                    (add-to-list 'default-frame-alist `(top    . ,psimacs/config/default-frame-2-pos-y))
                    (add-to-list 'default-frame-alist `(width  . (text-pixels . ,psimacs/config/default-frame-2-size-x)))
                    (add-to-list 'default-frame-alist `(height . (text-pixels . ,psimacs/config/default-frame-2-size-y)))
                    )

                  (when (= psimacs/config/default-frame-placement-counter 3)
                    (add-to-list 'default-frame-alist `(left   . ,psimacs/config/default-frame-3-pos-x))
                    (add-to-list 'default-frame-alist `(top    . ,psimacs/config/default-frame-3-pos-y))
                    (add-to-list 'default-frame-alist `(width  . (text-pixels . ,psimacs/config/default-frame-3-size-x)))
                    (add-to-list 'default-frame-alist `(height . (text-pixels . ,psimacs/config/default-frame-3-size-y)))
                    )

                  (when (= psimacs/config/default-frame-placement-counter 4)
                    (add-to-list 'default-frame-alist `(left   . ,psimacs/config/default-frame-4-pos-x))
                    (add-to-list 'default-frame-alist `(top    . ,psimacs/config/default-frame-4-pos-y))
                    (add-to-list 'default-frame-alist `(width  . (text-pixels . ,psimacs/config/default-frame-4-size-x)))
                    (add-to-list 'default-frame-alist `(height . (text-pixels . ,psimacs/config/default-frame-4-size-y)))
                    )
                  )
                )
  )

)
#+END_SRC

** System constants flags

The following boolean constants are defined for convenience.

#+BEGIN_SRC emacs-lisp :tangle config/init-config-helper.el
;;
;; System constants for convenience
;;
(defconst psimacs/system/is-gui-flag        (display-graphic-p)          "Are we running on a GUI Emacs?")
(defconst psimacs/system/is-windows-nt-flag (eq system-type 'windows-nt) "Are we running on a Windows OS system?")
(defconst psimacs/system/is-gnu-linux-flag  (eq system-type 'gnu/linux)  "Are we running on a GNU/Linux system?")
(defconst psimacs/system/is-darwin-flag     (eq system-type 'darwin)     "Are we running on a MAC system?")
#+END_SRC

** Helper functions for assembling folders and files

Some functions to ease the code.

#+BEGIN_SRC emacs-lisp :tangle config/init-config-helper.el
;;
;; Helper functions for file and directory handling
;;
(defun psimacs/file-system/concat-directory (dir subdir)
  "Assemble directory and subdirectory to a new directory."
  (expand-file-name (file-name-as-directory (concat (file-name-as-directory dir) subdir)))
)

(defun psimacs/file-system/concat-file (dir file)
  "Assemble directory and file."
  (expand-file-name (concat (file-name-as-directory dir) file))
)

(defun psimacs/file-system/prefer-dropbox-directory (dir)
  "Evaluates either to the local or to the dropbox pendant directory.
This functions always prefers DIR on dropbox."
  (let ((local-dir (psimacs/file-system/concat-directory user-emacs-directory dir))
        (dropbox-dir (if psimacs/config/synchronize-at-startup
                         psimacs/config/dropbox-emacs-dir
                       nil))
        )
    (if dropbox-dir
        (psimacs/file-system/concat-directory dropbox-dir dir)
      local-dir)))
#+END_SRC

** Helper functions for message printing

Some convenience function for message printing.

#+BEGIN_SRC emacs-lisp :tangle config/init-config-helper.el
;;
;; Easy message function for lists
;;
(defun psimacs/config/message-elements-of-list (list)
  "Print each element of LIST to the message buffer on a line of its own."
  (while list
    (message (car list))
    (setq list (cdr list))))
#+END_SRC

* Configuration constants

In the following various *Psimacs* configuration constants are defined. They are just defined at a central place, but
used only later in the configuration. This section is rather boring. However, I decided to concentrate
all these settings together so that it is easy to lookup or change them.

** Primary directory

This defines the =site-lisp= directory for storing local elisp code and the dependencies directory where non *Emacs*
programs are installed.

#+BEGIN_SRC emacs-lisp :tangle config/init-constants.el :var file-description="Configuration constants"
;;
;; Directory constants used by Psimacs
;;
(defconst psimacs/config/site-lisp-dir
  (psimacs/file-system/concat-directory user-emacs-directory "site-lisp")
  "The psimacs personal site-lisp directory.")

(defconst psimacs/config/session-dir
  (psimacs/file-system/concat-directory user-emacs-directory "session")
  "The psimacs session directory used for storing various session information.")

(defconst psimacs/config/assets-dir
  (psimacs/file-system/concat-directory user-emacs-directory psimacs/config/assets-folder)
  "The psimacs assets directory.")

#+END_SRC

** Private directory

*Psimacs* uses some optional private information that should not go public. These data are stored in
the following directory.

#+BEGIN_SRC emacs-lisp :tangle config/init-constants.el
;;
;; Private directory and file might exists; not mandatory.
;;
(defconst psimacs/config/private-dir
  (psimacs/file-system/concat-directory user-emacs-directory "private")
  "A directory that contains non public, i.e.  private data."
)

(defconst psimacs/config/private-file
  (psimacs/file-system/concat-file psimacs/config/private-dir "init-private.el")
  "A directory that contains non public, i.e.  private data."
)
#+END_SRC

** Tools directory

The tools directory contains non *Emacs* / *Lisp* tools, that are not readily available, but are important for
*Psimacs* configuration. For instance =msys64= is needed by *Psimacs* but an appropriate installation can be provided
by resources from the web. Therefore =msys64= is not found in tools. Goal is it that the =psimacs/config/tools-dir=
is empty.

#+BEGIN_SRC emacs-lisp :tangle config/init-constants.el
;;
;; Installation of 'personal' tools
;;
(defconst psimacs/config/tools-dir
  (psimacs/file-system/concat-directory psimacs/config/site-lisp-dir "tools")
  "The psimac personal tools directory.")
#+END_SRC

** System resources directory

Many dependencies exists to external programs that are used by *Psimacs*. On default most of them are expected
to be installed in the =psimacs/config/system-utils-dir=. For each tool that *Psimacs* expects a detailed installation
recipe is provided.

#+BEGIN_SRC emacs-lisp :tangle config/init-constants.el
;;
;; Installation of system wide utilities and resources
;;
(defconst psimacs/config/system-utils-dir
  (expand-file-name (file-name-as-directory "c:/utils"))
  "The psimac system resources and utility directory.")
#+END_SRC

** Backup constants

*Psimacs* supports the creation of backup files.

#+BEGIN_SRC emacs-lisp :tangle config/init-constants.el
;;
;; Constants used by Psimacs for backups
;;
(defconst psimacs/config/backup-root-dir
  (psimacs/file-system/concat-directory psimacs/config/session-dir "backups")
  "The psimacs backup root directory.")

(defconst psimacs/config/backup-dir
  (psimacs/file-system/concat-directory psimacs/config/backup-root-dir "computer")
  "The psimacs backup directory.")

(defconst psimacs/config/backup-max-number-files 36
  "The psimacs maximal number of tracked backup files.")
#+END_SRC

** Auto saving

Auto saving is performed by *Psimacs* a lot.

#+BEGIN_SRC emacs-lisp :tangle config/init-constants.el
;;
;; Constants used by Psimacs for auto saving
;;
(defconst psimacs/config/auto-save-dir
  (psimacs/file-system/concat-directory psimacs/config/session-dir "auto-save")
  "The psimacs auto save directory.")
#+END_SRC

** Bookmarking

*Psimacs* uses the [[https://github.com/joodland/bm][Visible bookmarks in buffer (bm)]] for bookmarking.

#+BEGIN_SRC emacs-lisp :tangle config/init-constants.el
;;
;; Constants used by Psimacs for bookmarking
;;
(defconst psimacs/config/bookmarks-dir
  (psimacs/file-system/concat-directory psimacs/config/session-dir "bm")
  "The psimacs bookmarks directory.")

(defconst psimacs/config/bm-bookmarks-file
  (psimacs/file-system/concat-file psimacs/config/bookmarks-dir ".bm-bookmarks")
  "The psimacs bm bookmarks file.")
#+END_SRC

** Abbreviations

*Psimacs uses the default *Emacs* [[https://www.gnu.org/software/emacs/manual/html_node/emacs/Abbrevs.html][abbreviation]] facility.

#+BEGIN_SRC emacs-lisp :tangle config/init-constants.el
;;
;; Constants used by Psimacs for abbreviations
;;
(defconst psimacs/config/abbrev-file
  (psimacs/file-system/concat-file psimacs/config/session-dir ".abbreviations")
  "The psimacs abbreviation file.")
#+END_SRC

** Emacs client/server

[[https://www.gnu.org/software/emacs/manual/html_node/emacs/Emacs-Server.html][Client/Server]] support for *Psimacs*. We use the default /server/ directory. Since we allow multiple
*Emacs* configurations side by side, we must either set the global environment variable =EMACS_SERVER_FILE=
to the correct server file, or we must call *emacsclient* with option =-f server-file=.

*Psimacs* handles that in the following way:
- *Psimacs* uses the =EMACS_SERVER_FILE=
- If at startup a =EMACS_SERVER_FILE= if already defined in the environment and it does not correspond to
  the current configuration, =EMACS_SERVER_FILE= is not modified and the //*Emacs server*/ is not started.
- If the =EMACS_SERVER_FILE= is not defined, or it points to a non existing file, it is set to the
  current configuration's /server-file/ in the user environment.
  Additionally, a =kill-emacs-hook= is set up that removes the environment variable on exit of the *Emacs* session.

References:
- [[https://www.gnu.org/software/emacs/manual/html_node/emacs/Emacs-Server.html][Using Emacs as a Server]]
- [[https://www.gnu.org/software/emacs/manual/html_node/emacs/TCP-Emacs-server.html#TCP-Emacs-server][TCP Emacs server]]
- [[https://www.gnu.org/software/emacs/manual/html_node/emacs/emacsclient-Options.html][*emacsclient* Options]]

#+BEGIN_SRC emacs-lisp :tangle config/init-constants.el
;;
;; Constants used by Psimacs for client/server storage
;;
(defconst psimacs/config/server-dir
  (psimacs/file-system/concat-directory user-emacs-directory "server")
  "The psimacs server directory.")

(defconst psimacs/config/server-file
  (psimacs/file-system/concat-file psimacs/config/server-dir "server")
  "The psimacs server file.")


;;
;; ToDo: this should go to the server setup code below
;;
(defvar psimacs/config/found-server-file
   (getenv "EMACS_SERVER_FILE")
   "The active server file.")

(when (and psimacs/system/is-windows-nt-flag
            (or (not psimacs/config/found-server-file)
                (not (file-exists-p psimacs/config/found-server-file))
                (equal psimacs/config/found-server-file psimacs/config/server-file)))
   (start-process "SETX" nil "setx" "EMACS_SERVER_FILE" psimacs/config/server-file)
   (add-hook 'kill-emacs-hook
             (lambda ()
               (call-process "reg.exe" nil nil nil "delete" "HKCU\\Environment" "/v" "EMACS_SERVER_FILE" "/f"))))
#+END_SRC

** Agenda files

Quoting [[http://cachestocaches.com/2016/9/my-workflow-org-agenda/][My Workflow with Org-Agenda]]:
#+BEGIN_QUOTE
The agenda view scans your =.org= files (set by customizing the org-agenda-files variable) and collects all of the
headings with a TODO (or related) keyword. Without the agenda view, keeping track of projects, which I ensure are
top-level TODO items, is difficult. The agenda provides a convenient way of tracking your projects and managing
your calendar.
#+END_QUOTE


#+BEGIN_SRC emacs-lisp :tangle config/init-constants.el
;;
;; Org-Agenda directory
;;
(defconst psimacs/config/agenda-dir
    (psimacs/file-system/prefer-dropbox-directory psimacs/config/agenda-folder)
    "The psimacs org agenda  directory.")

;;
;; Diary files
;;
(defcustom psimacs/config/org-capture-coding-diary-file "CodingDiary.org"
    "The diary file for capturing coding points.")

(defcustom psimacs/config/org-capture-coding-diary-files
    '(
        "CodingDiary.org"
        "ShadowProject.org"
    )
    "The list of supported diary files for capturing coding points.")
#+END_SRC

** Recent files

Constants that relate to recent file management.

#+BEGIN_SRC emacs-lisp :tangle config/init-constants.el
;;
;; Recent file constants
;;
(defconst psimacs/config/recent-file
    (psimacs/file-system/concat-file psimacs/config/session-dir ".recentf")
    "The psimacs recent file.")
#+END_SRC

** History

Configuration constants for saving the history.

#+BEGIN_SRC emacs-lisp :tangle config/init-constants.el
;;
;; Save history management
;;
(defconst psimacs/config/history-file
    (psimacs/file-system/concat-file psimacs/config/session-dir ".history")
    "The psimacs history file.")
#+END_SRC

** Save-Places
Save place allows store the current cursor position for the next session.

#+BEGIN_SRC emacs-lisp :tangle config/init-constants.el
;;
;; Save cursor positions for the next session
;;
(defconst psimacs/config/save-places-file
    (psimacs/file-system/concat-file psimacs/config/session-dir ".save-places")
    "The psimacs save places file.")
#+END_SRC

** The custom.el file.

The =custom.el= file contains customizations by the user. This file is not synchronized with the /Dropbox/
repository.

#+BEGIN_SRC emacs-lisp :tangle config/init-constants.el
;;
;; The custom.el file. This file gets not be synchronized
;;
(defconst psimacs/config/custom-file
    (psimacs/file-system/concat-file user-emacs-directory psimacs/config/custom-file-name)
    "The psimacs customization file.")
#+END_SRC

** Latex

LaTeX bibliography should be shared.

#+BEGIN_SRC emacs-lisp :tangle config/init-constants.el
;;
;; LaTeX file sharing
;;
(defconst psimacs/config/latex-dir
  (psimacs/file-system/prefer-dropbox-directory psimacs/config/latex-folder)
  "The psimacs shared latex directory.")

(defconst psimacs/config/tex-runtime-dir
  (psimacs/file-system/concat-directory psimacs/config/system-utils-dir "MiKTeX/miktex/bin/x64")
  ;;(psimacs/file-system/concat-directory psimacs/config/system-utils-dir "texlive/bin/win32")
  "The psimacs tex runtime directory.")

#+END_SRC

** The Amx file

[[https://github.com/DarwinAwardWinner/amx][Amx]] is an alternative interface for M-x in Emacs.

#+BEGIN_SRC emacs-lisp :tangle config/init-constants.el
;;
;; Amx package support file
;;
(defconst psimacs/config/amx-file
  (psimacs/file-system/concat-file psimacs/config/session-dir ".amxf")
  "The psimacs amx file.")
#+END_SRC

** MSYS2

*Psimacs* uses a lot of external programs provided by the [[https://www.msys2.org/][MSYS2]] framework.  [[https://www.msys2.org/][MSYS2]] is a collection of tools and
libraries providing you with an easy-to-use environment for building, installing and running native Windows software.

Download the [[https://www.msys2.org/#installation][installer]] for the [[https://www.msys2.org/][MSYS2]] framework and follow the installation instructions. Install into folder
=c:/utils/msys64= which is the default for *Psimacs*. The installation does not need to be entered in the system path
environment. *Psimacs* handles a proper executable path internally. After finishing the base installation some packages
must be installed with the [[https://www.msys2.org/][MSYS2]] package manager /pacman/. For that, open the =MSYS2 MinGW 64-bit= terminal and execute
the following commands:

*** Packages
- =pacman -Syu=
- =pacman -Su=
- =pacman -S mingw64-w64-x86_64-cmake=
- =pacman -S mingw64-w64-x86_64-qt5=
- =pacman -S mingw-w64-x86_64-toolchain=
- =pacman -S mingw-w64-x86_64-ninja=
- =pacman -S mingw-w64-x86_64-clang=
- =pacman -S mingw-w64-x86_64-clang-analyzer=
- =pacman -S mingw-w64-x86_64-clang-tools-extra=
- =pacman -S mingw-w64-x86_64-compiler-rt=
- =pacman -S mingw-w64-x86_64-libblocksruntime=
- =pacman -S mingw-w64-x86_64-openblas=
- =pacman -S mingw-w64-x86_64-boost=
- =pacman -S mingw-w64-x86_64-eigen3=
- =pacman -S mingw-w64-x86_64-zeromq=
- =pacman -S mingw-w64-x86_64-pkg-config=
- =pacman -S mingw-w64-x86_64-doxygen=
- =pacman -S mingw-w64-x86_64-graphviz=
- =pacman -S mingw-w64-x86_64-glm=
- =pacman -S mingw-w64-x86_64-hunspell=
- =pacman -S mingw-w64-x86_64-hunspell-en=
- =pacman -S mingw-w64-x86_64-aspell=
- =pacman -S mingw-w64-x86_64-aspell-de=
- =pacman -S mingw-w64-x86_64-aspell-en=
- =pacman -S mingw-w64-x86_64-gnutls=

Some of the packages are not really required but I use them and I would like to memorize my installation procedure
here. So, feel free to only install the packages you require.

Pacman queries the local package database with the =-Q= flag, the sync database with the =-S= flag and the files
database with the =-F= flag. See =pacman -Q --help=, =pacman -S --help= and =pacman -F --help= for the respective
suboptions of each flag.

Most important commands taken from
- [[https://www.msys2.org/docs/package-management/][MSYS2 Package Management]]


| Command                     | Description                                                                                                                                      |
|-----------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------|
| =pacman -Syu=               | Synchronizes the repository databases and updates the system's packages, excluding "local" packages that are not in the configured repositories. |
|-----------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------|
| =pacman -S <name>=          | Install package.                                                                                                                                 |
|-----------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------|
| =pacman -Q --help=          | Get help about the suboptions for local package database access.                                                                                 |
| =pacman -S --help=          | Get help about the suboptions for sync database access.                                                                                          |
| =pacman -F --help=          | Get help about the suboptions for files database access.                                                                                         |
|-----------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------|
| =pacman -Ss <string>=       | Search for packages in the database, searching both in packages' names and descriptions.                                                         |
| =pacman -Qs <string>=       | To search for already installed packages.                                                                                                        |
| =pacman -F  <string>=       | To search for package file names in remote packages                                                                                              |
|-----------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------|
| =pacman -Si <package_name>= | To display extensive information about a given package.                                                                                          |
| =pacman -Qi <package_name>= | For locally installed packages.                                                                                                                  |
| =pacman -Ql <package_name>= | To retrieve a list of the files installed by a package.                                                                                          |
|-----------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------|

*** Constants

#+BEGIN_SRC emacs-lisp :tangle config/init-constants.el
;;
;; MSYS2 installation
;;
(defconst psimacs/config/msys-root-dir
  (psimacs/file-system/concat-directory psimacs/config/system-utils-dir "msys64")
  "The psimacs msys64 root directory.")

(defconst psimacs/config/msys-info-dir
  (psimacs/file-system/concat-directory psimacs/config/msys-root-dir "usr/share/info")
  "The psimacs msys64 info directory.")

(defconst psimacs/config/msys-runtime-dir
  (psimacs/file-system/concat-directory psimacs/config/msys-root-dir "usr/bin")
  "The psimacs msys runtime directory.")

(defconst psimacs/config/msys-runtime-exe
  (psimacs/file-system/concat-file psimacs/config/msys-runtime-dir "bash.exe")
  "The psimacs bash executable.")

(defconst psimacs/config/mingw-root-dir
  (psimacs/file-system/concat-directory psimacs/config/msys-root-dir "mingw64")
  "The psimacs mingw64 root directory.")

(defconst psimacs/config/mingw-info-dir
  (psimacs/file-system/concat-directory psimacs/config/mingw-root-dir "share/info")
  "The psimacs mingw64 info directory.")

(defconst psimacs/config/mingw-runtime-dir
  (psimacs/file-system/concat-directory psimacs/config/mingw-root-dir "bin")
  "The psimacs mingw64 runtime directory.")
#+END_SRC

** Spell checking

Basically two spell checkers are usable with *Emacs*. Either [[https://github.com/hunspell/hunspell][Hunspell]] or [[http://aspell.net/][Aspell]]. Currently *Psimacs* uses
[[https://github.com/hunspell/hunspell][Hunspell]].

#+BEGIN_SRC emacs-lisp :tangle config/init-constants.el
;;
;; Spell checking with hunspell
;;
(defconst psimacs/config/spell-checker-hunspell-runtime
  (psimacs/file-system/concat-file psimacs/config/mingw-runtime-dir "hunspell.exe")
  "The hunspell executable to use.")

(defconst psimacs/config/spell-checker-aspell-runtime
  (psimacs/file-system/concat-file psimacs/config/mingw-runtime-dir "aspell.exe")
  "The aspell executable to use.")

(defconst psimacs/config/spell-checker-hunspell-extra-args '("-i" "utf-8")       "Extra hunspell arguments.")
(defconst psimacs/config/spell-checker-aspell-extra-args   '("--sug-mode=ultra") "Extra aspell arguments.")

(defconst psimacs/config/spell-checker-hunspell-list-command "-l"     "Command list option for hunspell.")
(defconst psimacs/config/spell-checker-aspell-list-command   "--list" "Command list option for aspell.")

(defconst psimacs/config/spell-checker-hunspell-personal-dir
  (psimacs/file-system/concat-directory psimacs/config/assets-dir "hunspell")
  "The hunspell dictionary directory provided by the MSYS2 package.")

(defconst psimacs/config/spell-checker-hunspell-dir
  (psimacs/file-system/concat-directory psimacs/config/mingw-root-dir "share/hunspell")
  "The psimacs spell checker dictionary directory for hunspell.")

(defconst psimacs/config/spell-checker-aspell-dir
  (psimacs/file-system/concat-directory psimacs/config/mingw-root-dir "lib/aspell-0.60")
  "The psimacs spell checker dictionary directory for aspell.")

(defconst psimacs/config/spell-checker-hunspell-german-dict "de_DE"
  "The hunspell german dictionary to use.")

(defconst psimacs/config/spell-checker-hunspell-english-dict "en_US"
  "The hunspell english dictionary to use.")

(defconst psimacs/config/spell-checker-aspell-german-dict "deutsch8"
  "The aspell german dictionary to use.")

(defconst psimacs/config/spell-checker-aspell-english-dict "american"
  "The aspell english dictionary to use.")

(defconst psimacs/config/spell-checker-hunspell-personal-dict-file
  (psimacs/file-system/concat-file psimacs/config/session-dir ".hunspell_")
  "The psimacs personal hunspell dictionary file.")

(defconst psimacs/config/spell-checker-aspell-personal-dict-file
  (psimacs/file-system/concat-file psimacs/config/session-dir ".aspell_")
  "The psimacs personal aspell dictionary file.")

(defconst psimacs/config/spell-checker-complete-word-dictionary-file
  (psimacs/file-system/concat-file psimacs/config/assets-dir "plain-word-list.txt")
  "A plain english word list.")

;;
;; Some derived constants to simplify setup
;;
(defconst psimacs/internal/spell-checker-use-aspell nil
  "Default spell checker is aspell.
Use the aspell spell checker if true, otherwise use the hunspell spell checker.")

(defconst psimacs/config/spell-checker-runtime
  (if psimacs/internal/spell-checker-use-aspell
      psimacs/config/spell-checker-aspell-runtime
    psimacs/config/spell-checker-hunspell-runtime)
  "The spell checker executable to use.")

(defconst psimacs/config/spell-checker-extra-args
  (if psimacs/internal/spell-checker-use-aspell
      psimacs/config/spell-checker-aspell-extra-args
    psimacs/config/spell-checker-hunspell-extra-args)
  "Extra spell checker arguments.")

(defconst psimacs/config/spell-checker-list-command
  (if psimacs/internal/spell-checker-use-aspell
      psimacs/config/spell-checker-aspell-list-command
    psimacs/config/spell-checker-hunspell-list-command)
  "Command list option for spell checker.")

(defconst psimacs/config/spell-checker-dir
  (if psimacs/internal/spell-checker-use-aspell
      psimacs/config/spell-checker-aspell-dir
    psimacs/config/spell-checker-hunspell-dir)
  "The psimacs spell checker dictionary directory.")

(defconst psimacs/config/spell-checker-german-dict
  (if psimacs/internal/spell-checker-use-aspell
      psimacs/config/spell-checker-aspell-german-dict
    psimacs/config/spell-checker-hunspell-german-dict)
  "The german dictionary to use.")

(defconst psimacs/config/spell-checker-english-dict
  (if psimacs/internal/spell-checker-use-aspell
      psimacs/config/spell-checker-aspell-english-dict
    psimacs/config/spell-checker-hunspell-english-dict)
  "The english dictionary to use.")

(defconst psimacs/config/spell-checker-personal-dict-file
  (if psimacs/internal/spell-checker-use-aspell
      psimacs/config/spell-checker-aspell-personal-dict-file
    psimacs/config/spell-checker-hunspell-personal-dict-file)
  "The psimacs personal dictionary file.")
#+END_SRC

** Multilingual grammar and style checker

[[https://languagetool.org][LanguageTool]] is a multilingual grammar and style checker. The stable version is installed from [[https://languagetool.org/download/][download]].

#+BEGIN_SRC emacs-lisp :tangle config/init-constants.el
;;
;; Multilingual grammar and style checker
;;
(defconst psimacs/config/language-tool-dir
  (psimacs/file-system/concat-directory  psimacs/config/system-utils-dir "LanguageTool")
  "The psimacs language tool directory")
#+END_SRC

** Projectile

[[https://github.com/bbatsov/projectile][Projectile]] is a project interaction library for Emacs. The following constant provides the main /project/ directories,
i.e. a directories in which [[https://github.com/bbatsov/projectile][Projectile]] searches for projects.

#+BEGIN_SRC emacs-lisp :tangle config/init-constants.el
;;
;; Projectile search pathes
;;
(defconst psimacs/config/project-search-path
    '("~/projects/source"
      "d:/projects/source"
      )
    "The psimacs project search path")
#+END_SRC

** Printing support

Printing relies on an installed [[https://www.ghostscript.com/][Ghostscript]] interpreter for the PostScript language and PDF files.

#+BEGIN_SRC emacs-lisp :tangle config/init-constants.el
;;
;; Ghostscript interpreter for PostScript and PDF files
;;
(defconst psimacs/config/ghostscript-exe
  (psimacs/file-system/concat-file  psimacs/config/system-utils-dir "gs/gs9.53.3/bin/gswin64c.exe")
  "The psimacs ghost script executable.")
#+END_SRC

** Snippets

Snippets are used by package [[https://github.com/joaotavora/yasnippet][Yasnippet]]. Beside of the installed snippets, user provided snippets used. These
are to be installed into the following directory.

#+BEGIN_SRC emacs-lisp :tangle config/init-constants.el
;;
;; User provided snippets
;;
(defconst psimacs/config/snippets-dir
  (psimacs/file-system/concat-directory  psimacs/config/site-lisp-dir "snippets")
  "The psimacs personal snippets directory.")
#+END_SRC

** Python

[[https://www.python.org/][Python]] is one of my favorite languages. I use the Windows OS [[https://www.python.org/][Python]] installer and not the [[https://www.msys2.org/][MSYS2]] python package.

Installation of the following packages is recommended: autopep8, black, certifi, cmake-language-server, flake8,
ipython, jupyter, mypy, mypy-extensions, pyflakes, pylint, pyls-black, pyls-isort, pyls-mypy, ptvsd, pycodestyle,
pycparser, pydocstyle, pywin32, pywinpty

*Psimacs* installation does reference the python tools explicitly. Nevertheless, the Windows OS [[https://www.python.org/][Python]] runtime directory
as well as the Windows OS [[https://www.python.org/][Python]] scripts directory will be added to the environment search path list prior to [[https://www.msys2.org/][MSYS2]]
pathes. Therefore our Windows OS [[https://www.python.org/][Python]] should always be at work.

#+BEGIN_SRC emacs-lisp :tangle config/init-constants.el
;;
;; Python configuration constants
;;
(defconst psimacs/config/python-tools-dir
  (psimacs/file-system/concat-directory psimacs/config/tools-dir "py-tools")
  "The psimacs personal python-tools directory.")

(defconst psimacs/config/python-vc-visual-studio-dir
  (psimacs/file-system/concat-directory psimacs/config/python-tools-dir "MS-Visual-Studio")
  "The psimacs personal MS Visual Studio python directory.")

(defconst psimacs/config/python-runtime-dir
  (psimacs/file-system/concat-directory psimacs/config/system-utils-dir "Python385")
  "The psimacs used python runtime directory.")

(defconst psimacs/config/python-scripts-dir
  (psimacs/file-system/concat-directory psimacs/config/python-runtime-dir "Scripts")
  "The psimacs used python scripts directory.")

(defconst psimacs/config/python-runtime-exe
  (psimacs/file-system/concat-file psimacs/config/python-runtime-dir "python.exe")
  "The psimacs used python runtime.")

(defconst psimacs/config/flake8-runtime-exe
  (psimacs/file-system/concat-file psimacs/config/python-scripts-dir "flake8.exe")
  "The psimacs used python flake8 runtime.")

(defconst psimacs/config/pylint-runtime-exe
  (psimacs/file-system/concat-file psimacs/config/python-scripts-dir "pylint.exe")
  "The psimacs used python pylint runtime.")

(defconst psimacs/config/mypy-runtime-exe
  (psimacs/file-system/concat-file psimacs/config/python-scripts-dir "mypy.exe")
  "The psimacs used python mypy runtime.")

(defconst psimacs/config/pyflakes-runtime-exe
  (psimacs/file-system/concat-file psimacs/config/python-scripts-dir "pyflakes.exe")
  "The psimacs used python pyflakes runtime.")

(defconst psimacs/config/pyls-runtime-exe
  (psimacs/file-system/concat-file psimacs/config/python-scripts-dir "pyls.exe")
  "The psimacs used python pyls runtime.")
#+END_SRC

** PlantUML

. [[https://plantuml.com/][PlantUML]] is an open-source tool allowing users to create [[https://en.wikipedia.org/wiki/Unified_Modeling_Language][UML]] diagrams from a plain text language.

References:
- [[https://en.wikipedia.org/wiki/Unified_Modeling_Language][Wikipedia: Unified Modeling Language]]
- [[https://www.uml-diagrams.org/][The Unified Modeling Language]]

#+BEGIN_SRC emacs-lisp :tangle config/init-constants.el
;;
;; PlantUML configration constants
;;
(defconst psimacs/config/plantuml-dir
  (psimacs/file-system/concat-directory psimacs/config/system-utils-dir "plantUML")
  "The psimacs plantUml tool  directory.")

(defconst psimacs/config/plantuml-jar-file
  (concat psimacs/config/plantuml-dir "lib/plantuml.jar")
  "The psimacs plantUml jar file.")

(defcustom psimacs/config/plantuml_java_arg_limit_size 0
  "Limits image width and heigh to this value.

Note that if you generate very big diagrams, (for example, something
like 20 000 x 10 000 pixels), you can have some memory issues.

Values: 0, 4096, 8192, 16384, 32768

If this value is 0, then no action is taken.")

(defcustom  psimacs/config/plantuml_java_arg_heap-size 0
  "Tune the Java VM heap size

Tune Jav VM heap size: -Xmx for maximum heap size, and -Xms for initial
heap size.

Values: 0, 256, 512, 1024, 2048, 4096, 8192

If this value is 0, then no action is taken.")
#+END_SRC

** Image Magick

The package [[https://github.com/mhayashi1120/Emacs-imagex][image+.el]] uses [[https://imagemagick.org/index.php][ImageMagick]]. I installed the file  [[https://imagemagick.org/script/download.php#windows][ImageMagick-7.0.10-45-portable-Q16-HDRI-x64.zip]].

#+BEGIN_SRC emacs-lisp :tangle config/init-constants.el
;;
;; Installation site of ImageMagick
;;
(defconst psimacs/config/image-magick-dir
  (psimacs/file-system/concat-directory psimacs/config/system-utils-dir "ImageMagick")
  "The psimacs ImageMagick tool directory.")
#+END_SRC

** Java

Many packages and tools do need a [[https://www.java.com][Java]] installation. I use the open source implementation [[https://openjdk.java.net/][OpenJDK]] for my purposes.
The portable [[https://download.java.net/java/GA/jdk15.0.1/51f4f36ad4ef43e39d0dfdbaf6549e32/9/GPL/openjdk-15.0.1_windows-x64_bin.zip][Zip]] package for [[https://jdk.java.net/15/][Java Version 15]] is used by me.

#+BEGIN_SRC emacs-lisp :tangle config/init-constants.el
;;
;; Java constants
;;
(defconst psimacs/config/java-runtime-dir
  (psimacs/file-system/concat-directory psimacs/config/system-utils-dir "java64/bin")
  "The psimacs java runtime directory.")

(defconst psimacs/config/java-runtime-exe
  (psimacs/file-system/concat-file psimacs/config/java-runtime-dir "javaw.exe")
  "The psimacs java executable.")
#+END_SRC

** Git

[[https://git-scm.com/][Git]] is a very important external tool to be installed. *Psimacs* uses the [[https://github.com/raxod502/straight.el][Straight]] package manager which relies on a
properly installed [[https://git-scm.com/][Git]] program. A portable version is available at from their [[https://git-scm.com/download/win][download site]].

#+BEGIN_SRC emacs-lisp :tangle config/init-constants.el
;;
;; Portable Git configuration
;;
(defconst psimacs/config/git-runtime-dir
  (psimacs/file-system/concat-directory psimacs/config/system-utils-dir "PortableGit/cmd")
  "The psimacs git runtime directory.")

(defconst psimacs/config/git-runtime-exe
  (psimacs/file-system/concat-file psimacs/config/git-runtime-dir "git.exe")
  "The psimacs git executable.")

(defconst psimacs/config/gitk-runtime-exe
  (psimacs/file-system/concat-file psimacs/config/git-runtime-dir "gitk.exe")
  "The psimacs gitk executable.")
#+END_SRC

** Graphviz

[[http://www.graphviz.org/][Graphviz]] is a wonderful tool for diagram generation. Especially [[https://plantuml.com/][PlantUML]] uses it as its backend interpreter for the
[[https://graphviz.org/doc/info/lang.html][Dot]] language.

#+BEGIN_SRC emacs-lisp :tangle config/init-constants.el
;;
;; Graphviz tool constants
;;
(defconst psimacs/config/graphviz-runtime-dir
  psimacs/config/mingw-runtime-dir
  "The psimacs Graphviz directory.")

(defconst psimacs/config/graphviz-runtime-dot-exe
  (psimacs/file-system/concat-file psimacs/config/graphviz-runtime-dir "dot.exe")
  "The psimacs Graphviz dot executable.")
#+END_SRC

** CMake

[[https://cmake.org/][CMake]] is an open-source, cross-platform family of tools designed to build, test and package software.

#+BEGIN_SRC emacs-lisp :tangle config/init-constants.el
;;
;; CMake tool configuration constants
;;
(defconst psimacs/config/cmake-runtime-dir
  psimacs/config/mingw-runtime-dir
  "The psimacs CMake directory.")

(defconst psimacs/config/cmake-runtime-exe
  (psimacs/file-system/concat-file psimacs/config/cmake-runtime-dir "cmake.exe")
  "The psimacs CMake cmake runtime file.")

(defconst psimacs/config/ctest-runtime-exe
  (psimacs/file-system/concat-file psimacs/config/cmake-runtime-dir "ctest.exe")
  "The psimacs CMake ctest runtime file.")

(defconst psimacs/config/cpack-runtime-exe
  (psimacs/file-system/concat-file psimacs/config/cmake-runtime-dir "cpack.exe")
  "The psimacs CMake cpack runtime file.")

(defconst psimacs/config/cmcldeps-runtime-exe
  (psimacs/file-system/concat-file psimacs/config/cmake-runtime-dir "cmcldeps.exe")
  "The psimacs CMake cmcldeps runtime file.")

(defconst psimacs/config/cmake-gui-runtime-exe
  (psimacs/file-system/concat-file psimacs/config/cmake-runtime-dir "cmake-gui.exe")
  "The psimacs CMake cmake-gui runtime file.")
#+END_SRC

** Clang/LLVM

[[https://clang.llvm.org/][Clang]] can be used for compiling and linking [[https://en.wikipedia.org/wiki/C%2B%2B][C++]] programs.

Some usefule references for C++:
- [[https://en.wikipedia.org/wiki/C%2B%2B][Wikipedia: C++]]
- [[https://isocpp.org/][News, Status & Discussion about Standard C++]]
- [[https://www.cplusplus.com/][Welcome to cplusplus.com]]
- [[https://en.cppreference.com][C++ Reference]]
- [[https://justinmeiners.github.io/sgi-stl-docs/][Standard Template Library Programmer's Guide]]
- [[https://www.boost.org/][Boost C++ Libraries]]

#+BEGIN_SRC emacs-lisp :tangle config/init-constants.el
;;
;; Clang compiler framework configuration constants
;;
(defconst psimacs/config/clang-runtime-dir
  psimacs/config/mingw-runtime-dir
  "The psimacs clang directory.")

(defconst psimacs/config/clang-c++-compiler-runtime-exe
  (psimacs/file-system/concat-file psimacs/config/clang-runtime-dir "clang++.exe")
  "The psimacs clang++ executable.")

(defconst psimacs/config/clang-cl-compiler-runtime-exe
  (psimacs/file-system/concat-file psimacs/config/clang-runtime-dir "clang-cl.exe")
  "The psimacs clang-cl executable.")

(defconst psimacs/config/clangd-runtime-exe
  (psimacs/file-system/concat-file psimacs/config/clang-runtime-dir "clangd.exe")
  "The psimacs clangd executable.")

(defconst psimacs/config/clang-format-runtime-exe
  (psimacs/file-system/concat-file psimacs/config/clang-runtime-dir "clang-format.exe")
  "The psimacs clang-format executable.")

(defconst psimacs/config/clang-include-fixer-runtime-exe
  (psimacs/file-system/concat-file psimacs/config/clang-runtime-dir "clang-include-fixer.exe")
  "The psimacs clang-include-fixer executable.")

(defconst psimacs/config/clang-tidy-runtime-exe
  (psimacs/file-system/concat-file psimacs/config/clang-runtime-dir "clang-tidy.exe")
  "The psimacs clang-tidy executable.")

(defconst psimacs/config/clang-check-exe
  (psimacs/file-system/concat-file psimacs/config/clang-runtime-dir "clang-check.exe")
  "The psimacs clang-check executable.")

(defconst psimacs/config/clang-rename-exe
  (psimacs/file-system/concat-file psimacs/config/clang-runtime-dir "clang-rename.exe")
  "The psimacs clang-rename executable.")

(defconst psimacs/config/clang-refactor-exe
  (psimacs/file-system/concat-file psimacs/config/clang-runtime-dir "clang-refactor.exe")
  "The psimacs clang-refactor executable.")
#+END_SRC

* Environment

Extent the execution search path by the external tools that *Psimacs* supports. Do not rely solely on the
correct parents search path setup. Be explicit. Additionally, synchronize the environment search path with
*Emacs*'s =exec-path=.

#+BEGIN_SRC emacs-lisp :tangle config/init-environment.el :var file-description="Search path setup"
;;
;; Explicitely set the environment to the tools that are important. Do not rely on the parent
;; environment. Synchronize execution path and the environment search path
;;
(setq exec-path
      (append `(
                ,psimacs/config/python-runtime-dir
                ,psimacs/config/python-scripts-dir
                ,psimacs/config/java-runtime-dir
                ,psimacs/config/git-runtime-dir
                ,psimacs/config/mingw-runtime-dir
                ,psimacs/config/msys-runtime-dir
                ,psimacs/config/tex-runtime-dir
                ;;,psimacs/config/cmake-runtime-dir       ; cmake is part of mingw
                ;;,psimacs/config/graphviz-runtime-dir    ; dito for graphviz
                )
              exec-path))

(setenv "PATH" (mapconcat #'identity exec-path path-separator))

;;(message (getenv "PATH"))
;;
;; Print the current exec-path to the message buffer
;;
(psimacs/config/message-elements-of-list exec-path)
#+END_SRC

* Package management

In this section some security measures are configured and the package manager is initialized.

** Making Emacs secure

Some safety tips regarding your editor are covered in the excellent article [[https://glyph.twistedmatrix.com/2015/11/editor-malware.html][Your Text Editor is Malware]].
So, before going on with the configuration, let's get some things straight. First of all, enable checking
trust on TLS connections.

#+BEGIN_SRC emacs-lisp :tangle config/init-secure.el :var file-description="Secure Emacs"
(setq tls-checktrust t)
#+END_SRC

*Emacs* is now no able to fetch HTTPS anymore! Emacs does not distribute trust root certificates.
We have to solve this problem. The [[https://www.python.org/][Python]] package [[https://pypi.org/project/certifi/][certifi]] /provides Mozilla's carefully curated collection of
Root Certificates for validating the trustworthiness of SSL certificates while verifying the identity of TLS hosts./
The [[https://www.python.org/][Python]] package [[https://pypi.org/project/certifi/][certifi]] should be installed by =pip install certifi=. The following [[https://gitlab.com/DiegoVicente/my-emacs/-/tree/master/][code snippet from Diego Vicente]]
allows the evaluation of the generated trustfile.

#+BEGIN_SRC emacs-lisp :tangle config/init-secure.el
;;
;; With curtsy to https://gitlab.com/DiegoVicente/my-emacs/-/tree/master/
;;
(let
    (
     (trustfile
      (replace-regexp-in-string
       "\\\\" "/"
       (replace-regexp-in-string
        "\n" ""
        ;; requires "pip install certifi"
        (shell-command-to-string (concat psimacs/config/python-runtime-exe " -m certifi"))))
      )
     )

  (setq tls-program (list (format
                           "gnutls-cli%s --x509cafile %s -p %%p %%h"
                           (if (eq window-system 'w32) ".exe" "") trustfile)))

  ;;(message "%s" trustfile)
  ;;(message "%s" tls-program)

  (setq gnutls-verify-error t)
  (setq gnutls-trustfiles (list trustfile))
)
#+END_SRC

It is important to have added MELPA as an HTTPS site for this secure configuration to work.

The following function allows us to check if this setup is properly done. Thanks again to [[https://gitlab.com/DiegoVicente/my-emacs/-/tree/master/][Diego Vicente]].

#+BEGIN_SRC emacs-lisp :tangle config/init-secure.el
;;
;; Test function with curtsy to https://gitlab.com/DiegoVicente/my-emacs/-/tree/master/
;;
(defun psimacs/config/check-tls-config ()
    "Check for correctness in the TLS configuration for Emacs."
    (interactive)
    (let ((bad-hosts
        (cl-loop for bad in '("https://wrong.host.badssl.com/" "https://self-signed.badssl.com/")
            if (condition-case e (url-retrieve bad (lambda (retrieved) t))
                (error nil))
            collect bad)))
        (if bad-hosts
            (error (format "TLS misconfigured; retrieved %s ok" bad-hosts))
        (url-retrieve "https://badssl.com" (lambda (retrieved) t))))
)
#+END_SRC

** Straight package manager

*Psimacs* uses the [[https://github.com/raxod502/straight.el][Straight]] package manager. Note that this package manager depends on [[https://git-scm.com/][Git]].

*** Bootstrap straight.el

To get running at all, the [[https://github.com/raxod502/straight.el][Straight]] package must be installed itself. The code is taken from the [[https://github.com/raxod502/straight.el][Straight]]
/Getting Started/ section.

#+BEGIN_SRC emacs-lisp :tangle config/init-package-manager.el :var file-description="Package manager"
;;
;; bootstrap package straight.el
;;
(defvar bootstrap-version)
(let (
        (bootstrap-file (expand-file-name "straight/repos/straight.el/bootstrap.el" user-emacs-directory))
        (bootstrap-version 5)
    )
    (unless (file-exists-p bootstrap-file)
        (with-current-buffer
            (url-retrieve-synchronously
                "https://raw.githubusercontent.com/raxod502/straight.el/develop/install.el"
                'silent 'inhibit-cookies
            )
            (goto-char (point-max))
            (eval-print-last-sexp)
        )
    )
    (load bootstrap-file nil 'nomessage)
)
#+END_SRC

*** use-package
Replace =use-package= automatically by =straight-use-package= in our configuration.

[[https://github.com/jwiegley/use-package][use-package]] is a macro that provides convenient syntactic sugar for many common tasks
related to installing and configuring *Emacs* packages. Of course, it does not actually
install the packages, but instead defers to a package manager, like [[https://github.com/raxod502/straight.el][Straight]].

To use use-package, first install it with [[https://github.com/raxod502/straight.el][Straight]]:

#+BEGIN_SRC emacs-lisp :tangle config/init-package-manager.el
;;
;; To use use-package, first install it with straight.el
;;
(straight-use-package 'use-package)
#+END_SRC

Now =use-package= will use [[https://github.com/raxod502/straight.el][Straight]] to automatically install missing packages if you provide =:straight t=.

Customize =straight-use-package-by-default= to make it so that =:straight t= is assumed unless you explicitly
override it with =:straight nil=.

Specifying =:straight t= is unnecessary if you set =straight-use-package-by-default= to a non-nil value.

#+BEGIN_SRC emacs-lisp :tangle config/init-package-manager.el
;;
;; No more ':straight t' necessary anymore
;;
(setq straight-use-package-by-default t)
#+END_SRC

Any code that relates to /[[https://wikemacs.org/wiki/Package.el][package.el]]/ should be removed; for example, references to =package-initialize=,
=package-archives=, and (if you're using =use-package=) =:ensure= or =use-package-always-ensure=.

While it is technically possible to use both  /[[https://wikemacs.org/wiki/Package.el][package.el]]/ and [[https://github.com/raxod502/straight.el][Straight]] at the same time, there is no real
reason to, and it might result in oddities like packages getting loaded more than once.

Out of the box, you can install any package listed on [[https://melpa.org/#/][MELPA]], [[https://elpa.gnu.org/][GNU ELPA]], or [[https://github.com/emacsmirror][Emacsmirror]], which is to say any
package in existence. (Although  [[https://melpa.org/#/][MELPA]] is used as a package listing, packages are installed by cloning their
[[https://git-scm.com/][Git]] repositories rather than by downloading tarballs like /[[https://wikemacs.org/wiki/Package.el][package.el]]/ does.)

If the package or your configurations aren't being loaded, you probably have something wrong with your
usage of =:init= and =:config=. By default, the behavior of =use-package= is inconsistent:
You must set either =use-package-always-defer= (override with =:demand t=) or =use-package-always-demand=
(override with =:defer t=) to set a default for whether evaluating a =use-package= form will load the
package and your configurations.

If you've set a package to be deferred, you then need to make sure there's a way for it to get loaded when
needed, for example by means of an autoload (either provided by the package, or set up automatically
by =use-package= via =:bind=, or set up manually through =use-package= via =:commands=) or by an explicit
require in one of your custom commands.

If you do want to start optimizing your startup, you will likely end up using just =:hook= for mode triggered
loading and =:defer t= for command triggered loading!

*** Provide the diminish.el package

[[https://github.com/emacsmirror/diminish][Diminish]] implements hiding or abbreviation of the mode line displays (lighters) of minor-modes.


#+BEGIN_SRC emacs-lisp :tangle config/init-package-manager.el
;;
;; Avoid mode line cluttering by using :diminish
;;
(use-package diminish
  :demand t
  :config
        (diminish 'org-indent-mode)
)
#+END_SRC

*** Provide the dim.el package

The [[https://github.com/alezost/dim.el][dim]] package can be used to change the names of major and minor modes that are displayed in the mode-line.

#+BEGIN_SRC emacs-lisp :tangle config/init-package-manager.el
;;
;; Allow better names for major and minor modes on the command line.
;;
(use-package dim :demand t)
#+END_SRC

* Basic setup

Some fundamental setting that *Psimacs* uses are collected here.

** Personal information

Personal information settings for *Psimacs*. The /private/ folder content is not part of the public bundle.
Package =private/init-private.el= is loaded if it exists and its settings are applied.


#+BEGIN_SRC emacs-lisp :tangle config/init-basic-private.el :var file-description="Basic private setup"
;;
;; Private directory and file might exists; not mandatory.
;;
(setq user-full-name    "Your Name"
      user-mail-address "Your Email"
      calendar-latitude  0
      calendar-longitude 0
      calendar-location-name "Your city, country"
)

(when (file-directory-p psimacs/config/private-dir)
  (add-to-list 'load-path psimacs/config/private-dir)

  (when (file-exists-p psimacs/config/private-file)
    (require 'init-private)))

(add-hook 'emacs-startup-hook
          (lambda ()
            (message "Emacs configured for user %s %s in %s" user-full-name user-mail-address calendar-location-name)))
#+END_SRC

** Measuring the startup performance

*** Print the startup time

In order to get expressive timing information about the initialization process, *Psimacs* always prints the
actual startup time into the *Message* buffer.

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-system.el :var file-description="Basic system setup"
;;
;; Perfromance measuring at the end of the initialization
;;
(add-hook 'emacs-startup-hook
    (lambda ()
        (message "Emacs loaded in %s with %d garbage collections."
            (format "%.2f seconds"
                (float-time (time-subtract after-init-time before-init-time))
            )
            gcs-done)
    )
)
#+END_SRC

*** Detail startup benchmarking

This is a simple benchmark of calls to *Emacs* /require/ and /load/ functions. It can be used to keep track
of where time is being spent during *Emacs* startup in order to optimize startup times.

Usage: The following commands and functions can be used to govern the benchmarking.


| =benchmark-init/show-durations-tabulated= |
| =benchmark-init/show-durations-tree=      |
|                                           |
| =benchmark-init/activate=                 |
| =benchmark-init/deactivate=               |


Using =:defer N= with an integer is for a rare scenario where you do want the package to always be unconditionally
loaded on startup (and not reactively as the result of a file mode or executed command) and want to kick it out by
a few seconds to technically save some startup time.

I personally don't recommend this since it's not going to speed up your actual "time to full functionality," but
instead just improve a narrowly defined metric of "startup time."

References to benchmarking:
- [[https://www.emacswiki.org/emacs/BenchmarkInit][BenchmarkInit]]
- [[https://github.com/dholm/benchmark-init-el][benchmark-init]]
- [[https://www.emacswiki.org/emacs/OptimizingEmacsStartup][OptimizingEmacsStartup]]
- [[https://www.emacswiki.org/emacs/ProfileDotEmacs][Profile Dot Emacs]]

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-system.el
;;
;; Detail benchmarking: see benchmark-init/show-durations-tabulated and benchmark-init/show-durations-tree
;; Activated on default.
;;
(use-package benchmark-init
    :demand t
    :init
        (benchmark-init/activate)
)
#+END_SRC

** Avoid truncated output, i.e annoying ellipsis

The options eval-expression-print-level and eval-expression-print-length control the maximum depth
and length of lists to print in the result of the evaluation commands before abbreviating them. They
are described in the [[https://www.gnu.org/software/emacs/manual/html_node/emacs/Lisp-Eval.html][Lisp evaluation]] section of the *Emacs* manual.

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-system.el
;;
;; Avoid truncated output, i.e annoying ellipsis
;;
(setq eval-expression-print-level nil)
(setq eval-expression-print-length nil)
#+END_SRC

** Performance optimizations

Try to optimize *Psimacs* as much as possible (as far as my *Emacs* knowledge goes).

*** Garbage collect when out of focus

Let *Psimacs* perform garbage collection if it does not have the focus.

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-optimizations.el :var file-description="Basic performance optimizations"
;;
;; Garbage collect when out of focus
;;
(add-hook 'emacs-startup-hook
    (lambda ()
      (if (boundp 'after-focus-change-function)
          (add-function :after after-focus-change-function
                        (lambda ()
                          (unless (frame-focus-state)
                            (garbage-collect))))
        (add-hook 'after-focus-change-function 'garbage-collect))))
#+END_SRC

*** Avoid garbage collection in minibuffer

Avoid performing garbage collection operations when using the minibuffer. We do this by enlarging the
garbage collection threshold.

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-optimizations.el
;;
;; Avoid garbage collection in minibuffer
;;
(defun psimacs/config/gc-minibuffer-setup-hook ()
  "Enlarge the current gc-cons-threshold"
  (setq gc-cons-threshold (* psimacs/config/gc-cons-threshold 2)))

(defun psimacs/config/gc-minibuffer-exit-hook ()
  "Garbage collect and reset the gc-cons-threshold"
  (garbage-collect)
  (setq gc-cons-threshold psimacs/config/gc-cons-threshold))

(add-hook 'minibuffer-setup-hook #'psimacs/config/gc-minibuffer-setup-hook)
(add-hook 'minibuffer-exit-hook  #'psimacs/config/gc-minibuffer-exit-hook)
#+END_SRC

*** Use the garbage collector magic hack

Enforce a sneaky Garbage Collection strategy to minimize GC interference with the activity.

During normal use a high GC threshold is set. When idling GC is immediately triggered and a low threshold is set.
The [[https://github.com/emacsmirror/gcmh][GCMH (the Garbage Collector Magic Hack)]] package provides us with this functionality.

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-optimizations.el
;;
;; Use the garbage collector magic hack
;;
(use-package gcmh
    :diminish gcmh-mode
    :init (gcmh-mode 1)
)
#+END_SRC

*** Process data exchange
Basically, this is an optimization with respect to the data exchange between [[https://microsoft.github.io/language-server-protocol/][Language Server Protocol]] servers and
its clients.

[[https://emacs-lsp.github.io/lsp-mode/][lsp-mode: Language Server Protocol Support for Emacs]], aims to provide IDE-like experience by providing optional
integration with the most popular *Emacs* packages like [[https://company-mode.github.io/][company]], [[https://www.flycheck.org/en/latest/][flycheck]] and [[https://github.com/bbatsov/projectile][projectile]].

Increase the amount of data which *Emacs* reads from the process. Again the *Emacs* default is too low 4K
considering that the some of the language server responses are in 800k - 3M range.

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-optimizations.el
;;
;; lsp-mode optimization
;;
(setq read-process-output-max 4MB)
#+END_SRC

** Keyboard configuration

References about keyboard configuration and key bindings:
- [[https://karl-voit.at/2018/07/08/emacs-key-bindings/][UOMF: My Emacs Key Binding Strategy]]
- [[https://www.masteringemacs.org/article/mastering-key-bindings-emacs][Mastering Key Bindings in Emacs]]
- [[https://www.gnu.org/software/emacs/manual/html_node/emacs/Windows-Keyboard.html][Keyboard Usage on MS-Windows]]
- [[http://www.wilfred.me.uk/blog/2018/01/06/the-emacs-guru-guide-to-key-bindings/][The Emacs Guru Guide to Key Bindings]]
- [[http://ergoemacs.org/emacs/emacs_hyper_super_keys.html][Emacs: How to Bind Super Hyper Keys]]
- [[https://www.emacswiki.org/emacs/AltGrKey][AltGrKey]]

*** How to type C-@ on a German Windows keyboard

Emacs keys may seem to be /hidden/ because MS Windows implements =AltGr= as =Alt + Left Control=.
Therefore key bindings such as =C-@= are quite difficult to type.

Solutions:
- Using the right control key

#+BEGIN_QUOTE
  The trick is that you must type =AltGr= as the first key, and =Ctrl= must be the right control key,
  not the left one.
#+END_QUOTE

- Using =C-SPC= instead of =C-@=

#+BEGIN_QUOTE
  It turns out that instead of =C-@= you can always type =C-SPC=.
#+END_QUOTE

*** Base configuration of the keyboard

Basically, we stay with the default *Emacs* keyboard configuration. We swallow the =<lwindow>=, =<rwindow>= and =<apps>=
keys as far as possible. We will use them for =super= and =<hyper>= prefix keys for *Psimacs* own key bindings.

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-system.el
;;
;; Base keyboard configuration: Stay with the defaults, but swallow <lwindow>, <rwindow> ans <apps> if possible
;;
(setq w32-alt-is-meta t                ;; The meta modifier is interpreted as the Alt key (the default)
      ;;w32-register-hot-key [M-tab]   ;; Allow a key sequence M-tab to be seen by Emacs instead of being grabbed by
                                       ;; Windows. Normal Windows handling is probably the better option :-)



      ;;w32-capslock-is-shiftlock t    ;; The CapsLock key will affect non-character keys as well, as if you pressed
                                       ;; the Shift key while typing the non-character key.

      w32-enable-caps-lock t           ;; If the variable w32-enable-caps-lock is set to a nil value, the CapsLock
                                       ;; key produces the symbol capslock instead of the shifted version of they keys.
                                       ;; The default value is t.

      w32-enable-num-lock t            ;; If w32-enable-num-lock is nil, the NumLock key will produce the symbol
                                       ;; kp-numlock. The default is t, which causes NumLock to work as expected:
                                       ;; toggle the meaning of the keys on the numeric keypad.

      32-recognize-altgr t             ;; Whether the <AltGr> key (if it exists on your keyboard), or its equivalent,
                                       ;; the combination of the right <Alt> and left <Ctrl> keys pressed together,
                                       ;; is recognized as the <AltGr> key. The default is t, which means these keys
                                       ;; produce AltGr; setting it to nil causes <AltGr> or the equivalent key
                                       ;; combination to be interpreted as the combination of <Ctrl> and <Meta>
                                       ;; modifiers.

      w32-pass-lwindow-to-system nil   ;; the <lwindow> key is silently swallowed by Emacs, and not passed to Windows.
      w32-pass-rwindow-to-system nil   ;; the <rwindow> key is silently swallowed by Emacs, and not passed to Windows.
      w32-pass-apps-to-system nil      ;; the    <apps> key is silently swallowed by Emacs, and not passed to Windows.

      w32-scroll-lock-modifier nil     ;; Do not specialize the scroll lock key
)
#+END_SRC

*** Hyper and Super prefix keys

*Psimacs* uses the =super= and =hyper= key prefixes for all of its own key bindings.

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-system.el
;;
;; <lwindow>, <rwindow> and <apps>
;;
(setq  w32-lwindow-modifier 'super
       w32-rwindow-modifier 'super
       w32-apps-modifier    'hyper
)

(w32-register-hot-key [s-])
(w32-register-hot-key [H-])

;; (defun psimacs/config/prefix-key-test-super ()
;;   (interactive)
;;   (message "Super key pressed"))

;; (defun psimacs/config/prefix-key-test-hyper ()
;;   (interactive)
;;   (message "Hyper key pressed"))

;; (global-set-key [(super t)] 'psimacs/config/prefix-key-test-super)
;; (global-set-key [(hyper t)] 'psimacs/config/prefix-key-test-hyper)
#+END_SRC

*** Strip unused key bindings

Free up unused and unnecessary keybindings.

There are a great many keybindings that are actively hostile, in that they are bound to useless or obsolete functions
that are really easy to trigger accidentally.

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-system.el
;;
;; Strip unused key bindings
;;
(unbind-key "C-z")              ;; suspend-frame
(unbind-key "M-o")              ;; facemenu-mode
(unbind-key "<mouse-2>")        ;; pasting with mouse-wheel click
(unbind-key "<C-wheel-down>")   ;; text scale adjust
#+END_SRC

*** Personal key prefix map

For *Psimacs* own functions and goodies separate key prefix maps are defined:

| Prefix command                       | Description               |
|--------------------------------------+---------------------------|
| =H-h= and =s-h=                      | Hydras                    |
| =H-c= and =s-c=                      | common user commands      |
| =H-x= and =s-x=                      | common execution commands |
| =H-m=, =H-,= =s-m=, =s-,= and =<f9>= | special user commands     |
|--------------------------------------+---------------------------|


#+BEGIN_SRC emacs-lisp :tangle config/init-basic-system.el
;;
;; Separate prefix key maps for Psimacs own bindings
;;
(define-prefix-command 'psimacs/config/global-key-map/common)     ;; used for common user commands
(define-prefix-command 'psimacs/config/global-key-map/special)    ;; special user commands
(define-prefix-command 'psimacs/config/global-key-map/execute)    ;; used for common execution commands
(define-prefix-command 'psimacs/config/global-key-map/hydra)      ;; uses solely for accessing hydras

(global-set-key (kbd "H-h" ) psimacs/config/global-key-map/hydra)
(global-set-key (kbd "H-c" ) psimacs/config/global-key-map/common)
(global-set-key (kbd "H-x" ) psimacs/config/global-key-map/execute)

(global-set-key (kbd "s-h" ) psimacs/config/global-key-map/hydra)
(global-set-key (kbd "s-c" ) psimacs/config/global-key-map/common)
(global-set-key (kbd "s-x" ) psimacs/config/global-key-map/execute)

(global-set-key (kbd "<f9>") psimacs/config/global-key-map/special)
(global-set-key (kbd "H-m" ) psimacs/config/global-key-map/special)
(global-set-key (kbd "H-," ) psimacs/config/global-key-map/special)
(global-set-key (kbd "s-m" ) psimacs/config/global-key-map/special)
(global-set-key (kbd "s-," ) psimacs/config/global-key-map/special)

(defun psimacs/config/greetings ()
   (interactive)
   (message "hello from psimacs"))

(define-key psimacs/config/global-key-map/common  (kbd "C-t C-t") 'psimacs/config/greetings)
(define-key psimacs/config/global-key-map/special (kbd "C-t C-t") 'psimacs/config/greetings)

;;
;; Provide the Windows OS default frame closing expirience
;;
(defun psimacs/config/delete-frame ()
    "This function deletes the selected frame. If the last frame it leaves emacs."
    (interactive)
    (if (= (length (frame-list)) 1)
        (save-buffers-kill-terminal)
      (delete-frame)
      )
)

(global-set-key (kbd "M-<f4>" ) 'psimacs/config/delete-frame)
#+END_SRC

** User Site-Lisp load path
We have one directory that we use for user elips code. We add this path the the list of load pathes.

Our own /Emacs/ code resides in one directory that must be added to the load path.

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-system.el
;;
;; Our site-lisp directory.
;;
(add-to-list 'load-path psimacs/config/site-lisp-dir)
#+END_SRC

** Automatically compile outdated elips files

The [[https://github.com/emacscollective/auto-compile][Auto-compile]] package provides two minor modes which automatically recompile Emacs Lisp source files.
Together these modes guarantee that Emacs never loads outdated byte code files.

Further reading: [[https://www.emacswiki.org/emacs/AutoRecompile][EmacsWiki: Auto Recompile]]

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-system.el
;;
;; Automatically recomile elips files
;;
(use-package auto-compile
    :demand t
    :config
        (auto-compile-on-load-mode)  ;; Force recompilation on load of .el file.
        (auto-compile-on-save-mode)  ;; Force recompilation on save of .el file.

        (setq load-prefer-newer t    ;; Avoid byte-compiled files that are older than their respective source files.
              auto-compile-display-buffer nil  ;; Avoid annoying pop up of the Compile-Log buffer when a file is saved
              auto-compile-mode-line-counter t ;; Only show the number of compile warnings for the current file in
                                               ;; the mode-line.

              auto-compile-source-recreate-deletes-dest t  ;; Whether to delete leftover byte code file when creating
                                                           ;; source file.
        )

        ;(setq auto-compile-toggle-deletes-nonlib-dest   t)      ; Whether to delete non-library byte code files when toggling compilation.
        ;(setq auto-compile-update-autoloads             t)      ; Whether to update autoloads after compiling.
        ;(add-hook 'auto-compile-inhibit-compile-hook
        ;          'auto-compile-inhibit-compile-detached-git-head)
)
#+END_SRC

** Info system

Add the [[https://www.msys2.org/][MSYS2]] info pathes to the *Emacs Info* search path.

*Attention:* In case that the =info/dir= files in the [[https://www.msys2.org/][MSYS2]] installation are missing or not up to date run in a [[https://www.msys2.org/][MSYS2]]
bash shell the following code each =info= directory. This will create or update the =info/dir= files.

#+BEGIN_SRC
cd c:/utils/msys64/usr/share/info
for i in *info*; do install-info.exe $i dir; done

cd c:/utils/msys64/mingw64/share/info
for i in *info*; do install-info.exe $i dir; done
#+END_SRC

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-system.el
;;
;; Extend Emacs info system with the msys2 info material
;;
(add-to-list 'Info-additional-directory-list psimacs/config/msys-info-dir)
(add-to-list 'Info-additional-directory-list psimacs/config/mingw-info-dir)
#+END_SRC

** Printing on Windows

*Psimacs* currently supports two sets of commands for printing on windows:

| Key binding     | Command                          | Description                                     |
|-----------------+----------------------------------+-------------------------------------------------|
| =H-m C-p C-p b= | =M-x print-buffer=               | B/W print hardcopy of buffer on default printer |
| =H-m C-p C-p r= | =M-x print-region=               | B/W print hardcopy of region on default printer |
|-----------------+----------------------------------+-------------------------------------------------|
| =H-m C-p C-q p= | =M-x ps-print-buffer=            | B/W print buffer via Ghostscript                |
| =H-m C-p C-q r= | =M-x ps-print-region=            | B/W print region via Ghostscript                |
|-----------------+----------------------------------+-------------------------------------------------|
| =H-m C-p C-f p= | =M-x ps-print-buffer-with-faces= | Color print buffer via Ghostscript              |
| =H-m C-p C-f r= | =M-x ps-print-region-with-faces= | Color print region via Ghosts                   |
|-----------------+----------------------------------+-------------------------------------------------|

For the =print-*= commands to function, I was forced to do some extra work outside of *Emacs*. The reason is that
I am using a network printer with its own IP address. IMHO, *Emacs* does not handle this situation out of the box.
At first I followed the [[https://www.emacswiki.org/emacs/MsWindowsNetworkPrinter][Ms Windows Network Printer]] instructions. That basically work for me. However, I discovered
that I just need to share my printer and then call the following =shell-command= to create a virtual printer
port /LPT3/:

#+BEGIN_SRC
net use LPT3: "\\127.0.0.1\EPSON ET-4750 Series"
#+END_SRC

I simply integrated this call into my =psimacs.cmd= command and set the =printer-name= to the virtual printer
port /LPT3/ in the configuration.

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-system.el
;;
;; Support for the printer-* commands
;;
(setq printer-name "LPT3:")
#+END_SRC

For the =ps-print-*= commands to work I needed to install [[https://www.ghostscript.com/][Ghostscript]]. First I tried the [[https://www.msys2.org/][MSYS2]] which I was not able
to get working correctly. Therefore I tried the 64 Bit [[https://www.ghostscript.com/download/gsdnld.html][Windows installer]] from the [[https://www.ghostscript.com/][Ghostscript]] download site. This worked
perfectly. In order to set this up I followed the [[https://www.gnu.org/software/emacs/manual/html_node/emacs/Windows-Printing.html][Printing and MS-Windows]] *Emacs* manual instructions.


#+BEGIN_SRC emacs-lisp :tangle config/init-basic-system.el
;;
;; Support for the ps-print-* commands
;;
(setq ps-printer-name t)
(setq ps-lpr-command psimacs/config/ghostscript-exe)
(setq ps-lpr-switches '("-q" "-dNOPAUSE" "-dBATCH" "-sDEVICE=mswinpr2" "-sPAPERSIZE=a4"))

;;
;; Some extra printing customizations that I currently not use
;;
;; (setq ps-top-margin 0
;;       ps-left-margin 0
;;       ps-right-margin 0
;;       ps-inter-column 0
;;       ps-landscape-mode t
;;       ps-number-of-columns 2
;;       ps-paper-type 'a4
;;       ps-font-size 8.25
;;       ps-line-number t
;;       ps-line-number-font-size 10
;;       ps-line-number-step 10
;;       ps-print-color-p 'black-white
;;       ps-print-header nil
;; )

#+END_SRC

** Basic ELisp Libraries

Load some basic packages that provide support for more elegant [[https://www.gnu.org/software/emacs/manual/html_node/elisp/][Elisp]] programming.

The following links might be useful for diving deeper into [[https://www.gnu.org/software/emacs/manual/html_node/elisp/][Elisp]]:
- [[https://www.gnu.org/software/emacs/manual/eintr.html][Introduction to Programming in Emacs Lisp]]
- [[https://www.emacswiki.org/emacs/ElispCookbook][EmacsWiki: Lisp Cookbook]]
- [[http://wikemacs.org/wiki/Emacs_Lisp_Cookbook][WikEmacs: Emacs Lisp Cookbook]]
- [[https://github.com/chrisdone/elisp-guide][Emacs Lisp Guide]]
- [[https://www.masteringemacs.org/article/evaluating-elisp-emacs][Evaluating Elisp in Emacs]]
- [[http://ergoemacs.org/emacs/elisp.html][Practical Emacs Lisp]]

*** Dash Library

[[https://github.com/magnars/dash.el][Dash]] is a modern list api for *Emacs*. No 'cl required.

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-system.el
;;
;; Some basic library packages that mordenize elisp programming
;;
(use-package dash
    :config
        (dash-enable-font-lock)
)

(use-package dash-functional)
#+END_SRC

*** String manipulation with the s.el library

[[https://github.com/magnars/s.el][s]] is a [[https://github.com/magnars/s.el][string manipulation library]] that provides lots of =s-name= functions for easing string programming tasks.

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-system.el
;;
;; A string manipulation library
;;
(use-package s)
#+END_SRC

*** A file system library named f.el

[[https://github.com/rejeep/f.el][f]] is a [[https://github.com/rejeep/f.el][file system library]] that provides lots of =f-name= functions for easing file system programming tasks.
Basically it provides a modern API for working with files and directories in *Emacs*.

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-system.el
;;
;; A file system library
;;
(use-package f)
#+END_SRC

*** Alert an alternative notification interface

Just use [[https://github.com/jwiegley/alert][alert]] instead of message to get a stylized customizable notification interface for *Emacs*.

Usage exaples:

| =(alert "This is an alert")=                                    |
| =(alert "This is an alert" :severity 'high)=                    |
| =(alert "This is an alert" :severity 'trivial)=                 |
| =(alert "This is an alert" :title "My Alert")=                  |
| =(alert "This is an alert" :title "My Alert" :category 'debug)= |

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-system.el
;;
;; A enhanced notification interface
;;
(use-package alert
    :commands alert
    :config
        (setq alert-default-style 'message))
#+END_SRC

** Customizations

*Psimacs* uses a special file =custom.el= that it uses for writing customization code.
That should avoid always changing the =init.el= file.

You can always create a /custom-file/ by running command =customize-save-customized=.

References about customization:
- [[https://www.gnu.org/software/emacs/manual/html_node/emacs/Saving-Customizations.html][Saving Customizations]]
- [[https://www.emacswiki.org/emacs/CustomizingAndSaving][EmacsWiki: Customizing And Saving]]

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-system.el
;;
;; Handling of the customization file
;;
(setq custom-file psimacs/config/custom-file)

(if (file-exists-p psimacs/config/custom-file)
    (load custom-file)
)

(add-hook 'kill-emacs-query-functions 'custom-prompt-customize-unsaved-options)
#+END_SRC

** Encoding system

I am in no means an expert in Encoding systems. I have not studied all the variables floating in encoding soup.
Below you find the encoding settings that I have in use. Probably this is to much or even wrong. Sorry, for
that.

See also:
- [[https://www.emacswiki.org/emacs/ChangingEncodings][EmacsWiki: ChangingEncodings]]
- [[https://www.emacswiki.org/emacs/UnicodeEncoding][EmacsWiki: UnicodeEncoding]]
- [[http://ergoemacs.org/emacs/emacs_encoding_decoding_faq.html][Emacs File Encoding FAQ]]
- [[https://www.masteringemacs.org/article/working-coding-systems-unicode-emacs][Working with Coding Systems and Unicode in Emacs]]
- [[http://xahlee.info/comp/unicode_index.html][Unicode Characters]]
- [[https://rufflewind.com/2014-07-20/pasting-unicode-in-emacs-on-windows][Pasting Unicode characters in Emacs (Windows)]]

#+ATTR_HTML: :class styledtable
| Key binding | Command                                 | Description                                                                                                                                                                                                      |
|-------------+-----------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|             | =M-x revert-buffer-with-coding-system=  |                                                                                                                                                                                                                  |
|             | =M-x set-buffer-file-coding-system=     |                                                                                                                                                                                                                  |
|             | =M-x describe-coding-system=            | Information about coding system.                                                                                                                                                                                 |
|             | =M-x list-coding-systems=               |                                                                                                                                                                                                                  |
|             | =M-x find-file-literally=               | Open file without any conversion.                                                                                                                                                                                |
| =C-x RET c= | =M-x universal-coding-system-argument== | Ttakes as an argument the coding system you want to use, and a command to execute it with. That makes it possible to open files, shells or run Emacs commands as though you were using a different coding system. |
|-------------+-----------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|

See also content of variable =buffer-file-coding-system= by use of =C-h v=.

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-system.el
;;
;; Ensure that Emacs is totally UTF-8
;;
(set-charset-priority 'unicode)
(set-locale-environment "en_US.UTF-8")
(prefer-coding-system 'utf-8)
(set-default-coding-systems 'utf-8)
(set-terminal-coding-system 'utf-8)         ; configured by prefer-coding-system
(set-keyboard-coding-system 'utf-8)         ; configured by prefer-coding-system
(set-selection-coding-system 'utf-16-le)    ; important on windows os
(set-clipboard-coding-system 'utf-16-le)    ; included by set-selection-coding-system
(set-w32-system-coding-system 'utf-8)
(set-buffer-file-coding-system 'utf-8)      ; How to set a encoding system for saving file
(setq locale-coding-system 'utf-8)
(set-file-name-coding-system 'utf-8)
(set-language-environment "UTF-8")          ; How to permanently choose a encoding system in emacs for opening and saving
(setq default-process-coding-system '(utf-8-dos . utf-8-dos))
#+END_SRC

** Emacs server

[[https://www.gnu.org/software/emacs/manual/html_node/emacs/Emacs-Server.html][Using Emacs as a Server]] describes the details about configuration of an *Emacs server*. *Psimacs* uses a configuration
method that allows multiple different *Emacs's* be run simultaneously. However, only one can drive the *Emacs server*
at a time. *Psimacs* is configured in such a way that is starts the server only if no other *Emacs* instance exists
that does already run the server. /First come first serve/ principle. For that it uses the =EMACS_SERVER_FILE=
environment variable for server detection. If it is actually, the first one it sets the =EMACS_SERVER_FILE= variable
accordingly.

Caveat: This is only Windows OS specific and I do not know how to setup that on other systems.

References:
- [[https://www.gnu.org/software/emacs/manual/html_node/emacs/Emacs-Server.html][Using Emacs as a Server]]
- [[https://www.gnu.org/software/emacs/manual/html_node/emacs/TCP-Emacs-server.html#TCP-Emacs-server][TCP Emacs server]]
- [[https://www.gnu.org/software/emacs/manual/html_node/emacs/emacsclient-Options.html][emacsclient Options]]

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-server.el :var file-description="Emacs server setup"
;;
;; Initialize Emacs server if it is not already running.
;;
(defvar psimacs/config/found-server-file
   (getenv "EMACS_SERVER_FILE")
   "The active server file.")

(when (and psimacs/system/is-gui-flag
           psimacs/system/is-windows-nt-flag
           (or (not psimacs/config/found-server-file)
               (equal psimacs/config/found-server-file psimacs/config/server-file)))
   (start-process "SETX" nil "setx" "EMACS_SERVER_FILE" psimacs/config/server-file)
   (add-hook 'kill-emacs-hook
             (lambda ()
               (call-process "reg.exe" nil nil nil "delete" "HKCU\\Environment" "/v" "EMACS_SERVER_FILE" "/f")))

    (unless (file-directory-p psimacs/config/server-dir)
        (make-directory psimacs/config/server-dir t)
    )

    (require 'server)

    (unless (server-running-p)
        (defun server-ensure-safe-dir (dir) "Noop" t)   ; Suppress error "directory
                                                        ; ~/.emacs.d/server is unsafe"
                                                        ; on windows.

        (message "server-start")
        (server-start)
    )
)
#+END_SRC

** Look and feel

Explicit user interface setup, like look and feel or theming.

*** Basic user interface

No distracting splash screen or annoying startup message :-)

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-ui.el :var file-description="Basic user interface setup"
;;
;; No startup cludder
;;
(setq inhibit-startup-message t
      inhibit-startup-echo-area-message t
      inhibit-splash-screen t
)

;;
;; Get Emacs a bit more consistent, replace all yes or no questions with simple y or n.
;;
(fset 'yes-or-no-p 'y-or-n-p)

#+END_SRC

*** Bells

Avoid annoying bells as described in [[https://www.emacswiki.org/emacs/AlarmBell][Alarm Bell]] on [[https://www.emacswiki.org][EmacsWiki]].
The follwoing settings determines that *Emacs* should flash the mode line to represent a bell.

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-ui.el
;;
;; Flash mode line instead of bell
;;
(defun psimacs/config/flash-mode-line ()
  (invert-face 'mode-line)
  (run-with-timer 0.1 nil #'invert-face 'mode-line))

(setq visible-bell nil
      ring-bell-function 'psimacs/config/flash-mode-line)
#+END_SRC

*** Cursor

The cursor representation is described in [[https://www.gnu.org/software/emacs/manual/html_node/emacs/Cursor-Display.html][Displaying the Cursor]] and [[https://www.gnu.org/software/emacs/manual/html_node/elisp/Cursor-Parameters.html][Cursor Parameters]]. *Psimacs* just show a box
cursor in the active window only.

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-ui.el
;;
;; Cursor visible only in the active window
;;
(setq-default cursor-in-non-selected-windows nil)
;;(setq-default cursor-type 'bar)

(setq blink-cursor-delay    10
      blink-cursor-interval 0.7)
#+END_SRC

*** Highlight current line

As described in [[https://www.gnu.org/software/emacs/manual/html_node/emacs/Cursor-Display.html#index-highlight-current-line][Displaying the Cursor]] and in [[https://www.emacswiki.org/emacs/HighlightCurrentLine][WikiEmacs: HighlightCurrentLine]] *Psimacs* makes the cursor even more
visible, by the use of hl-line-mode, a minor mode that highlights the line containing point.

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-ui.el
;;
;; Highlight line containing point
;;
(use-package hl-line
    :straight nil
    :hook ((text-mode prog-mode) . hl-line-mode)
    ;;:config
        ;; (global-hl-line-mode 1)
        ;; (set-face-background 'hl-line "seashell2")

        ;; (set-face-attribute 'hl-line nil :background "gray21")
        ;; (set-face-background 'hl-line "seashell2")
)
#+END_SRC

*** Beacon, highlight line on scrolling

Whenever the window scrolls up or down a light will blink on your cursor with the help of the [[https://github.com/Malabarba/beacon][beacon]] package.

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-ui.el
;;
;; Highlight on scrolling
;;
(use-package beacon
    :diminish beacon-mode
    :config
        (beacon-mode 1)
        (setq beacon-push-mark 35)
        (setq beacon-color "#666600")
)
#+END_SRC

*** Yanking position

Do not yank at the mouse position but at cursor position.

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-ui.el
;;
;; Do not yank at the mouse position but at cursor position.
;;
(setq mouse-yank-at-point t)
#+END_SRC

*** Mode line: time and column information

Show time in the mode line with the usual dispay time format as is customary in my part of the world.

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-ui.el
;;
;; Show time on mode line
;;
(setq display-time-24hr-format t)
(display-time-mode 1)
#+END_SRC

Beside the row I'd also like to see the column in the mode line.

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-ui.el
;;
;; Show rows and columns in the mode line.
;;
(column-number-mode)
#+END_SRC

*** Scrolling

Do not centre the point before scrolling. Scroll one line at a time (less "jumpy" than defaults).
Scrolling is explained in [[https://www.gnu.org/software/emacs/manual/html_node/elisp/Textual-Scrolling.html#Textual-Scrolling][Textual Scrolling]] in the *Emacs* manual.

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-ui.el
;;
;; Scrolling: Adjust to your likening...
;;
(setq scroll-step 1                                ; keyboard scroll: one line at a time
      mouse-wheel-scroll-amount '(1 ((shift) . 1)) ; dito with wheel: one line at a time
      mouse-wheel-progressive-speed nil            ; don't accelerate scrolling
      mouse-wheel-follow-mouse 't                  ; scroll window under mouse
      scroll-conservatively 10000                  ; scroll one line at a time when you move the cursor past the top or bottom
      auto-window-vscroll nil
      scroll-preserve-screen-position nil          ; this is not windows like, i.e. quite foreign
      next-line-add-newlines nil                   ; Don't automatically add new lines when scrolling down at the bottom of a buffer.
)
#+END_SRC

*** Smooth Scrolling

The [[https://github.com/aspiers/smooth-scrolling][smooth-scrolling]] package offers a minor mode which make emacs scroll smoothly. It keeps the point away from
the top and bottom of the current buffer's window in order to keep lines of context around the point visible as
much as possible, whilst minimising the frequency of sudden scroll jumps which are visually confusing.

You can toogle the  [[https://github.com/aspiers/smooth-scrolling][smooth-scrolling-mode]] with the following command.

| Key binding     | Command                     | Description                                  |
|-----------------+-----------------------------+----------------------------------------------|
| =H-m C-w C-s s= | =M-x smooth-scrolling-mode= | Enable or disable the smooth scrolling mode. |
|-----------------+-----------------------------+----------------------------------------------|

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-ui.el
;;
;; ...or additionally/alternatively use the smooth-scrolling package
;;
(use-package smooth-scrolling
    :demand t
    :config (smooth-scrolling-mode 1)
    :bind (
         :map psimacs/config/global-key-map/special
              ("C-w C-s s" . smooth-scrolling-mode)
        )
)
#+END_SRC

*** Confirmation request

Avoid annoying confirmations in various situations as described in [[https://www.masteringemacs.org/article/disabling-prompts-emacs][Disabling Prompts in Emacs]].

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-ui.el
;;
;; Avoid annyoing conformations
;;
(setq confirm-nonexistent-file-or-buffer nil   ;; annoying confirmation if a file or buffer does not exist
                                               ;; when you use C-x C-f or C-x b
      ido-create-new-buffer 'always            ;; disabling the prompt that asks you if you want to create a
                                               ;; new buffer if you enter a non-existent buffer in C-x b
      kill-buffer-query-functions (remq        ;; do not asks if you want to kill a buffer with a live process attached
                                   'process-kill-buffer-query-function
                                   kill-buffer-query-functions)
)
#+END_SRC

Allow some things that emacs would otherwise liked to have confirmed.

E.g. be able to do =C-x C-u= / =C-x C-l= to upper/lowercase regions without confirmation.

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-ui.el
;;
;; Allow some things that emacs would otherwise liked to have confirmed.
;;
(put 'eval-expression  'disabled nil)
(put 'downcase-region  'disabled nil)
(put 'upcase-region    'disabled nil)
(put 'narrow-to-region 'disabled nil)
(put 'set-goal-column  'disabled nil)
#+END_SRC

*** Titlebar

Have the titlebar contain name and file name of the current buffer.

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-ui.el
;;
;; frame titelbar contains the name of the current buffer and the file name.
;;
(setq frame-title-format '("%b" (buffer-file-name ": %f")))
#+END_SRC

*** Automatically revert buffer

Whenever a file that *Psimacs* is editing has been changed by another program the user normally have to execute
the command =revert-buffer= to load the new content of the file into *Psimacs*. We will

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-ui.el
;;
;; Avoid handy revert-buffer calls
;;
(global-auto-revert-mode t)
#+END_SRC

*** Delete seleted text when typing.

This is standard behavior on the Windows Operating System platform.

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-ui.el
;;
;; Delete selected text when typing
;;
(delete-selection-mode 1)
#+END_SRC

*** Line numbering

*Psimacs* uses line numbering on default in many major modes.

See also: [[https://www.emacswiki.org/emacs/LineNumbers][EmacsWike: LineNumbers]] and the [[https://www.gnu.org/software/emacs/manual/html_node/emacs/Display-Custom.html][Emacs manual]].

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-ui.el
;;
;; Enable line numbers for almost all major-modes
;;
(require 'display-line-numbers)

(defcustom psimacs/config/display-line-numbers-exempt-modes
    '(  vterm-mode
        eshell-mode
        shell-mode
        term-mode
        ansi-term-mode
        org-mode
        neotree-mode
        dashboard-mode
    )
    "Major modes on which to disable the linum mode, exempts them from global requirement"
    :group 'display-line-numbers
    :type 'list
    :version "green"
)

;;
;; To disable this in certain major modes, redefine display-line-numbers--turn-on
;;
(defun display-line-numbers--turn-on ()
    "Turn on line numbers but excempting certain majore modes defined in
'psimacs/config/display-line-numbers-exempt-modes'"
    (if (and
            (not (member major-mode psimacs/config/display-line-numbers-exempt-modes))
                (not (minibufferp))
        )

        (display-line-numbers-mode)
    )
)

(global-display-line-numbers-mode 1)
#+END_SRC

*** Spaces between sentences

In my world, sentences end with a single space. This makes sentence navigation commands
work for me.

See also: [[https://www.gnu.org/software/emacs/manual/html_node/emacs/Sentences.html][Emacs Manual: Sentence]]

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-ui.el
;;
;; Sentence end with one space
;;
(setq sentence-end-double-space nil)
#+END_SRC

*** Fringes

On graphical displays, each Emacs window normally has narrow fringes (gutters/margins)
on the left and right edges. The fringes are used to display symbols that provide
information about the text in the window.

See the following references for fringes:
- [[https://www.gnu.org/software/emacs/manual/html_node/emacs/Fringes.html][Window Fringes]]
- [[https://emacsredux.com/blog/2015/01/18/customizing-the-fringes/][Customizing the Fringes]]
- [[https://www.flycheck.org/en/latest/user/error-reports.html][FlyCheck -> See errors in buffers -> Fringe and margin icons]]

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-ui.el
;;
;; Usually, fringes defaults to 8 pixel width
;;
(set-fringe-mode 8)
;;(defun my-tone-down-fringes ()
;;  (set-face-attribute 'fringe nil
;;                      :foreground (face-foreground 'default)
;;                      :background (face-background 'default)))
#+END_SRC

*** Scratch buffer

Show an empty scratch buffer on startup.

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-ui.el
;;
;; Show an empty scratch buffer on startup.
;;
(setq initial-scratch-message "")
#+END_SRC

*** Undo in commands :noexport:

Fix undo in commands affecting the mark.

See also:
- [[https://www.gnu.org/software/emacs/manual/html_node/elisp/The-Mark.html][The Mark -> mark-even-if-inactive]]
- Read also [[https://spwhitton.name/blog/entry/transient-mark-mode/][GNU Emacs' Transient Mark mode]]

Remark: I have canceled the following setting. I am unsure about the right setting.

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-ui.el
(setq mark-even-if-inactive nil)
#+END_SRC

*** No dialog boxes

[[https://www.gnu.org/software/emacs/manual/html_node/emacs/Dialog-Boxes.html][Using Dialog Boxes]] describes the variable =use-dialog-box=. If this is set to =nil= not dialog boxes appear for
/yes-or-no/ questions beside others special questions. This way *Emacs* always performs /yes-or-no/ prompts using
the echo area and keyboard input.

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-ui.el
;;
;; Prompts should go in the minibuffer, not in a GUI.
;;
(setq use-dialog-box nil)
#+END_SRC

*** Mark and Pop

Handy way of getting back to previous places.

Immediately after you type =C-u C-<SPC>=, you can type =C-<SPC>= instead of =C-u C-<SPC>= to
cycle through the mark ring.

From the [[https://www.gnu.org/software/emacs/manual/html_node/emacs/Mark-Ring.html][Emacs Manual: The Mark Ring]]:

#+BEGIN_QUOTE
Each buffer remembers previous locations of the mark, in the mark ring. Commands that set the mark also push the old
mark onto this ring. One of the uses of the mark ring is to remember spots that you may want to go back to.
#+END_QUOTE

#+ATTR_HTML: :class styledtable
| Key binding                     | Command                                    | Description                                                                                                                                                                                                                                             |
|---------------------------------+--------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| =C-SPC=, =C-@=                  | =M-x cua-set-mark=, =M-x set-mark-command= | Set mark at where point is, clear mark, or jump to mark. With no prefix argument, clear mark if already set. Otherwise, mark, and push old mark position on local mark ring; also push mark on global mark ring if last mark was set in another buffer. |
| =C-u C-SPC=, =C-u C-@=, =C-x p= | =M-x pop-to-mark-command=                  | Jump to mark, and pop a new position for mark off the local mark ring (this does not affect the global mark ring).                                                                                                                                      |
| =C-x C-@=                       | =M-x pop-global-mark=                      | Jump to a mark off the global mark ring.                                                                                                                                                                                                                |
| =C-SPC C-SPC=                   |                                            | Jumps to the next position off the local (or global) mark ring. Set the mark, pushing it onto the mark ring, without activating it.                                                                                                                     |
| =C-u C-u C-SPC=                 |                                            | Unconditionally set mark.                                                                                                                                                                                                                               |
|---------------------------------+--------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|

If you set =set-mark-command-repeat-pop= to non-nil, then immediately after you type =C-u C-SPC=, you can type =C-SPC=
instead of =C-u C-SPC= to cycle through the mark ring.

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-ui.el
;;
;; Handy way of getting back to previous places.
;;
(setq set-mark-command-repeat-pop t)
(bind-key "C-x p" 'pop-to-mark-command)
#+END_SRC

*** Indentation and Tab stops

[[https://www.gnu.org/software/emacs/manual/html_node/emacs/Indent-Convenience.html][Electric Indent mode]] is a global minor mode that automatically indents the line after every =<RET>= you type.
This mode is enabled by default, which we turn off.

Use instead:

| Key binding | Command                  | Description         |
|-------------+--------------------------+---------------------|
| =C-j=       | =M-x newline-and-indent= | Indent current line |

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-ui.el
;;
;; Matter of taste, do not automatically indent on <RET>
;;
(setq electric-indent-mode nil)
#+END_SRC

Do not use tab characters -> fill spaces instead.
Insert a real tab character with =C-q TAB=.

| Key binding | Command             | Description                                                                                     |
|-------------+---------------------+-------------------------------------------------------------------------------------------------|
| =C-q TAB=   | =M-x quoted-insert= | Read next input character (TAB) and insert it. This is useful for inserting control characters. |
|             |                     |                                                                                                 |

See also:
- [[https://www.emacswiki.org/emacs/IndentationBasics][Indentation Basics]]
- [[https://www.emacswiki.org/emacs/NoTabs][No Tabs]]
- [[https://www.emacswiki.org/emacs/TabsAreEvil][Tabs Are Evil]]
- [[http://ergoemacs.org/emacs/emacs_tabs_space_indentation_setup.html][Tabs, Space, Indentation Setup]]

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-ui.el
;;
;; Always insert space characters instead of tab characters.
;;
(setq-default indent-tabs-mode nil)
#+END_SRC

Use of standard tab width, that is the length of the =TAB= character.

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-ui.el
;;
;; We interpret a TAB character with a length of 8 space characters
;;
(setq-default tab-width 8)
#+END_SRC

Tab stop positions: =M-i=, i.e. =tab-to-tab-stop= moves to the next position.

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-ui.el
;;
;; This variable defines the tab stop columns used by tab-to-tab-stop.
;; A list of increasing integers, which need not be evenly spaced.
;; The list is implicitly extended to infinity through repetition of the interval
;; between the last and penultimate elements
;;
(setq tab-stop-list '(4 8))
#+END_SRC

*** Lock file

Disable creation of lock-files named =.#<filename>=. I do not have problem with simultaneous file editing.

See also:
- [[https://www.gnu.org/software/emacs/manual/html_node/emacs/Interlocking.html][Protection against Simultaneous Editing]]
- [[https://www.emacswiki.org/emacs/LockFiles][LockFiles]]

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-ui.el
;;
;; No lock-files named .#<filename>
;;
(setq-default create-lockfiles nil)
#+END_SRC

*** Newline at end

Last line automatically appending with newline as described in [[https://www.gnu.org/software/emacs/manual/html_node/emacs/Customize-Save.html][Customizing Saving of Files]] of the manual.

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-ui.el
;;
;; Yes, always add a final newline
;;
(setq require-final-newline t)
#+END_SRC

*** Case sensitive searches only on capitalization

By default, we want case sensitivity in searches and replaces to be smart.
That is, if your search doesn't use capital letters, *Emacs* will /ignore case/.
If it does, *Emacs* will be /case-sensitive/.

See also:
- [[https://www.gnu.org/software/emacs/manual/html_node/elisp/Searching-and-Case.html][Searching and Case]]
- [[https://www.emacswiki.org/emacs/CaseFoldSearch][Case Fold Search]]

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-ui.el
;;
;; Case sensitive searches only on capitalization
;;
(setq-default case-fold-search t)
#+END_SRC

*** Calendar

Weeks starts on Mondays.

References:
- [[https://www.gnu.org/software/emacs/manual/html_node/emacs/Calendar_002fDiary.html#Calendar_002fDiary][The Calendar and the Diary]]
- [[https://www.emacswiki.org/emacs/CalendarLocalization][Calendar Localization]]

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-ui.el
;;
;; Weeks starts on Mondays
;;
(setq calendar-week-start-day t)
#+END_SRC

** Backups

*Psimacs* does make backups, uses auto saving and provides minibuffer histories.

*** Backups

*Psimacs* uses a central [[https://www.gnu.org/software/emacs/manual/html_node/emacs/Backup.html#Backup][backup]] directory. I like to have a [[https://www.gnu.org/software/emacs/manual/html_node/emacs/Backup.html#Backup][backup]] on each save and with the correct relative
path below of my central backup directory. Each new backup file is created by appending a '~' character to
the orginal file name. If this file already exists in the backup location then this file is itself renamed
etc. until we can rename our original file.

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-backups.el :var file-description="Basic backup system setup"
;;
;; Provide the backup directory
;;
(unless (file-directory-p psimacs/config/backup-dir)
    (make-directory psimacs/config/backup-dir t)
)

;;
;; Handle backup files
;;
(defun psimacs/config/track-backup-files (bckFile &optional counter)
    "Rename or delete backup files.

Backup files are files appended by '~' charactes to the original file name.

If the bckFile already exists, then a new backup file name is generated and
the bckFile is accordingly renamed. If the counter argunment, however, exceeds
the value of the psimacs/config/backup-max-number-files configuration constants,
then the bckFile is removed instead.

This function calls itself recursively on the generated new backup file name
before taken any action. This way all existing backup files for the original
file are properly renamed of deleted."
    (if (file-exists-p bckFile)
        (let (
                (newbckFile (concat bckFile "~"))
            )

            (if (not counter)
                (setq counter 0)
                (setq counter (1+ counter))
            )

            (psimacs/config/track-backup-files newbckFile counter)

            (if (< counter psimacs/config/backup-max-number-files)
                (rename-file bckFile newbckFile)
                (delete-file bckFile)
            )
        )
    )
)

;;
;; Backup files are stored with path information
;;
(defun psimacs/config/backup-file-name (fpath)
    "Return a new file path of a given file path.

If the new path's directories does not exist, create them."
    (let* (
            (backupRootDir psimacs/config/backup-dir)
            (filePath (replace-regexp-in-string "\\(:\\|/cygdrive/\\)" "/" fpath ))
            (backupFilePath (replace-regexp-in-string "//" "/" (concat backupRootDir filePath "~")))
        )

        (unless (or
                (string-equal (expand-file-name fpath) (expand-file-name psimacs/config/recent-file))
                (string-equal (expand-file-name fpath) (expand-file-name psimacs/config/history-file))
                (string-equal (expand-file-name fpath) (expand-file-name psimacs/config/save-places-file))
                (string-equal (expand-file-name fpath) (expand-file-name psimacs/config/custom-file))
                (string-equal (expand-file-name fpath) (expand-file-name psimacs/config/amx-file))
            )

            (psimacs/config/track-backup-files backupFilePath)
        )

        (mkdir (file-name-directory backupFilePath) t)

        backupFilePath
    )
)

;;
;; Before safe the backup save marker is removed, leading to a new backup.
;;
(defun psimacs/config/force-backup-of-buffer ()
  "Clear backup save marker"
  (setq buffer-backed-up nil))

;;
;; Backup on each save
;;
(add-hook 'before-save-hook
          'psimacs/config/force-backup-of-buffer)

;;
;; Define how to make a backup
;;
(setq make-backup-file-name-function 'psimacs/config/backup-file-name)

;;
;; Backup files can be made by copying the old file or by renaming it
;;
(setq backup-by-copying t)
#+END_SRC

*** Auto-Save

[[https://www.gnu.org/software/emacs/manual/html_node/emacs/Auto-Save.html#Auto-Save][Autosave]] automatically saves each visited file in a separate file, without altering the file you actually use.
It uses a central [[https://www.gnu.org/software/emacs/manual/html_node/emacs/Auto-Save.html#Auto-Save][auto-save]] directory for that.

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-auto-save.el :var file-description="Basic auto saving system setup"
;;
;; Setup Psimacs auto-save strategy
;;
(let ((auto-save-dir psimacs/config/auto-save-dir))
    (unless (file-directory-p auto-save-dir)
        (make-directory auto-save-dir t)
    )

    (setq auto-save-default    t) ;; each time you visit a file, auto-saving is turned on
    (setq auto-save-interval 300) ;; specifies how many characters there are between auto-saves
    (setq auto-save-timeout   30) ;; also auto-save after 30 seconds of idleness

    (setq auto-save-list-file-prefix (concat auto-save-dir ".auto-saves-"))
    (setq auto-save-file-name-transforms `((".*" ,auto-save-dir t)))

    (setq-default tramp-auto-save-directory auto-save-dir)
)
#+END_SRC

*** Super-Save

[[https://github.com/bbatsov/super-save][Super-save]] additionally auto-saves your buffers, when certain events happen - e.g. you switch between buffers,
an Emacs frame loses focus, etc. You can think of it as both something that augments and replaces the standard
auto-save-mode.

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-auto-save.el
;;
;; And more automatic file saving :-)
;;
(use-package super-save
    :diminish super-save-mode
    :config
        (super-save-mode +1)
        (setq super-save-auto-save-when-idle t)
)
#+END_SRC

*** History

Package [[https://www.emacswiki.org/emacs/SaveHist][savehist]] automatically save minibuffer, kill-ring, search-ring and regexp-search-ring histories to a file.
It also deletes duplicates entries.

Package [[https://github.com/emacs-mirror/emacs/blob/master/lisp/savehist.el][savehist.el]] is available on [[https://github.com/emacs-mirror/emacs][emacs-mirror]].

| Key binding   | Command                            | Description                              |
|---------------+------------------------------------+------------------------------------------|
| =H-m C-c C-h= | (find-file-read-only history-file) | Open the history file in read-only mode. |
|---------------+------------------------------------+------------------------------------------|

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-auto-save.el
;;
;; Automatically save minibuffer, kill-ring, search-ring and regexp-search-ring histories
;;
(defun psimacs/history/visit-history-file ()
  "Open the save history file in buffer in read-only mode."
  (interactive)
  (when (file-exists-p psimacs/config/history-file)
    (find-file-read-only psimacs/config/history-file)))

(use-package savehist
    :straight nil
    :config
        (setq savehist-file psimacs/config/history-file)
        (savehist-mode 1)
        (setq history-length t)
        (setq history-delete-duplicates t)
        (setq savehist-save-minibuffer-history 1)
        (setq savehist-additional-variables
              '(kill-ring
                search-ring
                regexp-search-ring))
    :bind (
           :map psimacs/config/global-key-map/special
              ("C-c C-h" . psimacs/history/visit-history-file)
          )
)
#+END_SRC

*** Recent files

[[https://www.emacswiki.org/emacs/RecentFiles][Recentf-mode]] is a minor mode that builds a list of recently opened files. This list is automatically saved
across sessions on exiting *Emacs* - you can then access this list
through the command =C-x C-r=.

| Key binding | Command                         | Description                                                  |
|-------------+---------------------------------+--------------------------------------------------------------|
| =H-x r=     | =M-x recentf-open-files=        | Show a dialog to open a recent file.                         |
| =H-x C-r=   | =M-x recentf-open-more-files=   | Show a dialog to open a recent file that is not in the menu. |
|             | =M-x recentf-cleanup=           | Cleanup the recent file list.                                |
|-------------+---------------------------------+--------------------------------------------------------------|
| =H-x f=     | =M-x counsel-recentf=           | Find a file on recent file list.                             |
| =H-x C-f=   | =M-x counsel-buffer-or-recentf= | Find a buffer visiting a file or file on recent file list.   |
|-------------+---------------------------------+--------------------------------------------------------------|

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-auto-save.el
;;
;; Track recently visited files
;;
(use-package recentf
    :diminish recentf-mode
    :bind (
           :map psimacs/config/global-key-map/execute
              ("r"   . recentf-open-files)
              ("C-r" . recentf-open-more-files)
              ("f"   . counsel-recentf)
              ("C-f" . counsel-buffer-or-recentf)
        )

    :init
        (setq recentf-max-menu-items 20)
        (setq recentf-save-file psimacs/config/recent-file)

        (recentf-mode t)

        (run-at-time nil (* 5 60) 'recentf-save-list)
)
#+END_SRC

** Handling

This section provides setting and packages that enhance the user experience with *Emacs* considerably.

*** Edit region indirectly in another buffer

The package [[https://github.com/Fanael/edit-indirect][edit-indirect]] is a useful enhancement for editing. It provides a command =edit-indirect-region= that
allows the editing of a region in a separate buffer.

The region is copied, without text properties, to a separate buffer, called *edit-indirect buffer*. The major
is guessed.

After finishing the editing the command =edit-indirect-commit= replaces the original region with the content of
the *edit-indirect buffer*. Alternatively, the command =edit-indirect-abort= drops the modification and leaves the
region unchanged. Very useful!

| Key binding | Command                    | Description                                                                                       |
|-------------+----------------------------+---------------------------------------------------------------------------------------------------|
| =H-c C-e=   | =M-x edit-indirect-region= | Edit region in separate buffer *edit-indirect buffer*                                             |
| =C-c C-c=   | =M-x edit-indirect-commit= | Commit the modification done in *edit-indirect buffer*                                            |
| =C-c C-k=   | =M-x edit-indirect-abort== | Abort indirect editing; kill buffer *edit-indirect buffer*                                        |
| =C-x C-s=   | =M-x edit-indirect-save=   | Replace the original region in the parent buffer with the contents of the *edit-indirect buffer*. |
|-------------+----------------------------+---------------------------------------------------------------------------------------------------|

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-handling.el :var file-description="Basic handling setup"
;;
;; Edit regions in a separate buffer
;;
(use-package edit-indirect
  :bind (
         :map psimacs/config/global-key-map/common
              ("C-e" . edit-indirect-region)
        )
)
#+END_SRC

*** First errors in compilation buffer

[[https://www.gnu.org/software/emacs/manual/html_node/emacs/Compilation.html][Running Compilations under Emacs]] describes a useful variable that allows that scrolling of the compilation output
automatically stops when the first error appears, leaving point at that error.

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-handling.el
;;
;; Stop at first error, no further scrolling
;;
(setq compilation-scroll-output 'first-error)
#+END_SRC

*** Apropos

Each of the [[https://www.gnu.org/software/emacs/manual/html_node/emacs/Apropos.html][apropos]] commands reads an apropos pattern in the minibuffer, searches for items that match the pattern,
and displays the results in a different window. Some of them use prefix arguments to widen the scope of the search.
The follwoing statement let most of the apropos commands behaves as if they had been given a prefix argument.

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-handling.el
;;
;; Always prefix apropos commands
;;
(setq apropos-do-all t)
#+END_SRC

*** Unique buffer names

Change [[https://www.gnu.org/software/emacs/manual/html_node/emacs/Uniquify.html][uniquify]] to put the disambiguate part of the buffer file name at the front. The library  [[https://www.gnu.org/software/emacs/manual/html_node/emacs/Uniquify.html][uniquify]]
overrides *Emacs*'s default mechanism for making buffer names unique (using suffixes like <2>, <3> etc.)
with a more sensible behavior which use parts of the file names to make the buffer names distinguishable.

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-handling.el
;;
;; Unique buffer names: includes part of the file's directory name at the beginning of the buffer name
;;
(require 'uniquify)
(setq uniquify-buffer-name-style 'forward)
#+END_SRC

*** Imortal buffers

Some buffers should never be deleted. Even if you type =C-x k= in them.

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-handling.el
;;
;; Make some buffers immortal
;;
(defun psimacs/config/immortal-buffers ()
    (if (or (eq (current-buffer) (get-buffer "*scratch*"))
            (eq (current-buffer) (get-buffer "*Messages*")))
                (progn (bury-buffer)
                    nil)
        t
    )
)

(add-hook 'kill-buffer-query-functions 'psimacs/config/immortal-buffers)
#+END_SRC

*** Improved Info-Mode

Library [[https://www.emacswiki.org/emacs/InfoPlus][Info Plus]] extends the standard Emacs library /info/ in several ways.

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-handling.el
(use-package info+)
#+END_SRC

*** Parenthesis

**** Automatically insert matching bracket :noexport:

When on, typing any left bracket automatically insert the right matching bracket. This is accomplished by *Emacs*'s
[[https://www.gnu.org/software/emacs/manual/html_node/emacs/Matching.html][electric-pair-mode]].

At the moment I have disabled it, because I would like to try [[http://ergoemacs.org/emacs/emacs.html][Xah Lee]] alternative to the [[https://www.gnu.org/software/emacs/manual/html_node/emacs/Matching.html][electric-pair-mode]].
Actually, I always had some problems with the  [[https://www.gnu.org/software/emacs/manual/html_node/emacs/Matching.html][electric-pair-mode]].

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-handling.el
;;
;; electric-pair-mode: automatically insert matching bracket.
;;
(setq electric-pair-inhibit-predicate 'electric-pair-conservative-inhibit)
(electric-pair-mode 1)
#+END_SRC

**** Insert brackets by pair

The following code [[http://ergoemacs.org/emacs/elisp_insert_brackets_by_pair.html][Emacs: Insert Brackets by Pair]] is taken from [[http://ergoemacs.org/emacs/emacs.html][Xah Lee]]. It tries to solve some of the
problems that arise with [[https://www.gnu.org/software/emacs/manual/html_node/emacs/Matching.html][electric-pair-mode]].

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-handling.el
;;
;; Wonderful bracket inserter taken from Xah Lee at
;; http://ergoemacs.org/emacs/elisp_insert_brackets_by_pair.html
;;
(defun psimacs/pair/insert-bracket-pair (@left-bracket @right-bracket &optional @wrap-method)
  "Insert brackets around selection, word, at point, and maybe move cursor in between.

 ,*left-bracket and *right-bracket are strings.
 ,*wrap-method must be either 'line or 'block. 'block means between empty lines.

• if there's a region, add brackets around region.
• if *wrap-method is 'line, wrap around line.
• if *wrap-method is 'block, wrap around block.
• if cursor is at beginning of line and its not empty line and contain at least 1 space, wrap around the line.
• if cursor is at end of a word or buffer, one of the following will happen:
        xyz▮ → xyz(▮)
        xyz▮ → (xyz▮) if in one of the lisp modes.
• wrap brackets around word if any. e.g. xy▮z → (xyz▮). Or just (▮)

URL `http://ergoemacs.org/emacs/elisp_insert_brackets_by_pair.html'
Version 2017-01-17"
  (if (use-region-p)
      (progn ; there's active region
        (let (
              ($p1 (region-beginning))
              ($p2 (region-end)))
          (goto-char $p2)
          (insert @right-bracket)
          (goto-char $p1)
          (insert @left-bracket)
          (goto-char (+ $p2 2))))
    (progn ; no text selection
      (let ($p1 $p2)
        (cond
         ((eq @wrap-method 'line)
          (setq $p1 (line-beginning-position) $p2 (line-end-position))
          (goto-char $p2)
          (insert @right-bracket)
          (goto-char $p1)
          (insert @left-bracket)
          (goto-char (+ $p2 (length @left-bracket))))
         ((eq @wrap-method 'block)
          (save-excursion
            (progn
              (if (re-search-backward "\n[ \t]*\n" nil 'move)
                  (progn (re-search-forward "\n[ \t]*\n")
                         (setq $p1 (point)))
                (setq $p1 (point)))
              (if (re-search-forward "\n[ \t]*\n" nil 'move)
                  (progn (re-search-backward "\n[ \t]*\n")
                         (setq $p2 (point)))
                (setq $p2 (point))))
            (goto-char $p2)
            (insert @right-bracket)
            (goto-char $p1)
            (insert @left-bracket)
            (goto-char (+ $p2 (length @left-bracket)))))
         ( ;  do line. line must contain space
          (and
           (eq (point) (line-beginning-position))
           ;; (string-match " " (buffer-substring-no-properties (line-beginning-position) (line-end-position)))
           (not (eq (line-beginning-position) (line-end-position))))
          (insert @left-bracket )
          (end-of-line)
          (insert  @right-bracket))
         ((and
           (or ; cursor is at end of word or buffer. i.e. xyz?
            (looking-at "[^-_[:alnum:]]")
            (eq (point) (point-max)))
           (not (or
                 (string-equal major-mode "emacs-lisp-mode")
                 (string-equal major-mode "lisp-mode")
                 (string-equal major-mode "lisp-interaction-mode")
                 (string-equal major-mode "common-lisp-mode")
                 (string-equal major-mode "clojure-mode")
                 (string-equal major-mode "scheme-mode"))))
          (progn
            (setq $p1 (point) $p2 (point))
            (insert @left-bracket @right-bracket)
            (search-backward @right-bracket )))
         (t (progn
              ;; wrap around 'word'. basically, want all alphanumeric, plus hyphen and underscore, but don't want space or punctuations.
              (skip-chars-backward "-_[:alnum:]")
              (setq $p1 (point))
              (skip-chars-forward "-_[:alnum:]")
              (setq $p2 (point))
              (goto-char $p2)
              (insert @right-bracket)
              (goto-char $p1)
              (insert @left-bracket)
              (goto-char (+ $p2 (length @left-bracket))))))))))
#+END_SRC

And some convenience functions that use the =psimacs/pair/insert-bracket-pair= function.

Additionally, *Psimacs* provides the following key bindings:

| Key binding | Command                                      | Description                       |
|-------------+----------------------------------------------+-----------------------------------|
| =H-m (=     | =M-x psimacs/pair/insert-paren=              | Insert paranthesis =(▮)=.         |
| =H-m [=     | =M-x psimacs/pair/insert-bracket=            | Insert brackets =[▮]=.            |
| =H-m {=     | =M-x psimacs/pair/insert-brace=              | Insert braces ={▮}=.              |
| =H-m "=     | =M-x psimacs/pair/insert-ascii-double-quote= | Insert ascii double quotes ="▮"=. |
| =H-m '=     | =M-x psimacs/pair/insert-ascii-single-quote= | Insert ascii single quotes ='▮'=. |
| =H-m e=     | =M-x psimacs/pair/insert-emacs-quote=        | Insert emacs quotes =`▮'=.        |
| =H-m ==     | =M-x psimacs/pair/insert-equal=              | Insert equality signs ==▮==.      |
| =H-m *=     | =M-x psimacs/pair/insert-star=               | Insert stars =*▮*=.               |
| =H-m /=     | =M-x psimacs/pair/insert-slash=              | Insert slashes =/▮/=.             |
|-------------+----------------------------------------------+-----------------------------------|

Remark: The HTML rendering on GitHub is not correct. With normal HTML export of *Emacs*'s Org-Mode, however, the
rendering is perfectly fine. I couldn't resolve the issue.

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-handling.el
;;
;; Convenience functions using psimacs/pair/insert-bracket-pair
;;
(defun psimacs/pair/insert-paren                    () "Insert paranthesis (▮)"                (interactive) (psimacs/pair/insert-bracket-pair "("  ")"))
(defun psimacs/pair/insert-bracket                  () "Insert brackets [▮]"                   (interactive) (psimacs/pair/insert-bracket-pair "["  "]"))
(defun psimacs/pair/insert-brace                    () "Insert braces {▮}"                     (interactive) (psimacs/pair/insert-bracket-pair "{"  "}"))
(defun psimacs/pair/insert-double-curly-quote       () "Insert double curly quotes “▮“"        (interactive) (psimacs/pair/insert-bracket-pair "“"  "”"))
(defun psimacs/pair/insert-curly-single-quote       () "Insert curly single quotes ‘▮‘"        (interactive) (psimacs/pair/insert-bracket-pair "‘"  "’"))
(defun psimacs/pair/insert-single-angle-quote       () "Insert single angle quotes ‹▮›"        (interactive) (psimacs/pair/insert-bracket-pair "‹"  "›"))
(defun psimacs/pair/insert-double-angle-quote       () "Insert double angle quotes «▮»"        (interactive) (psimacs/pair/insert-bracket-pair "«"  "»"))
(defun psimacs/pair/insert-ascii-double-quote       () "Insert ascii double quotes \"▮\""      (interactive) (psimacs/pair/insert-bracket-pair "\"" "\""))
(defun psimacs/pair/insert-ascii-single-quote       () "Insert ascii single quotes '▮'"        (interactive) (psimacs/pair/insert-bracket-pair "'"  "'"))
(defun psimacs/pair/insert-emacs-quote              () "Insert emacs quotes `▮'"               (interactive) (psimacs/pair/insert-bracket-pair "`"  "'"))
(defun psimacs/pair/insert-corner-bracket           () "Insert corner brackets 「▮」"           (interactive) (psimacs/pair/insert-bracket-pair "「"  "」"))
(defun psimacs/pair/insert-white-corner-bracket     () "Insert white corner brackets 『▮』"     (interactive) (psimacs/pair/insert-bracket-pair "『"  "』"))
(defun psimacs/pair/insert-angle-bracket            () "Insert angle brackets 〈▮〉"            (interactive) (psimacs/pair/insert-bracket-pair "〈"  "〉"))
(defun psimacs/pair/insert-double-angle-bracket     () "Insert double angle brackets 《▮》"     (interactive) (psimacs/pair/insert-bracket-pair "《"  "》"))
(defun psimacs/pair/insert-white-lenticular-bracket () "Insert white lenticular brackets 〖▮〗" (interactive) (psimacs/pair/insert-bracket-pair "〖" "〗"))
(defun psimacs/pair/insert-black-lenticular-bracket () "Insert black lenticular brackets 【▮】" (interactive) (psimacs/pair/insert-bracket-pair "【"  "】"))
(defun psimacs/pair/insert-tortoise-shell-bracket   () "Insert tortoise shell brackets 〔▮〕"   (interactive) (psimacs/pair/insert-bracket-pair "〔"  "〕"))
(defun psimacs/pair/insert-equal                    () "Insert equality sign =▮="              (interactive) (psimacs/pair/insert-bracket-pair "="  "="))
(defun psimacs/pair/insert-star                     () "Insert star characters *▮*"            (interactive) (psimacs/pair/insert-bracket-pair "*"  "*"))
(defun psimacs/pair/insert-slash                    () "Insert slash characters /▮/"           (interactive) (psimacs/pair/insert-bracket-pair "/"  "/"))
#+END_SRC

Define key bindings for the most important =psimacs/pair/insert-*= commands only.

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-handling.el
;;
;; Add the missing key bindings for the frame creation strategy promised above.
;;
(define-key psimacs/config/global-key-map/special (kbd "(")  'psimacs/pair/insert-paren)
(define-key psimacs/config/global-key-map/special (kbd "[")  'psimacs/pair/insert-bracket)
(define-key psimacs/config/global-key-map/special (kbd "{")  'psimacs/pair/insert-brace)
(define-key psimacs/config/global-key-map/special (kbd "\"") 'psimacs/pair/insert-ascii-double-quote)
(define-key psimacs/config/global-key-map/special (kbd "'")  'psimacs/pair/insert-ascii-single-quote)
(define-key psimacs/config/global-key-map/special (kbd "e")  'psimacs/pair/insert-emacs-quote)
(define-key psimacs/config/global-key-map/special (kbd "=")  'psimacs/pair/insert-equal)
(define-key psimacs/config/global-key-map/special (kbd "*")  'psimacs/pair/insert-star)
(define-key psimacs/config/global-key-map/special (kbd "/")  'psimacs/pair/insert-slash)
#+END_SRC

See matching pairs of parenthesis and other characters. When point is on one of the
paired characters, the other is highlighted.

See also: [[https://www.gnu.org/software/emacs/manual/html_node/emacs/Matching.html#Matching][show-paren-mode]]

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-handling.el
;;
;; Highlight matching pairs
;;
(use-package paren
    :diminish show-paren-mode
    :hook (after-init . show-paren-mode)
    :config
        (setq show-paren-delay 0)
        (setq show-paren-style 'mixed)
        ;(setq show-paren-style 'parenthesis)
        ;(setq show-paren-style 'expression)

        (setq show-paren-when-point-inside-paren t)
        (setq show-paren-when-point-in-periphery t)
)
#+END_SRC

*** Buffer List

Use command =ibuffer= instead of the default =list-buffers= for =C-x C-b=. The command =ibuffer= is an improved
version of =list-buffers=. *IBuffer* colors the files by type and [[http://ergoemacs.org/emacs/emacs.html][Xah Lee]] introduces it in [[http://ergoemacs.org/emacs/emacs_buffer_management.html][Emacs: List Buffers]].

| Key binding | Command                | Description                                    |
|-------------+------------------------+------------------------------------------------|
| =C-x C-b=   | =M-x ibuffer=          | Begin using IBuffer to edit a list of buffers. |
| =C-x b=     | =M-x switch-to-buffer= | Switch to buffer, selected from list.          |
| =C-x k=     | =M-x kill-buffer=      | Close the current buffer.                      |
|             |                        |                                                |


#+BEGIN_SRC emacs-lisp :tangle config/init-basic-handling.el
;;
;; Completely replace list-buffers by ibuffer. Implies automatically ibuffer on C-x C-b
;;
(defalias 'list-buffers 'ibuffer)
;;(global-set-key (kbd "C-x C-b") 'ibuffer)
#+END_SRC

*** Cua Mode

When [[https://www.gnu.org/software/emacs/manual/html_node/emacs/CUA-Bindings.html][CUA mode]] is enabled, the keys =C-x=, =C-c=, =C-v=, and =C-z= invoke commands that cut (kill),
copy, paste (yank), and undo respectively.

To enter an *Emacs* command like =C-x C-f= while the mark is active, use one of the following
methods:
- either hold Shift together with the prefix key, e.g., =S-C-x C-f=,
- or quickly type the prefix key twice, e.g., =C-x C-x C-f=
- or disable [[https://www.gnu.org/software/emacs/manual/html_node/emacs/CUA-Bindings.html][CUA mode]] by pressing =<f12>= or =H-m c=.

[[https://www.gnu.org/software/emacs/manual/html_node/emacs/CUA-Bindings.html][CUA mode]] provides enhanced rectangle support with visible rectangle highlighting.
Use =C-<RET>= to start a rectangle, extend it using the movement commands, and cut or copy
it using =C-x= or =C-c=. =<RET>= moves the cursor to the next (clockwise) corner of the rectangle,
so you can easily expand it in any direction. Normal text you type is inserted to the left
or right of each line in the rectangle (on the same side as the cursor).

With CUA you can easily copy text and rectangles into and out of registers by providing a
one-digit numeric prefix to the kill, copy, and yank commands, e.g., =C-1 C-c= copies the
region into register 1, and =C-2 C-v= yanks the contents of register 2.

CUA mode also has a global mark feature which allows easy moving and copying of text
between buffers. Use =C-S-<SPC>= to toggle the global mark on and off. When the global
mark is on, all text that you kill or copy is automatically inserted at the global
mark, and text you type is inserted at the global mark rather than at the current
position.

See also:
- [[http://www.gnu.org/software/emacs/manual/html_node/emacs/CUA-Bindings.html][Manual: Cua-Bindings]],
- [[https://www.emacswiki.org/emacs/CuaMode][EmacsWiki: Cua Mode]],
- [[https://emacs.stackexchange.com/questions/26874/what-am-i-giving-up-by-activating-cua-mode][What am I giving up by activating CUA mode?]]
- [[http://ergoemacs.org/misc/emacs_keybinding_and_cua-mode_keys.html][Emacs cua-mode Key Binding Problems]]

| Key binding | Command                      | Description                                  |
|-------------+------------------------------+----------------------------------------------|
| =<f12>=     | =M-x cua-mode=               | Toggle CUA mode.                             |
| =H-m c=     | =M-x cua-mode=               | Toggle CUA mode.                             |
|-------------+------------------------------+----------------------------------------------|
| =C-x=       |                              | Windows conform cut if CUA-mode is active.   |
| =C-c=       |                              | Windows conform copy if CUA-mode is active.  |
| =C-v=       |                              | Windows conform paste if CUA-mode is active. |
| =C-z=       |                              | Undo command if CUA-mode is active.          |
| =C-S-z=     |                              | Redo command if CUA-mode is active.          |
|-------------+------------------------------+----------------------------------------------|
| =C-<RET>=   | =M-x cua-set-rectangle-mark= | Start a rectangle.                           |
| =<Ret>=     | =M-x cua-rotate-rectangle=   | Move to next corner.                         |
| =C-1 C-c=   |                              | Copy rectangle to register 1                 |
| =...=       |                              | ...                                          |
| =C-9 C-c=   |                              | Copy rectangle to register 9                 |
| =C-1 C-x=   |                              | Cut rectangle to register 1                  |
| =...=       |                              | ...                                          |
| =C-9 C-x=   |                              | Cut rectangle to register 9                  |
| =C-1 C-v=   |                              | Yank rectangle from register 1               |
| =...=       |                              | ...                                          |
| =C-9 C-v=   |                              | Yank  rectangle from register 9              |
|             |                              |                                              |

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-handling.el
;;
;; CUA-Mode: Enabled on default
;;
(cua-mode t)
(setq cua-auto-tabify-rectangles nil) ;; Don't tabify after rectangle commands
(setq cua-keep-region-after-copy t)   ;; Standard Windows behaviour
(setq cua-delete-selection t)
(global-set-key (kbd "<f12>") 'cua-mode)
(define-key psimacs/config/global-key-map/special (kbd "c") 'cua-mode)
#+END_SRC

*** Perspective

The [[https://github.com/nex3/perspective-el][perspective]] package provides multiple named workspaces
(or "perspectives") in *Emacs*, similar to multiple desktops in window managers.

Each [[https://github.com/nex3/perspective-el][perspective]] has its own buffer list and its own window
layout. This makes it easy to work on many separate projects without getting lost in all the buffers.
Switching to a [[https://github.com/nex3/perspective-el][perspective]] activates its window configuration,
and when in a [[https://github.com/nex3/perspective-el][perspective]], only its buffers
are available (by default).

Each *Emacs* frame has a distinct list of [[https://github.com/nex3/perspective-el][perspectives]].

Commands are all prefixed by =C-x x= by default. To change the prefix key, customize =persp-mode-prefix-key=.
Additionally, creating a key binding for =persp-mode-map= will also activate the prefix.

#+ATTR_HTML: :class styledtable
| Key binding     | Command                      | Description                                                                                         |
|-----------------+------------------------------+-----------------------------------------------------------------------------------------------------|
| =C-x x=         |                              | Prefix key for all perspective commands.                                                            |
| =C-x x s=       | =M-x persp-switch=           | Query a perspective to switch to, or create                                                         |
| =C-x x k=       | =M-x persp-remove-buffer=    | Query a buffer to remove from current perspective                                                   |
| =C-x x c=       | =M-x persp-kill=             | Query a perspective to kill                                                                         |
| =C-x x r=       | =M-x persp-rename=           | Rename current perspective                                                                          |
| =C-x x a=       | =M-x persp-add-buffer=       | Query an open buffer to add to current perspective                                                  |
| =C-x x A=       | =M-x persp-set-buffer=       | Add buffer to current perspective and remove it from all others                                     |
| =C-x x b=       | =M-x persp-switch-to-buffer= | Like switch-to-buffer; includes all buffers from all perspectives; changes perspective if necessary |
| =C-x x i=       | =M-x persp-import=           | Import a given perspective from another frame.                                                      |
| =C-x x n=       | =M-x persp-next=             | Switch to next perspective                                                                          |
| =C-x x p=       | =M-x persp-prev=             | Switch to previous perspective                                                                      |
| =C-x x <right>= | =M-x persp-next=             | Switch to next perspective                                                                          |
| =C-x x <left>=  | =M-x persp-prev=             | Switch to previous perspective                                                                      |
| =C-x x C-s=     | =M-x persp-state-save=       | Save all perspectives in all frames to a file                                                       |
| =C-x x C-l=     | =M-x persp-state-load=       | Load all perspectives from a file                                                                   |
|-----------------+------------------------------+-----------------------------------------------------------------------------------------------------|

Since [[https://github.com/nex3/perspective-el][perspective]]  maintains distinct buffer lists for each [[https://github.com/nex3/perspective-el][perspective]], it helps to use a
Perspective-aware buffer switcher.

| Buffer switcher | Support                                                                                                                                                                                                                                                                                                                        |
|-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Ido             | Interactive Do (Ido, ido-mode), in particular its ido-switch-buffer command, is automatically Perspective-aware when =persp-mode= is enabled.                                                                                                                                                                                  |
| bs.el           | Perspective provides a wrapper for bs-show: =persp-bs-show=. When this function is called normally, it shows a list of buffers filtered by the current perspective. With a prefix argument, it shows a list of buffers in all perspectives.                                                                                    |
| IBuffer         | Perspective provides a wrapper for ibuffer: =persp-ibuffer=. When this function is called normally, it shows a list of buffers filtered by the current perspective. With a prefix argument, it shows a list of buffers in all perspectives.                                                                                    |
| Helm            | Perspective ships with buffer-listing advice for Helm, so Helm's buffer listing code should be automatically Perspective-aware when =persp-mode= is enabled.                                                                                                                                                                   |
| Ivy / Counsel   | Perspective provides two commands for listing buffers using Ivy and Counsel: =persp-ivy-switch-buffer= and =persp-counsel-switch-buffer=. When these functions are called normally, they show a list of buffers filtered by the current perspective. With a prefix argument, they shows a list of buffers in all perspectives. |
|                 |                                                                                                                                                                                                                                                                                                                                |
|-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|

Currently, *Psimacs* has not enabled [[https://github.com/nex3/perspective-el][perspective]] on default. I have to think about its usefulness for my working habit.

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-handling.el
(use-package perspective
  :bind (
         ("C-x b" . persp-switch-to-buffer*)
         ("C-x k" . persp-kill-buffer*)
         )
;  :config
;      (persp-mode)
  )
#+END_SRC

*** Abbreviations

*Emacs's* [[https://www.gnu.org/software/emacs/manual/html_node/emacs/Abbrevs.html][Abbrevs]] feature lets you type a short word and expand into a full word or code template.

Emacs has a nice feature to expand abbreviations. If for example, you wanted
an abbreviation for 'Your Name' to be 'yn', just type 'yn' and with your point
after the 'n' do =C-x a i g= (mnemonic add inverse global) and enter the expansion,
in this case 'Your Name'. In the future, whenever you type 'yn' your name will be
inserted. The abbrevs are automatically saved between sessions in a file.

If you don't like an abbrev that you have set up, then do =M-x edit-abbrevs=.
You can have different abbrevs for each mode (cperl, c++, Message);
the g in =C-x a i g= is for global, meaning every mode.

Suppose you want to define "bg" for "background": Type =M-x add-global-abbrev=, i.e. =C-x a g= and
then type "bg" in the prompt. Now, when you type "bg" followed by a space or return, it will expand
to "background".

If you want the [[https://www.gnu.org/software/emacs/manual/html_node/emacs/Abbrevs.html][abbrev]] only
for the current major mode: Type =M-x add-mode-abbrev=, i.e. =C-x a l= ...

If the expanded text is more than one word, for example, suppose you want to define "faq" for
"frequently asked questions". Type "frequently asked questions", then select the text and do
=C-u C-x a g= rspl. =C-u C-x a l=.

Remove an abbreviation by =C-u -1 C-x a g= rspl. =C-u -1 C-x a l= followed by the memnomic, e.g. "bg".

Other commands: =M-x list-abbrevs=, =M-x edit-abbrevs=, =M-x edit-abbrevs-redefine=, =M-x abbrev-edit-save-buffe=
and =M-x abbrev-edit-save-to-file=.

Additionally, =M-x read-abbrev-file= and =M-x write-abbrev-file=.

| Key binding      | Command                         | Description                                                           |
|------------------+---------------------------------+-----------------------------------------------------------------------|
| =H-m C-x C-a=    | =M-x abbrev-mode=               | Enable/Disable abbreviation mode.                                     |
|------------------+---------------------------------+-----------------------------------------------------------------------|
| =C-x a i g=      | =M-x inverse-add-global-abbrev= | add inverse global abbreviation, i.e. 'yn'→ =C-x a i g= → 'Your Name' |
| =C-x a g=        | =M-x add-global-abbrev=         | add global abbreviation, i.e. 'Name' → =C-x a g= → 'n'                |
| =C-u C-x a g=    | =M-x add-global-abbrev=         | add region global abbreviation, i.e. 'Your Name' → =C-x a g= → 'yn'   |
| =C-u -1 C-x a g= |                                 | remove global abbreviation, i.e. 'yn'                                 |
|------------------+---------------------------------+-----------------------------------------------------------------------|
| =C-x a i l=      | =M-x inverse-add-mode-abbrev=   | add inverse mode abbreviation, i.e. 'yn'→ =C-x a i l= → 'Your Name'   |
| =C-x a l=        | =M-x add-mode-abbrev=           | add mode abbreviation, i.e. 'Name' → =C-x a l= → 'n'                  |
| =C-u C-x a l=    | =M-x add-mode-abbrev=           | add mode abbreviation, i.e. 'Your Name' → =C-x a l= → 'yn'            |
| =C-u -1 C-x a l= |                                 | remove mode abbreviation, i.e. 'yn'                                   |
|------------------+---------------------------------+-----------------------------------------------------------------------|
|                  | =M-x edit-abbrevs=              |                                                                       |
|                  | =M-x edit-abbrevs-redefine=     |                                                                       |
|                  | =M-x list-abbrevs=              |                                                                       |
|                  | =M-x abbrev-edit-save-buffer=   |                                                                       |
|                  | =M-x abbrev-edit-save-to-file=  |                                                                       |
|------------------+---------------------------------+-----------------------------------------------------------------------|

See also:
- [[https://www.emacswiki.org/emacs/AbbrevMode][Abbrev-Mode]]
- [[http://ergoemacs.org/emacs/emacs_abbrev_mode.html][Abbrev Mode]]
- [[http://ergoemacs.org/emacs/emacs_abbrev_mode_tutorial.html][Abbrev Mode Tutorial]]

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-handling.el
;;
;; Setup the abbreviation facility.
;;
(use-package abbrev
  :straight nil
  :bind (
         :map psimacs/config/global-key-map/special
              ("C-x C-a" . abbrev-mode)
         )
  :init
      (dim-minor-name 'abbrev-mode "?𝓐")

      (setq save-abbrevs 'silently)
      (setq abbrev-file-name psimacs/config/abbrev-file)
      (if (file-exists-p psimacs/config/abbrev-file)
          (quietly-read-abbrev-file psimacs/config/abbrev-file))
)
#+END_SRC

*** Save cursor places

We save the current cursor position for use in the next session on a per file/buffer basis.

See also:
- [[https://www.emacswiki.org/emacs/SavePlace][EmacsWiki: SavePlace]]
- [[http://ergoemacs.org/emacs/emacs_save_cursor_position.html][Emacs: Save Cursor Position]]
- [[https://github.com/emacs-mirror/emacs/blob/master/lisp/saveplace.el][Emacs mirror: saveplace.el]]

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-handling.el
(use-package saveplace
    :straight nil
    :diminish save-place-mode
    :config
        (progn
            (setq save-place-file psimacs/config/save-places-file)
            (setq save-place-forget-unreadable-files nil)
            (save-place-mode 1)
        )
)
#+END_SRC

*** Hex file modes

Associate certain binary files to hexl-mode.

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-handling.el
(setq auto-mode-alist
    (append '(("\\.\\(obj\\|exe\\|dll\\|com\\)$" . hexl-mode)) auto-mode-alist)
)
#+END_SRC

** Windows and frame layout

*** Frame size and position

Add key bindings for the frame creation strategy commands, as promised in the [[Startup frame size and position][Startup frame size and position]] section.

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-layout.el :var file-description="Basic layout setup"
;;
;; Add the missing key bindings for the frame creation strategy promised above.
;;
(define-key psimacs/config/global-key-map/special (kbd "C-w C-x 5 l") 'psimacs/window/set-frame-creation-strategy-layout)
(define-key psimacs/config/global-key-map/special (kbd "C-w C-x 5 m") 'psimacs/window/set-frame-creation-strategy-main)
(define-key psimacs/config/global-key-map/special (kbd "C-w C-x 5 s") 'psimacs/window/set-frame-creation-strategy-system)
#+END_SRC

*** Golden-Ratio for new buffers

The package [[https://github.com/roman/golden-ratio.el][Golden-Ratio]] provides the /golden-ratio-mode/ that will automatically adjust buffers sizes to keep
the golden ration.

| Key binding   | Command                 | Description                                         |
|---------------+-------------------------+-----------------------------------------------------|
| =H-m C-w C-r= | =M-x golden-ratio-mode= | Toggle automatic window resizing with golden ratio. |
|---------------+-------------------------+-----------------------------------------------------|


#+BEGIN_SRC emacs-lisp :tangle config/init-basic-layout.el
;;
;; Always keep buffer sizes in golden ratios
;;
(use-package golden-ratio
    :diminish golden-ratio-mode
    :config
        (golden-ratio-mode 1)
	(setq golden-ratio-auto-scale nil)

        (setq golden-ratio-adjust-factor 1.0)
        (setq golden-ratio-wide-adjust-factor .8)
    :bind (
         :map psimacs/config/global-key-map/special
              ("C-w C-r" . golden-ratio-mode)
        )
)
#+END_SRC

** Basic Tools

*** Ediff

The [[https://www.gnu.org/software/emacs/manual/html_mono/ediff.html][Ediff]] package provides a
comprehensive visual interface to Unix diff and patch utilities.

From the [[https://www.gnu.org/software/emacs/manual/html_mono/ediff.html][Ediff Introduction]]
#+BEGIN_QUOTE
Ediff provides a convenient way for simultaneous browsing through the differences between a pair
(or a triple) of files or buffers. The files being compared, file-A, file-B, and file-C are shown
in separate windows (side by side, one above the another, or in separate frames), and the
differences are highlighted as you step through them.
You can also copy difference regions from one buffer to another (and recover old differences
if you change your mind).

Another powerful feature is the ability to merge a pair of files into a third buffer.
Merging with an ancestor file, (a.k.a. 3way merges) is also supported. Furthermore,
Ediff is equipped with directory-level capabilities that allow the user to conveniently
launch browsing or merging sessions on groups of files in two (or three) different directories.

In addition, Ediff can apply a patch to a file and then let you step through both files, the
patched and the original one, simultaneously, difference-by-difference.
#+END_QUOTE

| Command                                             | Description                                                                                                                                                                                                                                                                                                                       |
|-----------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| =M-x ediff-files=                                   | Compare two files.                                                                                                                                                                                                                                                                                                                |
| =M-x ediff=                                         | /dito/                                                                                                                                                                                                                                                                                                                            |
| =M-x ediff-backup=                                  | Compare a file with its backup. If there are several numerical backups, use the latest. If the file is itself a backup, then compare it with its original.                                                                                                                                                                        |
| =M-x ediff-current-file=                            | Compare the buffer with its file on disk. This function can be used as a safe version of revert-buffer.                                                                                                                                                                                                                           |
| =M-x ediff-buffers=                                 | Compare two buffers.                                                                                                                                                                                                                                                                                                              |
| =M-x ediff-files3=                                  | Compare three files.                                                                                                                                                                                                                                                                                                              |
| =M-x ediff3=                                        | /dito/                                                                                                                                                                                                                                                                                                                            |
| =M-x ediff-buffers3=                                | Compare three buffers.                                                                                                                                                                                                                                                                                                            |
| =M-x edirs=                                         | Compare files common to two directories.                                                                                                                                                                                                                                                                                          |
| =M-x ediff-directories=                             | /dito/                                                                                                                                                                                                                                                                                                                            |
| =M-x edirs3=                                        | Compare files common to three directories.                                                                                                                                                                                                                                                                                        |
| =M-x ediff-directories3=                            | /dito/                                                                                                                                                                                                                                                                                                                            |
| =M-x edir-revisions=                                | Compare versions of files in a given directory. Ediff selects only the files that are under version control.                                                                                                                                                                                                                      |
| =M-x ediff-directory-revisions=                     | /dito/                                                                                                                                                                                                                                                                                                                            |
| =M-x edir-merge-revisions=                          | Merge versions of files in a given directory. Ediff selects only the files that are under version control.                                                                                                                                                                                                                        |
| =M-x ediff-merge-directory-revisions=               | /dito/                                                                                                                                                                                                                                                                                                                            |
| =M-x edir-merge-revisions-with-ancestor=            | Merge versions of files in a given directory using other versions as ancestors. Ediff selects only the files that are under version control.                                                                                                                                                                                      |
| =M-x ediff-merge-directory-revisions-with-ancestor= | /dito/                                                                                                                                                                                                                                                                                                                            |
| =M-x ediff-windows-wordwise=                        | Compare text visible in 2 windows word-by-word.                                                                                                                                                                                                                                                                                   |
| =M-x ediff-windows-linewise=                        | Compare text visible in 2 windows line-by-line.                                                                                                                                                                                                                                                                                   |
| =M-x ediff-regions-wordwise=                        | Compare regions word-by-word. The regions can come from the same buffer and they can even overlap. You will be asked to specify the buffers that contain the regions, which you want to compare. For each buffer, you will also be asked to mark the regions to be compared.                                                      |
| =M-x ediff-regions-linewise=                        | Similar to ediff-windows-linewise, but compares the regions line-by-line. See ediff-windows-linewise for more details.                                                                                                                                                                                                            |
| =M-x ediff-revision=                                | Compare versions of the current buffer, if the buffer is visiting a file under version control.                                                                                                                                                                                                                                   |
| =M-x ediff-patch-file=                              | Patch a file or multiple files, then compare. Since the patch might be in a buffer or a file, you will be asked which is the case. To avoid this extra prompt, you can invoke this command with a prefix argument. With an odd prefix argument, Ediff assumes the patch is in a file; with an even argument, a buffer is assumed. |
| =M-x epatch=                                        | /dito/                                                                                                                                                                                                                                                                                                                            |
| =M-x ediff-patch-buffer=                            | Patch a buffer, then compare. The buffer being patched and the file visited by that buffer (if any) is not modified. The result of the patch appears in some other buffer that has the name ending with _patched.                                                                                                                 |
| =M-x epatch-buffer=                                 | /dito/                                                                                                                                                                                                                                                                                                                            |
| =M-x ediff-merge-files=                             | Merge two files.                                                                                                                                                                                                                                                                                                                  |
| =M-x ediff-merge=                                   | /dito/                                                                                                                                                                                                                                                                                                                            |
| =M-x ediff-merge-files-with-ancestor=               | Like ediff-merge, but with a third ancestor file.                                                                                                                                                                                                                                                                                 |
| =M-x ediff-merge-with-ancestor=                     | /dito/                                                                                                                                                                                                                                                                                                                            |
| =M-x ediff-merge-buffers=                           | Merge two buffers.                                                                                                                                                                                                                                                                                                                |
| =M-x ediff-merge-buffers-with-ancestor=             | Same but with ancestor.                                                                                                                                                                                                                                                                                                           |
| =M-x edirs-merge=                                   | Merge files common to two directories.                                                                                                                                                                                                                                                                                            |
| =M-x ediff-merge-directories=                       | /dito/                                                                                                                                                                                                                                                                                                                            |
| =M-x edirs-merge-with-ancestor=                     | Same but using files in a third directory as ancestors.                                                                                                                                                                                                                                                                           |
| =M-x ediff-merge-directories-with-ancestor=         | /dito/                                                                                                                                                                                                                                                                                                                            |
| =M-x ediff-merge-revisions=                         | Merge two versions of the file visited by the current buffer.                                                                                                                                                                                                                                                                     |
| =M-x ediff-merge-revisions-with-ancestor=           | Same but with ancestor.                                                                                                                                                                                                                                                                                                           |
| =M-x ediff-documentation=                           | Brings up the [[https://www.gnu.org/software/emacs/manual/html_mono/ediff.html][Ediff]] manual.                                                                                                                                                                                                                                                                                                       |
| =M-x ediff-show-registry=                           | Brings up Ediff session registry. This feature enables you to quickly find and restart active Ediff sessions.                                                                                                                                                                                                                     |
| =M-x eregistry=                                     | /dito/                                                                                                                                                                                                                                                                                                                            |
|-----------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|


Remarks:
- All Ediff commands are displayed in a Quick Help window, unless you type =?= to shrink the window to just one line. You can redisplay the help window by typing =?= again.
- Many Ediff commands take numeric prefix arguments.
- Some commands take negative prefix arguments as well.
- Without the prefix argument, all commands operate on the currently selected difference region.

| Command         | Description                                                                                                                                                                                                                          |
|-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| =?=             | Toggles the Ediff Quick Help window ON and OFF.                                                                                                                                                                                      |
| =E=             | Brings up the top node of the [[https://www.gnu.org/software/emacs/manual/html_mono/ediff.html][Ediff]] manual.                                                                                                                                                                                          |
| =v=             | Scrolls up buffers A and B (and buffer C where appropriate) in a coordinated fashion.                                                                                                                                                |
| =V=             | Scrolls the buffers down.                                                                                                                                                                                                            |
| =<=             | Scrolls the buffers to the left simultaneously.                                                                                                                                                                                      |
| =>=             | Scrolls buffers to the right.                                                                                                                                                                                                        |
| =wd=            | Saves the output from the diff utility, for further reference.                                                                                                                                                                       |
| =wa=            | Saves buffer A, if it was modified.                                                                                                                                                                                                  |
| =wb=            | Saves buffer B, if it was modified.                                                                                                                                                                                                  |
| =wc=            | Saves buffer C, if it was modified                                                                                                                                                                                                   |
| =a=             | In comparison sessions: Copies the current difference region from buffer A to buffer B (see rb).                                                                                                                                     |
| =a=             | In merge sessions: Copies the current difference region from buffer A to the merge buffer (r).                                                                                                                                       |
| =ab=            | Copies the current difference region from buffer A to buffer B.                                                                                                                                                                      |
| =ac=            | Copies the difference region from buffer A to buffer C.                                                                                                                                                                              |
| =ba=            | Copies the difference region from buffer B to buffer A.                                                                                                                                                                              |
| =bc=            | Copies the difference region from buffer B to buffer C.                                                                                                                                                                              |
| =ca=            | Copies the difference region from buffer C to buffer A.                                                                                                                                                                              |
| =cb=            | Copies the difference region from buffer C to buffer B.                                                                                                                                                                              |
| =p=, =DEL=      | Makes the previous difference region current.                                                                                                                                                                                        |
| =n=, =SPC=      | Makes the next difference region current.                                                                                                                                                                                            |
| =j=, =-j=, =Nj= | Makes the very first difference region current. Makes the very first difference region current. Typing a number, N, and then j makes the difference region N current.                                                                |
| =ga=            | Makes current the difference region closest to the position of the point in buffer A.                                                                                                                                                |
| =gb=            | Makes current the difference region closest to the position of the point in buffer B.                                                                                                                                                |
| =gc=            | Makes current the difference region closest to the position of the point in buffer C.                                                                                                                                                |
| =!=             | Recomputes the difference regions, bringing them up to date.                                                                                                                                                                         |
| =*=             | Forces refinement of the current difference region, which highlights the exact words of disagreement among the buffers                                                                                                               |
| =m=             | Displays the current Ediff session in a frame as wide as the physical display.                                                                                                                                                       |
| =┃=             | Toggles the horizontal/vertical split of the Ediff display.                                                                                                                                                                          |
| =@=             | Toggles auto-refinement of difference regions.                                                                                                                                                                                       |
| =h=             | Cycles between full highlighting, the mode where fine differences are not highlighted (but computed), and the mode where highlighting is done with ASCII strings.                                                                    |
| =r=             | Restores the old contents of the region in the merge buffer.                                                                                                                                                                         |
| =ra=            | Restores the old contents of the current difference region in buffer A.                                                                                                                                                              |
| =rb=            | Restores the old contents of the current difference region in buffer B.                                                                                                                                                              |
| =rc=            | Restores the old contents of the current difference region in buffer C.                                                                                                                                                              |
| =##=            | Tell Ediff to skip over regions that disagree among themselves only in the amount of white space and line breaks.                                                                                                                    |
| =#c=            | Toggle case sensitivity in the diff program.                                                                                                                                                                                         |
| =#h=            | Ediff prompts you to specify regular expressions for each variant. Difference regions where each variant’s region matches the corresponding regular expression will be skipped from then on.                                         |
| =#f=            | Does dual job: it focuses on regions that match the corresponding regular expressions. All other regions will be skipped over.                                                                                                       |
| =A=             | Toggles the read-only property in buffer A.                                                                                                                                                                                          |
| =B=             | Toggles the read-only property in buffer B.                                                                                                                                                                                          |
| =C=             | Toggles the read-only property in buffer C.                                                                                                                                                                                          |
| =~=             | Swaps the windows where buffers A and B are displayed.                                                                                                                                                                               |
| =i=             | Displays all kinds of useful data about the current Ediff session.                                                                                                                                                                   |
| =D=             | Runs =ediff-custom-diff-program= on the variants and displays the buffer containing the output.                                                                                                                                      |
| =R=             | Displays a list of currently active Ediff sessions—the Ediff Registry.                                                                                                                                                               |
| =M=             | Shows the session group buffer that invoked the current Ediff session.                                                                                                                                                               |
| =z=             | Suspends the current Ediff session. The easiest way to resume a suspended Ediff session is through the registry of active sessions.                                                                                                  |
| =q=             | Terminates this Ediff session.                                                                                                                                                                                                       |
| =%=             | Toggles narrowing in Ediff buffers.                                                                                                                                                                                                  |
| =C-l=           | Restores the usual Ediff window setup. This is the quickest way to resume an Ediff session, but it works only if the control panel of that session is visible.                                                                       |
| =$$=            | Skipping the regions where only one of the variants clashes with the ancestor but the other variant agrees with it. Typing $$ again undoes this setting.                                                                             |
| =$*=            | When merging files with large number of differences, it is sometimes convenient to be able to skip the difference regions for which you already decided which variant is most appropriate. Typing $* will accomplish precisely this. |
| =/=             | Toggle to display the ancestor file in 3way merges.                                                                                                                                                                                  |
| =&=             | On merge the right course of action is not always clear, and Ediff would use a default action. The above command changes the default action.                                                                                         |
| =s=             | Causes the merge window shrink to its minimum size, thereby exposing as much of the variant buffers as possible. Typing s again restores the original size of that window.                                                           |
| =+=             | Combines the difference regions from buffers A and B and copies the result into the merge buffer.                                                                                                                                    |
| ===             | Creates a child Ediff session for comparing regions in buffers A, B or C.                                                                                                                                                            |
|-----------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|

See also:
- [[https://www.emacswiki.org/emacs/EdiffMode][EmacsWiki: Ediff Mode]]
- [[https://www.gnu.org/software/emacs/manual/html_node/ediff/][Ediff Manual]]
- [[https://oremacs.com/2015/01/17/setting-up-ediff/][Setting up Ediff]]
- [[http://www.sentia.com.au/blog/ediff-for-the-brainically-challenged][Ediff For The Brainically Challenged]]

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-tools.el :var file-description="Basic tools setup"
;;
;; A comprehensive visual interface to Unix diff and patch utilities.
;;
(use-package ediff)

;; Don't use the weird setup with the control panel in a separate frame.
(setq ediff-window-setup-function 'ediff-setup-windows-plain)

;; Split the windows horizontally instead of vertically.
;; This way, it's much easier to follow the changes.
(setq ediff-split-window-function
    (lambda (&optional arg)
        (if (> (frame-width) 150)
            (split-window-horizontally arg)
            (split-window-vertically arg)
        )
    )
)

;; Ignore white space.
(setq ediff-diff-options "-w")

;; only highlight the current diff
(setq-default ediff-highlight-all-diffs 'nil)
#+END_SRC

*** Visible Bookmarks

The package [[https://github.com/joodland/bm][Visible bookmarks]] provides visible, buffer local, bookmarks and the
ability to jump forward and backward to the next bookmark. They are quite similar to the /MS Visual Studio/ bookmarks
I am used to.

See also:
- [[https://www.emacswiki.org/emacs/VisibleBookmarks][EmacsWiki: Visible Bookmarks]]

| Key binding | Command                            | Description                                 |
|-------------+------------------------------------+---------------------------------------------|
| =<f2>=      | =M-x bm-next=                      | Jump to the next bookmark.                  |
| =S-<f2>=    | =M-x bm-previous=                  | Jump to the previous bookmark.              |
| =C-<f2>=    | =M-x bm-toggle=                    | Set or unset bookmark.                      |
| =C-S-<f2>=  | =M-x bm-remove-all-current-buffer= | Remove all bookmarks of the current buffer. |
|-------------+------------------------------------+---------------------------------------------|

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-tools.el
;;
;; Visual Studio like bookmarks
;;
(unless (file-directory-p psimacs/config/bookmarks-dir)
    (make-directory psimacs/config/bookmarks-dir t)
)

(use-package bm
    :init
        (setq bm-restore-repository-on-load t)
    :config
        (setq bm-cycle-all-buffers nil)
        (setq bm-repository-file psimacs/config/bm-bookmarks-file)

        (setq-default bm-buffer-persistence t)

        (setq bm-highlight-style 'bm-highlight-only-fringe)     ; bm-highlight-only-line
                                                                ; bm-highlight-line-and-fringe

        (add-hook 'after-init-hook   #'bm-repository-load)
        (add-hook 'kill-buffer-hook  #'bm-buffer-save)
        (add-hook 'kill-emacs-hook   #'(lambda nil
                                         (bm-buffer-save-all)
                                         (bm-repository-save)))

        (add-hook 'find-file-hooks   #'bm-buffer-restore)
        (add-hook 'after-revert-hook #'bm-buffer-restore)

        (add-hook 'vc-before-checkin-hook #'bm-buffer-save)

    :bind (
        ("<f2>"     . bm-next)
        ("S-<f2>"   . bm-previous)
        ("C-<f2>"   . bm-toggle)
        ("C-S-<f2>" . bm-remove-all-current-buffer)
    )
)
#+END_SRC

*** Avy - jumping to visible text

[[https://github.com/abo-abo/avy][Avy]] is a GNU Emacs package for jumping to visible text using
a char-based decision tree.

#+ATTR_HTML: :class styledtable
| Key binding     | Command                          | Description                                                                                                                           |
|-----------------+----------------------------------+---------------------------------------------------------------------------------------------------------------------------------------|
| =H-m C-s C-a c= | =M-x avy-goto-char=              | Input one char, jump to it with a tree.                                                                                               |
| =H-m C-s C-a C= | =M-x avy-goto-char-2=            | Input two consecutive chars, jump to the first one with a tree.                                                                       |
| =H-m C-s C-a t= | =M-x avy-goto-char-timer=        | Input an arbitrary amount of consecutive chars, jump to the first one with a tree.                                                    |
| =H-m C-s C-a T= | =M-x avy-org-goto-heading-timer= | Type part of an Org heading. When you stop typing it will be jumped to; if more than one matches, you can jump to a heading with Avy. |
| =H-m C-s C-a l= | =M-x avy-goto-line=              | Input zero chars, jump to a line start with a tree.                                                                                   |
| =H-m C-s C-a w= | =M-x avy-goto-word-1=            | Input one char at word start, jump to a word start with a tree.                                                                       |
| =H-m C-s C-a W= | =M-x avy-goto-word-0=            | Input zero chars, jump to a word start with a tree.                                                                                   |
|-----------------+----------------------------------+---------------------------------------------------------------------------------------------------------------------------------------|

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-tools.el
;;
;; Jumping to visible text
;;
(use-package avy
    :bind (
        :map psimacs/config/global-key-map/special
            ("C-s C-a c" . avy-goto-char)
            ("C-s C-a C" . avy-goto-char-2)
            ("C-s C-a t" . avy-goto-char-timer)
            ("C-s C-a T" . avy-org-goto-heading-timer)
            ("C-s C-a l" . avy-goto-line)
            ("C-s C-a w" . avy-goto-word-1)
            ("C-s C-a W" . avy-goto-word-0)
        )
    :custom
        (avy-timeout-seconds 0.5)
        (avy-style 'pre)
    :custom-face
        (avy-lead-face ((t (:background "#51afef" :foreground "#870000" :weight bold))))
)
#+END_SRC

*** HTMLize

The [[https://github.com/hniksic/emacs-htmlize][htmlize]] package converts the buffer text and the associated decorations to HTML.

To use it, just switch to the buffer you want HTML-ized and type =M-x htmlize-buffer=.
You will be switched to a new buffer that contains the resulting HTML code. You can
edit and inspect this buffer, or you can just save it with =C-x C-w=.
=M-x htmlize-file= will find a file, fontify it, and save the HTML version in FILE.html,
without any additional intervention. =M-x htmlize-many-files= allows you to htmlize any
number of files in the same manner. =M-x htmlize-many-files-dired= does the same for files
marked in a dired buffer.

This support package is used by [[https://orgmode.org][org-mode]] to produce colored htmls.

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-tools.el
;;
;; Convert buffer text to HTML
;;
(use-package htmlize)
#+END_SRC

** Spell Checking

[[http://www-sop.inria.fr/members/Manuel.Serrano/flyspell/flyspell.html][Flyspell]] enables on-the-fly spell checking in Emacs by the means of a minor mode. [[http://www-sop.inria.fr/members/Manuel.Serrano/flyspell/flyspell.html][Flyspell]] highlights incorrect words
as soon as they are completed or as soon as the cursor hits a new word.

Basically two spell checker programs are usable. At first there is [[http://aspell.net/][Aspell]] and secondly there is [[https://github.com/hunspell/hunspell][hunspell]]. *Psimacs*
supports both backends. You can configure which one to use with the flag variable =psimacs/internal/spell-checker-use-aspell=.
If this is set to =t= the [[http://aspell.net/][Aspell]] program will be used.

The following key bindings are defined for the spell checking mode.
#+ATTR_HTML: :class styledtable
| Key binding | Command                                        | Description                                                                                                                                                                                                                                                                                      |
|-------------+------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| =H-m C-f m= | =M-x flyspell-mode=                            | Minor mode performing on-the-fly spelling checking.                                                                                                                                                                                                                                              |
|             | =M-x flyspell-prog-mode=                       | Turn on  [[http://www-sop.inria.fr/members/Manuel.Serrano/flyspell/flyspell.html][flyspell-mode]] for comments and strings.                                                                                                                                                                                                                                                 |
|-------------+------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| =H-m C-f r= | =M-x flyspell-region=                          | Checks all words inside a region.                                                                                                                                                                                                                                                                |
| =H-m C-f b= | =M-x flyspell-buffer=                          | Checks the whole buffer.                                                                                                                                                                                                                                                                         |
| =H-m C-f w= | =M-x flyspell-word=                            | Spell check a word.                                                                                                                                                                                                                                                                              |
|-------------+------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| =C-,=       | =M-x flyspell-goto-next-error=                 | Go to the next previously detected error.                                                                                                                                                                                                                                                        |
| =C-.=       | =M-x flyspell-auto-correct-word=               | Automatically Correct the current word. This command proposes various successive corrections for the current word.                                                                                                                                                                               |
| =C-:=       | =M-x flyspell-auto-correct-previous-word=      | Auto correct the first mispelled word that occurs before point.                                                                                                                                                                                                                                  |
| =C-;=       | =M-x flyspell-correct-wrapper=                 | By default jumps to the first misspelled word before the point and prompts for correction and gets you back. Calling it with =C-u= gives ability to correct multiple misspelled words in one run. =C-u C-u= changes direction. =C-u C-u C-u= changes direction and enables multiple corrections. |
| =H-m C-f a= | =M-x flyspell-correct-at-point=                | To correct word at point.                                                                                                                                                                                                                                                                        |
| =H-m C-f p= | =M-x flyspell-correct-previous=                | To correct any visible word before the point.                                                                                                                                                                                                                                                    |
| =H-m C-f n= | =M-x flyspell-correct-next=                    | To correct any visible word after the point.                                                                                                                                                                                                                                                     |
| =H-m C-f c= | =M-x flyspell-check-previous-highlighted-word= | Correct the closer misspelled word.                                                                                                                                                                                                                                                              |
|             | =M-x flyspell-correct-word=                    | Pop up a menu of possible corrections for a misspelled word. The word checked is the word at the mouse position.                                                                                                                                                                                 |
|             | =M-x flyspell-correct-word-before-point=       | Pop up a menu of possible corrections for misspelled word before point.                                                                                                                                                                                                                          |
|-------------+------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| =H-m C-f d= | =M-x psimac/spell/add-word-to-dict=            | Add the word at the current location to the private dictionary without question.                                                                                                                                                                                                                 |
|-------------+------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| =H-m C-f g= | =M-x psimac/spell/switch-to-german=            | Change to german language dictionary.                                                                                                                                                                                                                                                            |
| =H-m C-f e= | =M-x psimac/spell/switch-to-english=           | Change to english language dictionary.                                                                                                                                                                                                                                                           |
| =H-m C-f t= | =M-x psimac/spell/toggle-language=             | Toggle german and english language dictionaries.                                                                                                                                                                                                                                                 |
|-------------+------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|

Some more information about spell checking can be found in the following references:
- [[http://aspell.net/][Aspell]]
- [[https://github.com/hunspell/hunspell][hunspell]]
- [[https://www.emacswiki.org/emacs/InteractiveSpell][EmacsWiki: Interactive Spell]]
- [[https://addons.mozilla.org/en-US/thunderbird/language-tools/][Mozlla Dictionaries & Language Packs]]
- [[https://extensions.openoffice.org/][OpenOffice Spell Checker Extensions]]
- [[http://wikemacs.org/wiki/Flyspell-mode][flyspell]]

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-spell-checking.el :var file-description="Basic spell checking setup"
;;
;; Setup the spell checking framework
;;
(use-package flyspell
  :diminish flyspell-mode
  :config
    (setq flyspell-issue-welcome-flag nil
          flyspell-issue-message-flag nil
          flyspell-default-dictionary psimacs/config/spell-checker-german-dict
          flyspell-sort-corrections nil
          flyspell-doublon-as-error-flag t
          flyspell-highlight-flag t
          flyspell-mark-duplications-flag t
          flyspell-persistent-highlight t
          flyspell-highlight-properties t
          flyspell-use-meta-tab nil)

    (unless psimacs/internal/spell-checker-use-aspell ;; i.e. is hunspell
      (setq-default
                ispell-local-dictionary-alist
                  '(
                    ("en_US"     "[[:alpha:]]" "[^[:alpha:]]" "[']" nil ("-d" "en_US"         ) nil utf-8)
                    ("en_GB"     "[[:alpha:]]" "[^[:alpha:]]" "[']" nil ("-d" "en_GB"         ) nil utf-8)
                    ("de_DE"     "[[:alpha:]]" "[^[:alpha:]]" "[']" nil ("-d" "de_DE_frami"   ) nil utf-8)
                    ("de_DE_old" "[[:alpha:]]" "[^[:alpha:]]" "[']" nil ("-d" "de_DE_OLDSPELL") nil utf-8)
                   )
                ispell-hunspell-dictionary-alist ispell-local-dictionary-alist))

  (setq-default ispell-program-name      psimacs/config/spell-checker-runtime
                ispell-extra-args        psimacs/config/spell-checker-extra-args
                ispell-list-command      psimacs/config/spell-checker-list-command
                ispell-really-aspell     psimacs/internal/spell-checker-use-aspell
                ispell-really-hunspell   (not psimacs/internal/spell-checker-use-aspell)
                ispell-check-comments    t
                ispell-silently-savep    t
                ispell-dictionary        flyspell-default-dictionary
                ispell-local-dictionary  flyspell-default-dictionary
                ispell-library-directory psimacs/config/spell-checker-dir
                )

  (add-hook 'tex-mode-hook (function (lambda () (setq ispell-parser 'tex))))

  ;;
  ;; Run flyspell-buffer automatically after emacs loads a file
  ;;
  ;; flyspell-mode-hook: executed after flyspell minor-mode is loaded, however before
  ;; local variables have been processed, hence the flyspell-local-vars trick.
  ;;
  (add-hook 'flyspell-mode-hook #'psimacs/spell/internal/flyspell-local-vars)
  (defun psimacs/spell/internal/flyspell-local-vars ()
    ;; Emacs calls this hook immediately after it finishes applying
    ;; file-local variables stored in file-local-variables-alist.
    (add-hook 'hack-local-variables-hook #'flyspell-buffer))

  (defun psimacs/spell/setup-german-dic()
    "Setup german personal dictionary."
    (let ((de_dict (concat psimacs/config/spell-checker-personal-dict-file "de_DE")))
      (unless (file-exists-p de_dict)
        (if psimacs/internal/spell-checker-use-aspell
            (write-region "personal_ws-1.1 de 0" nil de_dict nil 0)
          (write-region "" nil de_dict nil 0)))

      (when (file-exists-p de_dict)
        (setq-default ispell-personal-dictionary de_dict)
        (setq         ispell-complete-word-dict  de_dict))
      ))

  (defun psimacs/spell/setup-english-dic()
    "Setup english personal dictionary."
    (let ((en_dict (concat psimacs/config/spell-checker-personal-dict-file "en_US")))
      (unless (file-exists-p en_dict)
        (if psimacs/internal/spell-checker-use-aspell
            (write-region "personal_ws-1.1 en 0" nil en_dict nil 0)
          (write-region "" nil en_dict nil 0)))

      (when (file-exists-p en_dict)
        (setq-default ispell-personal-dictionary en_dict)
        (setq         ispell-complete-word-dict  en_dict))
      ))

  (defun psimac/spell/switch-to-german ()
    "switch ispell language to german."
    (interactive)
    (psimacs/spell/setup-german-dic)
    (ispell-change-dictionary psimacs/config/spell-checker-german-dict)
    (message "Dictionary switched to german"))

  (defun psimac/spell/switch-to-english ()
    "switch ispell language to english"
    (interactive )
    (psimacs/spell/setup-english-dic)
    (ispell-change-dictionary psimacs/config/spell-checker-english-dict)
    (message "Dictionary switched to english"))

  (defun psimac/spell/toggle-language ()
    "Toggle ispell-language between english and deutsch8"
    (interactive)
    (let ((dic ispell-current-dictionary))
       (if (string= dic psimacs/config/spell-checker-german-dict)
           (psimac/spell/switch-to-english)
         (psimac/spell/switch-to-german))))

  (defun psimac/spell/add-word-to-dict ()
    "Add the word at the current location to the private dictionary without question."
    (interactive)
    ;; use the correct dictionary
    (flyspell-accept-buffer-local-defs)
    (setq opoint (point-marker))
    (let ((cursor-location (point))
          (word (flyspell-get-word nil)))
      (if (consp word)
          (let ((start (car (cdr word)))
                (end (car (cdr (cdr word))))
                (word (car word)))
            ;; The word is incorrect, we have to propose a replacement.
            (flyspell-do-correct 'save nil word cursor-location start end opoint)))
      (ispell-pdict-save t)))


    (defun psimacs/spell/check-next-highlighted-word ()
        "Custom function to spell check next highlighted word"
        (interactive)
        (flyspell-goto-next-error)
        (ispell-word)
    )

  ;;
  ;; MSYS2 hunspell does not contain german dictionaries at the time of setting this up.
  ;; Therefore I copy asset provided german dictionaries into the appropriate hunspell folder
  ;; if MSYS2.
  ;;
  (unless psimacs/internal/spell-checker-use-aspell
    (when (and (file-directory-p psimacs/config/spell-checker-hunspell-personal-dir)
               (file-directory-p psimacs/config/spell-checker-hunspell-dir))
      (dolist (f (directory-files psimacs/config/spell-checker-hunspell-personal-dir nil "^.*\\.\\(aff\\|dic\\)$"))
        (let ((src-file (concat psimacs/config/spell-checker-hunspell-personal-dir f))
              (dst-file (concat psimacs/config/spell-checker-hunspell-dir f)))
          (when (not (file-exists-p dst-file))
            (copy-file src-file dst-file t t))))))

  (psimacs/spell/setup-german-dic)

  :hook (
         ((text-mode message-mode markdown-mode org-mode TeX-mode LaTeX-mode) . flyspell-mode)
         (prog--mode . flyspell-prog-mode)
         (ispell-change-dictionary . flyspell-buffer)
        )

  :bind (
         :map psimacs/config/global-key-map/special
              ("C-f m" . flyspell-mode)

         :map flyspell-mode-map
              ("C-:" . flyspell-auto-correct-previous-word)
              ("\M-\t" . nil)
              ([down-mouse-2] . nil)
              ([mouse-2]      . nil)
              ([down-mouse-3] . nil)
              ([mouse-3]      . nil)
              ("H-m C-f b" . flyspell-buffer)
              ("H-m C-f r" . flyspell-region)
              ("H-m C-f w" . flyspell-word)

              ("H-m C-f c" . flyspell-check-previous-highlighted-word)
              ("H-m C-f d" . psimac/spell/add-word-to-dict)
              ("H-m C-f g" . psimac/spell/switch-to-german)
              ("H-m C-f e" . psimac/spell/switch-to-english)
              ("H-m C-f t" . psimac/spell/toggle-language)

        )
  )
#+END_SRC

Package [[https://github.com/xuchunyang/flyspell-popup][flyspell-popup]] brings nice Popup Menu into play.

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-spell-checking.el
;;
;; Nice Popup Menu
;;
(use-package flyspell-popup
  :after flyspell
  :bind (
         :map flyspell-mode-map
              ("H-m C-;" . #'flyspell-popup-correct)
        )
)
#+END_SRC

Correcting misspelled words with flyspell using favourite interface. That is what package [[https://github.com/d12frosted/flyspell-correct#flyspell-correct-popup-interface][flyspell-correct]] gives us.
*Psimacs* uses the [[https://github.com/abo-abo/swiper][Ivy]] interface of [[https://github.com/d12frosted/flyspell-correct#flyspell-correct-popup-interface][flyspell-correct]].

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-spell-checking.el
(use-package flyspell-correct
  :after flyspell
  :bind (
         :map flyspell-mode-map
              ("C-;"       . flyspell-correct-wrapper)
              ("H-m C-f a" . flyspell-correct-at-point)
              ("H-m C-f p" . flyspell-correct-previous)
              ("H-m C-f n" . flyspell-correct-next)
        )
)

(use-package flyspell-correct-ivy
  :after flyspell-correct
)
#+END_SRC

* Utility Lisp functions

All functions defined in *Psimacs* are prefixed by =psimacs/category=. For example
the /string/ related function /starts-with/ is defined as =psimacs/string/starts-with=.

** String processing

Utiltiy functions that help with handling of strings.

The following simple string functions are part of the configuration for historical reason. Today, the build-in *Emacs*
functions for string processing should be used instead.

References of string functionality:
- [[https://www.gnu.org/software/emacs/manual/html_node/elisp/Strings-and-Characters.html#Strings-and-Characters][*Emacs* Manual: String and Characters]]
- [[http://ergoemacs.org/emacs/elisp_string_functions.html][Elips: String Functions by Xah Lee]]
- [[http://ergoemacs.org/emacs/elisp_trim_string.html][Elisp: Trim String Functions by Xah Lee]]
- [[https://github.com/magnars/s.el][*s.el*: The long lost Emacs string manipulation library.]]

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-functions.el :var file-description="Basic elisp functions"
;;
;; Deprecated helper functions for string processing
;;
(defun psimacs/string/starts-with (s begins)
    "Return non-nil if string S starts with BEGINS."
    (cond (
            (>= (length s) (length begins))
            (string-equal (substring s 0 (length begins)) begins)
        )
        (t nil)
    ))

(defun psimacs/string/ends-with (string suffix)
    "Return t if STRING ends with SUFFIX."
    (and (string-match (rx-to-string `(: ,suffix eos) t) string) t))

(defun psimacs/string/reverse (str)
    "Reverse the str where str is a string"
    (apply #'string (reverse  (string-to-list str))))

(defun psimacs/string/chomp-end (str)
    "Chomp tailing whitespace from STR."
    (replace-regexp-in-string (rx (* (any " \t\n")) eos) "" str))

(defun psimacs/string/chomp (str)
    "Chomp leading and tailing whitespace from STR."
    (replace-regexp-in-string (rx (or (: bos (* (any " \t\n")))
                                      (: (* (any " \t\n")) eos)))
                                ""
                                str))
#+END_SRC

** User Interface

Some useful user interface functions.

*** Select Item from list

Helper function =psimacs/ui/internal/select-from-item-list= that allows the selection of one item
from a given list of items.

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-functions.el
;;
;; User interface functions
;;
(defun psimacs/ui/internal/select-from-item-list (prompt given-list &optional index)
    "Select item from list GIVEN-LIST.
This function simply delegates to ivy-read.
"
    (if (= 1 (length given-list))
        (car given-list)
        (ivy-read prompt given-list :require-match t :preselect index)
    )
)
#+END_SRC

A test function =psimacs/ui/test/select-from-item-list= for function =psimacs/ui/internal/select-from-item-list=.

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-functions.el
(defun psimacs/ui/test/1/select-from-item-list ()
  "Test function 'psimacs/ui/internal/select-from-item-list'. Select from 3 element list."
    (interactive)
    (let* (( result (psimacs/ui/internal/select-from-item-list "Hi joe: " '("a" "b" "c"))))
        (message result)
    )
)

(defun psimacs/ui/test/2/select-from-item-list ()
  "Test function 'psimacs/ui/internal/select-from-item-list'. Select from 1 element list."
    (interactive)

    (let* (( result (psimacs/ui/internal/select-from-item-list "Hi joe: " '("a"))))
        (message result)
    )
)

#+END_SRC

** Encoding

Sometimes you need to recode parts of a buffer. The following function allows to partially recode a region.

#+BEGIN_SRC emacs-lisp :tangle config/init-basic-functions.el
;;
;; Sometimes you need to recode parts of a buffer.
;;
(defun psimacs/encoding/recode-region (start end &optional coding-system)
  "Replace the region with a recoded text."
  (interactive "r\n\zCoding System (utf-8): ")
  (setq coding-system (or coding-system 'utf-8))
  (let ((buffer-read-only nil)
	(text (buffer-substring start end)))
    (delete-region start end)
    (insert (decode-coding-string (string-make-unibyte text) coding-system))))
#+END_SRC

* Advanced Setup

Now that the basic setup is finished we can take credit of the enormous amount of useful *Emacs* packages out
there. It is one of *Psimacs* goals to be a /modern/ editor. Let's see...

** Discoverability

*Emacs* is quite a complicated beast that is not easy to get acquainted with. Fortunately, few packages are available
that mitigate the learning curve. The following packages let you /discover/ key bindings, modes etc.

*** Discover Major Mode

Package [[https://framagit.org/steckerhalter/discover-my-major][discover-my-major]] allows to discover key bindings and descriptions for commands defined by a buffer's
major and minor modes.

| Key binding   | Command                 | Description                                                     |
|---------------+-------------------------+-----------------------------------------------------------------|
| =H-m H-h C-m= | =M-x discover-my-major= | Create a listing of all major-mode keys with their description. |
| =H-m H-h M-m= | =M-x discover-my-mode=  | Create a listing of all MODE keys with their description.       |
|---------------+-------------------------+-----------------------------------------------------------------|

#+BEGIN_SRC emacs-lisp :tangle config/init-advanced-discoverability.el :var file-description="Advanced discoverability setup"
;;
;; Discover key bindings and descriptions for commands defined by a buffer
;;
(use-package discover-my-major
    :bind (
        :map psimacs/config/global-key-map/special
            ("H-h C-m" . discover-my-major)
            ("H-h M-m" . discover-my-mode)
        )
)
#+END_SRC

*** Helm-Descbinds

The package [[https://github.com/emacs-helm/helm-descbinds][helm-descbinds]] provides an interface to *Emacs's* =describe-bindings= making the currently active key
bindings interactively searchable with helm.

| Key binding | Command              | Description                                                 |
|-------------+----------------------+-------------------------------------------------------------|
| =H-m H-h b= | =M-x helm-descbinds= | Create a listing of all key bindings of current major mode. |
|-------------+----------------------+-------------------------------------------------------------|

#+BEGIN_SRC emacs-lisp :tangle config/init-advanced-discoverability.el
;;
;; Provide a searchable list of bindings in current major-mode
;;
(use-package helm-descbinds
  :bind (
         :map psimacs/config/global-key-map/special
         ("H-h b" . helm-descbinds)
         )
  :config
  (helm-descbinds-mode)
  )
#+END_SRC

*** Helm-Describe-Modes

The package [[https://github.com/emacs-helm/helm-describe-modes][helm-describe-modes]] provides a Helm interface to *Emacs's* =describe-mode=. It lists the major mode,
active minor modes, and inactive minor modes using Helm, and provides actions for each mode.

| Key binding | Command                   | Description                                          |
|-------------+---------------------------+------------------------------------------------------|
| =H-m H-h m= | =M-x helm-describe-modes= | Create a listing of all modes of current major mode. |
|-------------+---------------------------+------------------------------------------------------|

#+BEGIN_SRC emacs-lisp :tangle config/init-advanced-discoverability.el
;;
;; Provide a searchable list of bindings in current major-mode
;;
(use-package helm-describe-modes
  :bind (
         :map psimacs/config/global-key-map/special
         ("H-h m" . helm-describe-modes)
         )
;  :config
;  (helm-descbinds-mode)
  )
#+END_SRC

*** Which Key

[[https://github.com/justbur/emacs-which-key][Which-key]] is a minor mode for *Emacs* that
displays the key bindings following your currently entered incomplete command (a prefix)
in a popup. IMHO, this package is one of the most useful packages for *Emacs*.

| Key binding     | Command                                   | Description                                   |
|-----------------+-------------------------------------------+-----------------------------------------------|
| =H-m C-u C-w t= | =M-x psimacs/which-key/toogle-sort-order= | Toggle the which-key-mode sort order.         |
| =H-m C-u C-w c= | =M-x psimacs/which-key/cycle-sort-order=  | Cycle through the which-key-mode sort orders. |
|-----------------+-------------------------------------------+-----------------------------------------------|

#+BEGIN_SRC emacs-lisp :tangle config/init-advanced-which-key.el :var file-description="Advanced which-key setup"
;;
;; Configuration of the which-key package
;;
(defvar psimacs/config/which-key-sort-order 'which-key-key-order-alpha
    "The psimacs default which key sort order.

Lexicographically, single characters are sorted alphabetically.")

(defun psimacs/which-key/toogle-sort-order ()
    "Toggle the which-key-mode sort order.

    If which key sort order is 'which-key-key-order-alpha' then the
    sort order is set to 'which-key-description-order'. Else it is
    set to 'which-key-key-order-alpha'.
    "
    (interactive "")

    (let ((sort-order psimacs/config/which-key-sort-order))
        (if (eq which-key-sort-order 'which-key-description-order)
            (setq sort-order psimacs/config/which-key-sort-order)
            (setq sort-order 'which-key-description-order)
        )

        (setq which-key-sort-order sort-order)
        (message "which-key sort order is %s" sort-order)
    )
)

(defun psimacs/which-key/cycle-sort-order ()
    "Cycle the which-key-mode sort order.

'which-key-key-order
    The default order is to sort lexicographically within
    each class of key, where the classes and their order are:
        - Special (SPC, TAB, ...)
        - Single Character (ASCII) (a, ...)
        - Modifier (C-, M-, ...)
        - Other

'which-key-key-order-alpha
    Same as default, except single characters are sorted alphabetically.

'which-key-prefix-then-key-order
    Same as default, except all prefix keys are grouped together at the end

'which-key-local-then-key-order
    Same as default, except all keys from local maps shown first.

'which-key-description-order
    Sort based on the key description ignoring case

'which-key-description-order
    Sort based on the key description ignoring case"

    (interactive "")

    (let ((sort-order psimacs/config/which-key-sort-order))

        (if (eq which-key-sort-order 'which-key-key-order)
            (setq sort-order 'which-key-key-order-alpha)

            (if (eq which-key-sort-order 'which-key-key-order-alpha)
                (setq sort-order 'which-key-prefix-then-key-order)

                (if (eq which-key-sort-order 'which-key-prefix-then-key-order)
                    (setq sort-order 'which-key-local-then-key-order)

                    (if (eq which-key-sort-order 'which-key-local-then-key-order)
                        (setq sort-order 'which-key-description-order)

                        (if (eq which-key-sort-order 'which-key-description-order)
                            (setq sort-order 'which-key-key-order)
                        )
                    )
                )
            )
        )

        (setq which-key-sort-order sort-order)
        (message "which-key sort order is %s" sort-order)

        (if (not (eq which-key-sort-order 'which-key-description-order))
            (setq psimacs/config/which-key-sort-order sort-order)
        )
    )
)

(use-package which-key
    :demand t
    :diminish which-key-mode
    :bind (
           :map psimacs/config/global-key-map/special
              ("C-u C-w t" . psimacs/which-key/toogle-sort-order)
              ("C-u C-w c" . psimacs/which-key/cycle-sort-order)
           )
    :init
        (setq which-key-sort-order psimacs/config/which-key-sort-order)
        (setq which-key-idle-delay 0.3)
    :config
        (setq which-key-key-replacement-alist '(
            ("<\\([[:alnum:]-]+\\)>" . "\\1")
            ("left"                  . "◄")
            ("right"                 . "►")
            ("up"                    . "▲")
            ("down"                  . "▼")
            ("delete"                . "DEL") ; delete key
            ("\\`DEL\\'"             . "BS")  ; backspace key
            ("next"                  . "PgDn")
            ("prior"                 . "PgUp"))
        )

        (setq which-key-max-description-length 60)
        (which-key-setup-side-window-right-bottom)

        (which-key-mode t)
)
#+END_SRC

*** Swiper / Ivy / Counsel

[[https://github.com/abo-abo/swiper][Swiper]] gives us a really efficient incremental search
with regular expressions and [[https://oremacs.com/swiper/][Ivy]] / [[https://oremacs.com/swiper/][Counsel]]
replace a lot of ido or helms completion functionality

See also:
- [[https://writequit.org/denver-emacs/presentations/2017-04-11-ivy.html][Ivy, Counsel and Swiper]],
- [[https://oremacs.com/2015/04/09/counsel-completion/][Counsel]]

| Key binding | Command                | Description                                                              |
|-------------+------------------------+--------------------------------------------------------------------------|
| =C-s=       | =M-x swiper-iseach=    | A =swiper= that’s not line-based. Incrementally search with an overview. |
| =C-r=       | =M-x swiper=           | Incrementally search with an overview.                                   |
| =C-c v=     | =M-x ivy-push-view=    | Push the current window tree on =ivy-views=                              |
| =C-c V=     | =M-x ivy-pop-view=     | Delete a view to delete from =ivy-views=.                                |
| =H-m C-s a= | =M-x swiper-all=       | Incrementally search in all open buffers.                                |
| =H-m C-s s= | =M-x isearch-forward=  | Incrementally search forward.                                            |
| =H-m C-s r= | =M-x isearch-backward= | Incrementally search backward.                                           |
|-------------+------------------------+--------------------------------------------------------------------------|

*** Ivy

[[https://github.com/abo-abo/swiper][Ivy]] is for quick and easy selection from a list. When *Emacs* prompts for a string
from a list of several possible choices, Ivy springs into action to assist in
narrowing and picking the right string from a vast number of choices.

| Key binding | Command                 | Description                                                             |
|-------------+-------------------------+-------------------------------------------------------------------------|
| =C-x b=     | =M-x ivy-switch-buffer= | Switch to another buffer.                                               |
| =C-c C-S-r= | =M-x ivy-resume=        | Resumes the last Ivy-based completion.                                  |
| =M-y=       | =M-x ivy-next-line=     | In minibuffer, Move cursor vertically down.                             |
| =C-'=       | =M-x ivy-avy=           | Uses avy to select one of the candidates on the current candidate page. |
|-------------+-------------------------+-------------------------------------------------------------------------|

See also [[https://oremacs.com/swiper/][Ivy User Manual]]

#+BEGIN_SRC emacs-lisp :tangle config/init-advanced-swiper-key.el :var file-description="Advanced Ivy, Counsel and Swiper setup"
;;
;; First configure ivy...
;;
(use-package ivy
    :demand t
    :diminish
    :bind (
        ("C-s" . swiper-isearch)
        ("C-r" . swiper)
        ("C-x b"     . ivy-switch-buffer)
        ("C-c C-S-r" . ivy-resume)
        ("C-c v"   . ivy-push-view)
        ("C-c V"   . ivy-pop-view)
        :map ivy-minibuffer-map
            ("M-y"   . ivy-next-line)
        :map ivy-mode-map
            ("C-'"   . ivy-avy)
        :map psimacs/config/global-key-map/special
            ("C-s a" . swiper-all)
            ("C-s s" . isearch-forward)
            ("C-s r" . isearch-backward)
       )
    :config
        (ivy-mode 1)
        (setq ivy-use-virtual-buffers t)        ; ﻿add recent files and/or bookmarks to ‘ivy-switch-buffer’
        (setq enable-recursive-minibuffers t)   ; if this variable is non-nil, you can invoke commands (such as find-file)
                                                ; that use minibuffers even while the minibuffer is active. Such invocation
                                                ; produces a recursive editing level for a new minibuffer. The outer-level
                                                ; minibuffer is invisible while you are editing the inner one.
        (setq ivy-height 10)                    ; number of result lines to display
        (setq ivy-count-format "%d/%d ")        ; displays the current and total number in the collection in the prompt
        (setq ivy-initial-inputs-alist nil)     ; no regexp by default
        (setq ivy-re-builders-alist             ; configure regexp engine.
            '((t . ivy--regex-ignore-order)))   ; allow input not in order

        (setq ivy-re-builders-alist
            '(
                (ivy-switch-buffer . ivy--regex-plus )
                (swiper            . ivy--regex-plus )
                (counsel-M-x       . ivy--regex-plus )
                (t                 . ivy--regex-plus )
             )
        )

        (setq ivy-initial-inputs-alist nil)
        (define-key ivy-minibuffer-map (kbd "<return>") 'ivy-alt-done)

        (setq magit-completing-read-function 'ivy-completing-read)
        (setq projectile-completion-system 'ivy)
)
#+END_SRC

*** Counsel
To keep concerns separated, Ivy doesn't have a lot of other functionality. That's where Counsel comes in.

[[https://github.com/abo-abo/swiper][Ivy mode]] ensures that any Emacs command using =completing-read-function=
uses [[https://github.com/abo-abo/swiper][ivy]] for completion.
Counsel takes this further, providing versions of common *Emacs* commands that are customised to make
the best use of [[https://github.com/abo-abo/swiper][ivy]].

| Key binding | Command                          | Description                                                              |
|-------------+----------------------------------+--------------------------------------------------------------------------|
| =M-x=       | =M-x counsel-M-x=                | Ivy version of =execute-extended-command=.                               |
| =C-M-i=     | =M-x counsel-imenu=              | Jump to a buffer position indexed by =imenu=.                            |
| =C-x C-f=   | =M-x counsel-find-file=          | Counsel, forward to =find-file=.                                         |
| =C-c b=     | =M-x counsel-bookmark=           | Forward to =bookmark-jump= or =bookmark-set= if bookmark does not exist. |
| =C-c c=     | =M-x counsel-compile=            | Call =compile= completing with smart suggestions, optionally for DIR.    |
| =C-c d=     | =M-x counsel-dired-jump=         | Jump to a directory below the current directory.                         |
| =C-c F=     | =M-x counsel-org-file=           | Browse all attachments for current Org file.                             |
| =C-c g=     | =M-x counsel-git=                | Find file in the current git repository.                                 |
| =C-c j=     | =M-x counsel-git-grep=           | Grep for a string in the current Git repository.                         |
| =C-c L=     | =M-x counsel-git-log=            | Call the =git log --grep= shell command.                                 |
| =C-c J=     | =M-x counsel-file-jump=          | Jump to a file below the current directory..                             |
| =C-c k=     | =M-x counsel-ag=                 | Grep for a string in a root directory using =ag=.                        |
| =C-c l=     | =M-x counsel-locate=             | Call a "locate" style shell command.                                     |
| =M-y=       | =M-x counsel-yank-pop=           | Ivy replacement for =yank-pop=.                                          |
| =C-h f=     | =M-x counsel-describe-function=  | Forward to =describe-function=.                                          |
| =C-h i=     | =M-x counsel-info-lookup-symbol= | Forward SYMBOL to =info-lookup-symbol= with ivy completion.              |
| =C-h j=     | =M-x counsel-set-variable=       | Set a variable SYM with completion.                                      |
| =C-h l=     | =M-x counsel-find-library=       | Find Emacs Lisp source. Forward to =find-library=.                       |
| =C-h u=     | =M-x counsel-unicode-char=       | Insert COUNT copies of a unicode char at point.                          |
| =C-h v=     | =M-x counsel-describe-variable=  | Forward to =describe-function=.                                          |
| =C-r=       | =M-x counsel-minibuffer-history= | Browse minibuffer history.                                               |
| =C-r=       | =M-x counsel-expression-history= | In =read-expression-map=                                                 |
|-------------+----------------------------------+--------------------------------------------------------------------------|

#+BEGIN_SRC emacs-lisp :tangle config/init-advanced-swiper-key.el
;;
;; ... then counsel
;;
(use-package counsel
    :after ivy
    :diminish
    :bind (
        ("M-x"     . counsel-M-x)
        ("C-M-i"   . counsel-imenu)
        ("C-x C-f" . counsel-find-file)
        ("C-c b"   . counsel-bookmark)
        ("C-c c"   . counsel-compile)
        ("C-c d"   . counsel-dired-jump)
        ("C-c g"   . counsel-git)
        ("C-c j"   . counsel-git-grep)
        ("C-c L"   . counsel-git-log)
        ("C-c J"   . counsel-file-jump)
        ("C-c k"   . counsel-ag)
        ("C-c l"   . counsel-locate)
        ("M-y"     . counsel-yank-pop)
        :map help-map
            ("f"   . counsel-describe-function)
            ("v"   . counsel-describe-variable)
            ("l"   . counsel-find-library)
            ("u"   . counsel-unicode-char)
            ("j"   . counsel-set-variable)
            ("i"   . counsel-info-lookup-symbol)
        :map read-expression-map
            ("C-r" . counsel-expression-history)
        :map ivy-minibuffer-map
            ("C-r" . counsel-minibuffer-history)
        )
    :config
        (setq counsel-find-file-at-point t)
)
#+END_SRC

** Org-Mode

Package [[https://orgmode.org][org-mode]] is for keeping notes, maintaining TODO lists,
planning projects, and authoring documents with a fast and effective plain-text system.

The following links might be useful for diving deeper into [[http://orgmode.org/][Org-Mode]]:
- [[http://orgmode.org/manual/index.html][Org Mode Manual]]
- [[http://orgmode.org/worg/][Worg, the Org Mode Community]]
- [[https://www.emacswiki.org/emacs/OrgMode][EmacsWiki: Org Mode]]
- [[https://www.suenkler.info/notes/emacs-orgmode/][Aufgabenverwaltung im Emacs Org mode]]
- [[https://blog.aaronbieber.com/2016/01/30/dig-into-org-mode.html][Dig Into Org Mode]]
- [[http://orgmode.org/worg/org-contrib/babel/][Org Mode Babel]]
- [[http://www.howardism.org/Technical/Emacs/literate-programming-tutorial.html][Introduction to Literate Programming]]
- [[https://org-babel.readthedocs.io/en/latest/][Readthedocs about Org Babel]]
- [[http://orgmode.org/worg/orgcard.html][Org Mode reference card]]
- [[http://orgmode.org/orgcard.pdf][Org Mode Ref Card]]
- [[http://ergoemacs.org/emacs/emacs_org_markup.html][Org Mode Markup Cheatsheet]]
- [[http://pragmaticemacs.com/][Pragmatic Emacs]]
- [[http://doc.norang.ca/org-mode.html][Org Mode - Organize Your Life In Plain Text!]]

*** Temporarily workaround Org-Mode problem :noexport:

*Psimacs* relies on features provided by the [[https://orgmode.org/worg/org-contrib/][Org-mode Contributed Packages]].
At the time of working on this setup, I encountered a problem in the =org-plus-contrib-20200907= package.

The code in this section circumvented the problem by patching one file in this package.
Hopefully, I can get rid of this hack in the near future.

Remove the built-in version of [[https://orgmode.org][org-mode]] from the load-path.

#+BEGIN_SRC emacs-lisp :tangle config/init-advanced-org-mode.el :var file-description="Advanced org-mode setup"
;;
;; Remove the built-in version of [[https://orgmode.org][org-mode]] from the load-path.
;;
(require 'cl-seq)
(setq load-path
      (cl-remove-if
       (lambda (x)
         (string-match-p "org$" x))
       load-path))
#+END_SRC

The current =org-plus-contrib-20200907= package does have an error in file =org.el= in line 5320.
We use a loaclly patched version of this package with a fixed =org.el=.
We load this patched package by the following =load-path=  modification.

Check on [[https://orgmode.org/elpa/][OrgElpa]] and on [[https://code.orgmode.org/bzg/org-mode][org-mode]].

Hopefully, this will be fixed upstream in the near future. In that case the following statement is
to be removed and the =:ensure org-plus-contrib= is to be activated.

#+BEGIN_SRC emacs-lisp :tangle config/init-advanced-org-mode.el
;;
;; Add local path to org-plus-contrib to search path
;;
(add-to-list 'load-path (concat psimacs/config/site-lisp-dir "org-plus-contrib-20200907"))
#+END_SRC

*** The main Org-Mode configuration

If the temporary workaround is in use, the =:straight org-plus-contrib= statement needs to be commented!

#+BEGIN_SRC emacs-lisp :tangle config/init-advanced-org-mode.el :var file-description="Advanced org-mode setup"
;;
;; The main org-mode configuration
;;
(use-package org
    :mode (("\\.\\(org\\|org_archive\\)$" . org-mode))
    :straight org-plus-contrib
    :config
        (setq org-return-follows-link t)
        (setq org-drawers (quote ("PROPERTIES" "CLOCKTABLE" "LOGBOOK" "CLOCK")))
        (setq org-log-done 'time)
        (setq org-log-into-drawer t)
        ;(setq org-completion-use-ido t)
        ;(setq org-tags-exclude-from-inheritance '("review")))

        (setq
            org-todo-keywords '(
                (sequence "TODO(t/!)" "WORK(w/!)" "WAIT(a/!)" "HOLD(h@/!)" "|" "DONE(d/!)" "STOP(s@/!)")
                (sequence "REPORT(r/!)" "BUG(b/!)" "FEEDBACK(f@/!)" "WAITING(i@/!)" "VERIFY(v@/!)" "KNOWNCAUSE(k@/!)" "|" "FIXED(x/!)")
                (sequence "|" "CANCELED(c@/!)" "DELEGATED(e@/!)")
            )
        )

        ;(setq
        ;    org-todo-keyword-faces '(
        ;        ("TODO"         . org-todo)
        ;        ("WORK"         . (:background "Snow" :foreground "DeepPink"  :box (:line-width 1 :style none)))
        ;        ("WAIT"         . (:background "Snow" :foreground "DeepPink"  :box (:line-width 1 :style none)))
        ;        ("HOLD"         . (:background "Snow" :foreground "DeepPink"  :box (:line-width 1 :style none)))
        ;        ("DONE"         . (org-done))
        ;        ("STOP"         . (org-done))

        ;        ("REPORT"       . org-todo)
        ;        ("BUG"          . org-todo)
        ;        ("FEEDBACK"     . (:background "Snow" :foreground "DeepPink"  :box (:line-width 1 :style none)))
        ;        ("WAITING"      . (:background "Snow" :foreground "DeepPink"  :box (:line-width 1 :style none)))
        ;        ("VERIFY"       . (:background "Snow" :foreground "DeepPink"  :box (:line-width 1 :style none)))
        ;        ("KNOWNCAUSE"   . (:background "Snow" :foreground "DeepPink"  :box (:line-width 1 :style none)))
        ;        ("FIXED"        . (org-done))

        ;        ("CANCELED"     . (org-done))
        ;        ("DELEGATED"    . (org-done))
        ;    )
        ;)

        (setq org-tag-alist
            (quote (
                ; Rough task assignment
                (:startgroup)
                ("Science"      . ?s)
                ("Learn"        . ?l)
                ("Develop"      . ?d)
                ("Information"  . ?i)
                ("Bug"          . ?b)
                ("System"       . ?y)
                ("Configuration". ?f)
                (:endgroup)

                ; Category of the task
                (:startgroup)
                ("CADdy"        . ?c)
                ("RenderEngine" . ?r)
                ("Zinc"         . ?z)
                ("OpenSG"       . ?o)
                ("OpenGL"       . ?g)
                ("Boost"        . ?t)
                ("Emacs"        . ?e)
                ("BuildSystem"  . ?m)
                ("CADdyPython"  . ?p)
                (:endgroup)

                ; Context
                (:startgroup)
                ("2D"           . ?2)
                ("3D"           . ?3)
                ("Graphic"      . ?h)
                (:endgroup)

                ; Language
                (:startgroup)
                ("Cpp"          . ?+)
                ("Python"       . ?P)
                ("Lisp"         . ?L)
                ("Bash"         . ?S)
                ("Prolog"       . ?J)
                (:endgroup)

                ; ToDo-Keywrds
                (:startgroup)
                ("TODO"         . ?T)
                ("WORK"         . ?W)
                ("WAIT"         . ?A)
                ("HOLD"         . ?H)
                ("DONE"         . ?D)
                ("STOP"         . ?O)

                ("REPORT"       . ?R)
                ("BUG"          . ?B)
                ("FEEDBACK"     . ?F)
                ("WAITING"      . ?I)
                ("VERIFY"       . ?V)
                ("KNOWNCAUSE"   . ?K)
                ("FIXED"        . ?X)

                ("CANCELED"     . ?C)
                ("DELEGATED"    . ?E)
                (:endgroup)

                ; Common unspecied tags
                ("Faq"          . ??)
                ("Question"     . ?&)
                ("Note"         . ?n)
                ("Meeting"      . ?x)
                ("Private"      . ?a)
                ("Time"         . ?k)
                ("Important"    . ?#)
                ("Flagged"      . ?!)
            ))
        )

        ; maybe later
        ;(setq org-fast-tag-selection-single-key (quote auto))
        ;(setq org-fast-tag-selection-single-key (quote expert))

        (setq org-use-fast-tag-selection t)
        (setq org-complete-tags-always-offer-all-agenda-tags t)

        (add-hook 'org-capture-mode-hook
            (lambda ()
                (setq-local org-tag-alist (org-global-tags-completion-table))
            )
        )

        ;(add-hook 'org-capture-mode-hook
        ;    (lambda ()
        ;        (save-restriction
        ;            (widen)
        ;            (setq-local org-tag-alist (org-get-buffer-tags))
        ;        )
        ;    )
        ;)

        (setq org-todo-state-tags-triggers
            (quote (
                ("TODO"                 ("WORK") ("WAIT") ("HOLD") ("DONE") ("STOP") ("REPORT") ("BUG") ("FEEDBACK") ("WAITING") ("VERIFY") ("KNOWNCAUSE") ("FIXED") ("CANCELED") ("DELEGATED") ("TODO"       . t))
                ("WORK"        ("TODO")          ("WAIT") ("HOLD") ("DONE") ("STOP") ("REPORT") ("BUG") ("FEEDBACK") ("WAITING") ("VERIFY") ("KNOWNCAUSE") ("FIXED") ("CANCELED") ("DELEGATED") ("WORK"       . t))
                ("WAIT"        ("TODO") ("WORK")          ("HOLD") ("DONE") ("STOP") ("REPORT") ("BUG") ("FEEDBACK") ("WAITING") ("VERIFY") ("KNOWNCAUSE") ("FIXED") ("CANCELED") ("DELEGATED") ("WAIT"       . t))
                ("HOLD"        ("TODO") ("WORK") ("WAIT")          ("DONE") ("STOP") ("REPORT") ("BUG") ("FEEDBACK") ("WAITING") ("VERIFY") ("KNOWNCAUSE") ("FIXED") ("CANCELED") ("DELEGATED") ("HOLD"       . t))
                ("DONE"        ("TODO") ("WORK") ("WAIT") ("HOLD")          ("STOP") ("REPORT") ("BUG") ("FEEDBACK") ("WAITING") ("VERIFY") ("KNOWNCAUSE") ("FIXED") ("CANCELED") ("DELEGATED") ("DONE"       . t))
                ("STOP"        ("TODO") ("WORK") ("WAIT") ("HOLD") ("DONE")          ("REPORT") ("BUG") ("FEEDBACK") ("WAITING") ("VERIFY") ("KNOWNCAUSE") ("FIXED") ("CANCELED") ("DELEGATED") ("DONE"       . t))

                ("REPORT"      ("TODO") ("WORK") ("WAIT") ("HOLD") ("DONE") ("STOP")            ("BUG") ("FEEDBACK") ("WAITING") ("VERIFY") ("KNOWNCAUSE") ("FIXED") ("CANCELED") ("DELEGATED") ("REPORT"     . t))
                ("BUG"         ("TODO") ("WORK") ("WAIT") ("HOLD") ("DONE") ("STOP") ("REPORT")         ("FEEDBACK") ("WAITING") ("VERIFY") ("KNOWNCAUSE") ("FIXED") ("CANCELED") ("DELEGATED") ("BUG"        . t))
                ("FEEDBACK"    ("TODO") ("WORK") ("WAIT") ("HOLD") ("DONE") ("STOP") ("REPORT") ("BUG")              ("WAITING") ("VERIFY") ("KNOWNCAUSE") ("FIXED") ("CANCELED") ("DELEGATED") ("FEEDBACK"   . t))
                ("WAITING"     ("TODO") ("WORK") ("WAIT") ("HOLD") ("DONE") ("STOP") ("REPORT") ("BUG") ("FEEDBACK")             ("VERIFY") ("KNOWNCAUSE") ("FIXED") ("CANCELED") ("DELEGATED") ("WAITING"    . t))
                ("VERIFY"      ("TODO") ("WORK") ("WAIT") ("HOLD") ("DONE") ("STOP") ("REPORT") ("BUG") ("FEEDBACK") ("WAITING")            ("KNOWNCAUSE") ("FIXED") ("CANCELED") ("DELEGATED") ("VERIFY"     . t))
                ("KNOWNCAUSE"  ("TODO") ("WORK") ("WAIT") ("HOLD") ("DONE") ("STOP") ("REPORT") ("BUG") ("FEEDBACK") ("WAITING") ("VERIFY")                ("FIXED") ("CANCELED") ("DELEGATED") ("KNOWNCAUSE" . t))
                ("FIXED"       ("TODO") ("WORK") ("WAIT") ("HOLD") ("DONE") ("STOP") ("REPORT") ("BUG") ("FEEDBACK") ("WAITING") ("VERIFY") ("KNOWNCAUSE")           ("CANCELED") ("DELEGATED") ("FIXED"      . t))

                ("CANCELLED"   ("TODO") ("WORK") ("WAIT") ("HOLD") ("DONE") ("STOP") ("REPORT") ("BUG") ("FEEDBACK") ("WAITING") ("VERIFY") ("KNOWNCAUSE") ("FIXED")              ("DELEGATED") ("CANCELED"   . t))
                ("DELEGATED"   ("TODO") ("WORK") ("WAIT") ("HOLD") ("DONE") ("STOP") ("REPORT") ("BUG") ("FEEDBACK") ("WAITING") ("VERIFY") ("KNOWNCAUSE") ("FIXED") ("CANCELED")               ("DELEGATED"  . t))
            ))
        )

        (defun psimacs/internal/org-remove-empty-drawer-on-clock-out()
            (save-excursion
                (beginning-of-line 0)
                (org-remove-empty-drawer-at "LOGBOOK" (point))
            )
        )

        (add-hook 'org-clock-out-hook 'psimacs/internal/org-remove-empty-drawer-on-clock-out 'append)

        (setq org-use-fast-todo-selection t)
        (setq org-treat-S-cursor-todo-selection-as-state-change nil)
        (setq org-src-fontify-natively t)
        (setq org-list-description-max-indent 5)

        (setq org-adapt-indentation nil)
        ;(setq org-hide-leading-stars 'hidestars) ; see org-superstar

        (setq org-indent-mode-turns-off-org-adapt-indentation t)
        (setq org-indent-mode-turns-on-hiding-stars t)

        (setq org-src-preserve-indentation t)

        (org-indent-mode t)

        (setq org-agenda-files (list psimacs/config/agenda-dir))

        (setq org-highest-priority ?A)
        (setq org-lowest-priority  ?C)
        (setq org-default-priority ?A)

        (setq org-priority-faces '(
            (?A . (:background "Snow" :foreground "Red"))
            (?B . (:background "Snow" :foreground "BlueViolet"))
            (?C . (:background "Snow" :foreground "DarkGreen"))
        ))

        (setq org-agenda-window-setup 'current-window)

        (unless (file-directory-p psimacs/config/agenda-dir)
            (mkdir psimacs/config/agenda-dir t)
        )

        (defun psimacs/internal/org-capture-file-link ()
            (let (
                (result "")
                (file (org-capture-get :original-file))
                )
                (when file
                    (setq result
                        (concat
                            "[[file:"
                            file
                            "::"
                            (with-current-buffer (org-capture-get :original-file-nondirectory) (number-to-string (line-number-at-pos)))
                            "]["
                            (org-capture-get :original-file-nondirectory)
                            "]]")))
                result
            )
        )

        (defun psimacs/internal/org-capture-code-block ()
            (let (region-text result mode arg)
                (setq retult "")
                (setq region-text (org-capture-get :initial))
                (if (> (length region-text) 0)
                    (progn
                        (setq mode (with-current-buffer (org-capture-get :original-file-nondirectory) major-mode))
                        (setq arg "")
                        (when (equal mode 'awk-mode)          (setq arg "awk"))
                        (when (equal mode 'c++-mode)          (setq arg "cpp"))
                        (when (equal mode 'c-mode)            (setq arg "C"))
                        (when (equal mode 'calc-mode)         (setq arg "calc"))
                        (when (equal mode 'graphviz-dot-mode) (setq arg "dot"))
                        (when (equal mode 'lisp-mode)         (setq arg "emacs-lisp"))
                        (when (equal mode 'latex-mode)        (setq arg "latex"))
                        (when (equal mode 'org-mode)          (setq arg "org"))
                        (when (equal mode 'perl-mode)         (setq arg "perl"))
                        (when (equal mode 'plantuml-mode)     (setq arg "plantuml"))
                        (when (equal mode 'python-mode)       (setq arg "python"))
                        (when (equal mode 'sh-mode)           (setq arg "shell"))
                        (when (equal mode 'prolig-mode)       (setq arg "prolog"))

                        (setq result (concat
                            "\n"
                            "#+BEGIN_SRC" " " arg "\n"
                            region-text "\n"
                            "#+END_SRC" "\n"
                            ))))
                result
            )
        )

        (defun psimacs/internal/org-catpure-set-templates ()
            (let (
                    (code-point-template "* %? %^G\nEntered: %U\n%(psimacs/internal/org-capture-file-link)\n %(psimacs/internal/org-capture-code-block)\n")
                    (todo-template      "* TODO [#A] %? %^G\nEntered:   %U\nScheduled: %(org-insert-time-stamp (org-read-date nil t \"+0d\"))\n%i\n")
                    (note-template      "* %? :Note:%^G\nEntered: %U\n")
                    (meeting-template   "* %? :Meeting:%^G\nEntered:   %U\nScheduled: %T\n")
                    (journal-template   "** %^{Heading}\nEntered: %U\n%i\n%a")
                    (log-time-template  "** %U - %^{Activity} :Time:")

                    (code-diary-file (concat psimacs/config/agenda-dir psimacs/config/org-capture-coding-diary-file))
                    (diary-file      (concat psimacs/config/agenda-dir "Diary.org"))
                    (journal-file    (concat psimacs/config/agenda-dir "Journal.org"))
                    (time-log-file   (concat psimacs/config/agenda-dir "TimeLog.org"))
                )

                (setq org-capture-templates
                    `(
                        ("c" "Code Point" entry (file+headline ,diary-file      "Code Points") ,code-point-template :empty-lines 1)
                        ("C" "Code Point" entry (file+headline ,code-diary-file "Code Points") ,code-point-template :empty-lines 1)
                        ("t" "ToDo"       entry (file+headline ,diary-file      "Tasks")       ,todo-template       :empty-lines 1)
                        ("T" "ToDo"       entry (file+headline ,code-diary-file "Tasks")       ,todo-template       :empty-lines 1)
                        ("n" "Note"       entry (file+headline ,diary-file      "Notes")       ,note-template       :empty-lines 1)
                        ("N" "Note"       entry (file+headline ,code-diary-file "Notes")       ,note-template       :empty-lines 1)
                        ("m" "Meeting"    entry (file+headline ,diary-file      "Meetings")    ,meeting-template    :empty-lines 1)
                        ("M" "Meeting"    entry (file+headline ,code-diary-file "Meetings")    ,meeting-template    :empty-lines 1)
                        ("j" "Journal"    entry (file+datetree ,journal-file)                  ,journal-template)
                        ("l" "Log Time"   entry (file+datetree ,time-log-file)                 ,log-time-template)
                    )
                )
            )
        )

        (psimacs/internal/org-catpure-set-templates)

        ;
        ; Counsel tag completion does not work properly.
        ;
        (require 'counsel)
        (with-eval-after-load 'org
            (define-key org-mode-map (kbd "C-c C-S-q") #'counsel-org-tag))
        (with-eval-after-load 'org-agenda
            (define-key org-agenda-mode-map (kbd "C-c C-S-q") #'counsel-org-tag-agenda))

        ; warn me of any deadlines in next 7 days
        (setq org-deadline-warning-days 7)
        ; show me tasks scheduled or due in next fortnight
        (setq org-agenda-span (quote fortnight))
        ; don't show tasks as scheduled if they are already shown as a deadline
        (setq org-agenda-skip-scheduled-if-deadline-is-shown t)
        ; don't give awarning colour to tasks with impending deadlines if they are scheduled to be done
        (setq org-agenda-skip-deadline-prewarning-if-scheduled (quote pre-scheduled))
        ; don't show tasks that are scheduled or have deadlines in the normal todo list
        (setq org-agenda-todo-ignore-deadlines (quote all))
        (setq org-agenda-todo-ignore-scheduled (quote all))
        ; sort tasks in order of when they are due and then by priority
        (setq org-agenda-sorting-strategy
            (quote
                (
                    (agenda deadline-up priority-down)
                    (todo priority-down category-keep)
                    (tags priority-down category-keep)
                    (search category-keep)
                )
            )
        )

        ; Do not dim blocked tasks
        (setq org-agenda-dim-blocked-tasks nil)
        ; Compact the block agenda view
        (setq org-agenda-compact-blocks t)

        (setq org-confirm-babel-evaluate nil)


        (defun psimacs/internal/org-inline-css-hook (exporter)
            "Insert custom inline css on html export.

Insert custom inline css to automatically set the background of
code to whatever theme I'm using's background."
            (when (eq exporter 'html)
                (let* (
                        (pre-bg (face-background 'default))
                        (pre-fg (face-foreground 'default))
                    )
                    (setq org-html-head-extra
                        (concat
                            org-html-head-extra
                            (format "<style type=\"text/css\">\n pre.src {background-color: %s; color: %s;}</style>\n" pre-bg pre-fg)
                        )
                    )
                )
            )
        )


        (add-hook 'org-export-before-processing-hook 'psimacs/internal/org-inline-css-hook)

        ;; Org babel language support
        (org-babel-do-load-languages 'org-babel-load-languages '(
            (C . t)
            (python . t)
            (plantuml . t)
            (dot . t)
            (emacs-lisp . t)
            (latex . t)
        ))

        (setq org-plantuml-jar-path (expand-file-name psimacs/config/plantuml-jar-file))


        (defun psimacs/internal/export-filter-section-canceled (text backend info)
          "Do not export the content of sections marked as canceled."
          (message "TEXT: %s" text)
          ""
          )

        (require 'ox)
        (add-to-list 'org-export-filter-headline-functions 'psimacs/internal/export-filter-section-canceled)

    :bind (
        ("C-c a" . org-agenda)
    )
    :bind* (
        ("C-c c" . org-capture)
    )
)
#+END_SRC

*** Prettify headings with Org-Superstar

Prettify headings and plain lists in Org mode. Package [[https://github.com/integral-dw/org-superstar-mode][org-superstar]] is a direct descendant of
[[https://github.com/sabof/org-bullets][org-bullets]], with most of the code base completely rewritten.


#+BEGIN_SRC emacs-lisp :tangle config/init-advanced-org-mode.el
;;
;; Prettify headings and plain lists in Org mode
;;
(use-package org-superstar
    :after org
    :config
        ;(setq org-superstar-special-todo-items t)

        ;(setq org-superstar-headline-bullets-list '( "Ⅰ" "Ⅱ" "Ⅲ" "Ⅳ" "Ⅴ" "Ⅵ" "Ⅶ" "Ⅷ" "Ⅸ" "Ⅹ" ))
        (setq org-superstar-headline-bullets-list '( "✸" "◆" "★" "▶" "✿" "✜" "■" "●" ))
        (setq org-superstar-item-bullet-alist '( (?* . ?☆) (?+ . ?○) (?- . ?▷) ))

        ;    ;; Document Title, (\huge)
        (set-face-attribute 'org-document-title nil
                             :height 2.074
                             :foreground 'unspecified
                             :inherit 'default
        )

        (set-face-attribute 'org-superstar-item nil :height 1.2)
        (set-face-attribute 'org-superstar-header-bullet nil :height 1.2)
        (set-face-attribute 'org-superstar-leading nil :height 1.3)

        (setq org-hide-leading-stars nil)
        ;(setq org-superstar-leading-bullet ?\s)
        ;(setq org-superstar-leading-bullet ".")
        (setq org-superstar-leading-bullet "‧")

        ;(setq org-superstar-remove-leading-stars t)

        ;; Hide away leading stars on terminal.
        (setq org-superstar-leading-fallback ?\s)

        ;(setq inhibit-compacting-font-caches t)

        (add-hook 'org-mode-hook (lambda () (org-superstar-mode 1)))
)
#+END_SRC

*** Insert links from the clipboard

The [[https://github.com/rexim/org-cliplink][org-cliplink]] package inserts [[https://orgmode.org][org-mode]] links from the clipboard.

A simple command =C-x p i= that takes a URL from the clipboard and inserts an [[https://orgmode.org][org-mode]] link with a title
of a page found by the URL into the current buffer.

See also: [[https://github.com/rexim/org-cliplink][org-cliplink]]

| Keybinding | Command            | Description                               |
|------------+--------------------+-------------------------------------------|
| =C-x p i=  | =M-x org-cliplink= | Insert [[https://orgmode.org][org-mode]] links from the clipboard. |
|------------+--------------------+-------------------------------------------|

#+BEGIN_SRC emacs-lisp :tangle config/init-advanced-org-mode.el
;;
;; Insert links from the clipboard
;;
(use-package org-cliplink
    :after org
    :bind*
        ("C-x p i" . org-cliplink)
)
#+END_SRC

*** Auto completion for Org-Mode :noexport:

[[https://github.com/aki2o/org-ac][Org-ac]] is an extension of *Emacs* that provide auto-complete sources for [[https://orgmode.org][org-mode]].
You'll be able to use auto-complete as substitute for pcomplete which is bound
to =M-<TAB>=.

#+BEGIN_SRC emacs-lisp :tangle config/init-advanced-org-mode.el
;;
;; Provide auto-complete sources for org-mode
;;
(use-package org-ac
    :after org
    :init
        (org-ac/config-default)
)
#+END_SRC

*** Presentation with Org-Mode

Presenting with [[https://orgmode.org][org-mode]]:
- [[http://orgmode.org/worg/exporters/beamer/ox-beamer.html][Org Manual: Beamer presentations]]
- [[http://orgcandman.github.io/blog/2016/01/:dat/Writing-emacs-presentations-with-beamer.html][Writing presentations in emacs with Beamer]]
- [[https://github.com/eschulte/epresent][epresent Package]]
- [[http://orgmode.org/worg/org-tutorials/non-beamer-presentations.html][Writing Non-Beamer presentations in org-mode]]
- [[http://sachachua.com/blog/2013/04/how-to-present-using-org-mode-in-emacs/][How to present using Org-mode in Emacs]]

#+BEGIN_SRC emacs-lisp :tangle config/init-advanced-org-mode.el
;;
;; Presentations with org-mode
;;
(use-package ox-beamer :straight nil :after org)
(use-package epresent :straight t :after org)
#+END_SRC

*** Keybinding for Org-Mode                                        :noexport:

Some personal org-mode Key-bindings. This is only a suggestion from [[http://doc.norang.ca/org-mode.html][Organize Your Life In Plain Text!]].
Therefore it is currently diasabled and should be activated after getting familiar with [[https://orgmode.org][org-mode]].

#+BEGIN_SRC emacs-lisp :tangle config/init-advanced-org-mode.el
;;
;; Custom Org-Mode key bindings
;;
(global-set-key (kbd "<f12>") 'org-agenda)
(global-set-key (kbd "<f5>") 'bh/org-todo)
(global-set-key (kbd "<S-f5>") 'bh/widen)
(global-set-key (kbd "<f7>") 'bh/set-truncate-lines)
(global-set-key (kbd "<f8>") 'org-cycle-agenda-files)
(global-set-key (kbd "<f9> <f9>") 'bh/show-org-agenda)
(global-set-key (kbd "<f9> b") 'bbdb)
(global-set-key (kbd "<f9> c") 'calendar)
(global-set-key (kbd "<f9> f") 'boxquote-insert-file)
(global-set-key (kbd "<f9> g") 'gnus)
(global-set-key (kbd "<f9> h") 'bh/hide-other)
(global-set-key (kbd "<f9> n") 'bh/toggle-next-task-display)

(global-set-key (kbd "<f9> I") 'bh/punch-in)
(global-set-key (kbd "<f9> O") 'bh/punch-out)

(global-set-key (kbd "<f9> o") 'bh/make-org-scratch)

(global-set-key (kbd "<f9> r") 'boxquote-region)
(global-set-key (kbd "<f9> s") 'bh/switch-to-scratch)

(global-set-key (kbd "<f9> t") 'bh/insert-inactive-timestamp)
(global-set-key (kbd "<f9> T") 'bh/toggle-insert-inactive-timestamp)

(global-set-key (kbd "<f9> v") 'visible-mode)
(global-set-key (kbd "<f9> l") 'org-toggle-link-display)
(global-set-key (kbd "<f9> SPC") 'bh/clock-in-last-task)
(global-set-key (kbd "C-<f9>") 'previous-buffer)
(global-set-key (kbd "M-<f9>") 'org-toggle-inline-images)
(global-set-key (kbd "C-x n r") 'narrow-to-region)
(global-set-key (kbd "C-<f10>") 'next-buffer)
(global-set-key (kbd "<f11>") 'org-clock-goto)
(global-set-key (kbd "C-<f11>") 'org-clock-in)
(global-set-key (kbd "C-s-<f12>") 'bh/save-then-publish)
(global-set-key (kbd "C-c c") 'org-capture)

(defun bh/hide-other ()
    (interactive)
    (save-excursion
        (org-back-to-heading 'invisible-ok)
        (hide-other)
        (org-cycle)
        (org-cycle)
        (org-cycle)))

(defun bh/set-truncate-lines ()
    "Toggle value of truncate-lines and refresh window display."
    (interactive)
    (setq truncate-lines (not truncate-lines))
    ;; now refresh window display (an idiom from simple.el):
    (save-excursion
        (set-window-start (selected-window)
            (window-start (selected-window)))))

(defun bh/make-org-scratch ()
    (interactive)
    (find-file "/tmp/publish/scratch.org")
    (gnus-make-directory "/tmp/publish"))

(defun bh/switch-to-scratch ()
    (interactive)
    (switch-to-buffer "*scratch*"))
#+END_SRC

* Overview of Psimacs key bindings

The following tables summarizes the key bindings added explicitly by *Psimacs*. Neither shown are the bindings provided
by the various packages nor by *Emacs* itself.

| Prefix command                       | Description               |
|--------------------------------------+---------------------------|
| =H-h= and =s-h=                      | Hydras                    |
| =H-c= and =s-c=                      | common user commands      |
| =H-x= and =s-x=                      | common execution commands |
| =H-m=, =H-,= =s-m=, =s-,= and =<f9>= | special user commands     |
|--------------------------------------+---------------------------|

#+ATTR_HTML: :class styledtable
| Key binding       | Command                                                 | Description                                                                                                                                                                                                                                                                                      |
|-------------------+---------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| =M-<f4>=          | =M-x psimacs/config/delete-frame=                       | Delete current frame.                                                                                                                                                                                                                                                                            |
| =C-x p=           | =M-x pop-to-mark-command=                               | Jump to mark, and pop a new position for mark off the local mark ring (this does not affect the global mark ring).                                                                                                                                                                               |
|-------------------+---------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| =<f2>=            | =M-x bm-next=                                           | Jump to the next bookmark.                                                                                                                                                                                                                                                                       |
| =S-<f2>=          | =M-x bm-previous=                                       | Jump to the previous bookmark.                                                                                                                                                                                                                                                                   |
| =C-<f2>=          | =M-x bm-toggle=                                         | Set or unset bookmark.                                                                                                                                                                                                                                                                           |
| =C-S-<f2>=        | =M-x bm-remove-all-current-buffer=                      | Remove all bookmarks of the current buffer.                                                                                                                                                                                                                                                      |
|-------------------+---------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| =C-s=             | =M-x swiper-iseach=                                     | A =swiper= that’s not line-based. Incrementally search with an overview.                                                                                                                                                                                                                         |
| =C-r=             | =M-x swiper=                                            | Incrementally search with an overview.                                                                                                                                                                                                                                                           |
| =C-c v=           | =M-x ivy-push-view=                                     | Push the current window tree on =ivy-views=                                                                                                                                                                                                                                                      |
| =C-c V=           | =M-x ivy-pop-view=                                      | Delete a view to delete from =ivy-views=.                                                                                                                                                                                                                                                        |
| =C-x b=           | =M-x ivy-switch-buffer=                                 | Switch to another buffer.                                                                                                                                                                                                                                                                        |
| =C-c C-S-r=       | =M-x ivy-resume=                                        | Resumes the last Ivy-based completion.                                                                                                                                                                                                                                                           |
| =M-y=             | =M-x ivy-next-line=                                     | In minibuffer, Move cursor vertically down.                                                                                                                                                                                                                                                      |
| =C-'=             | =M-x ivy-avy=                                           | Uses avy to select one of the candidates on the current candidate page.                                                                                                                                                                                                                          |
| =M-x=             | =M-x counsel-M-x=                                       | Ivy version of =execute-extended-command=.                                                                                                                                                                                                                                                       |
| =C-M-i=           | =M-x counsel-imenu=                                     | Jump to a buffer position indexed by =imenu=.                                                                                                                                                                                                                                                    |
| =C-x C-f=         | =M-x counsel-find-file=                                 | Counsel, forward to =find-file=.                                                                                                                                                                                                                                                                 |
| =C-c b=           | =M-x counsel-bookmark=                                  | Forward to =bookmark-jump= or =bookmark-set= if bookmark does not exist.                                                                                                                                                                                                                         |
| =C-c c=           | =M-x counsel-compile=                                   | Call =compile= completing with smart suggestions, optionally for DIR.                                                                                                                                                                                                                            |
| =C-c d=           | =M-x counsel-dired-jump=                                | Jump to a directory below the current directory.                                                                                                                                                                                                                                                 |
| =C-c F=           | =M-x counsel-org-file=                                  | Browse all attachments for current Org file.                                                                                                                                                                                                                                                     |
| =C-c g=           | =M-x counsel-git=                                       | Find file in the current git repository.                                                                                                                                                                                                                                                         |
| =C-c j=           | =M-x counsel-git-grep=                                  | Grep for a string in the current Git repository.                                                                                                                                                                                                                                                 |
| =C-c L=           | =M-x counsel-git-log=                                   | Call the =git log --grep= shell command.                                                                                                                                                                                                                                                         |
| =C-c J=           | =M-x counsel-file-jump=                                 | Jump to a file below the current directory..                                                                                                                                                                                                                                                     |
| =C-c k=           | =M-x counsel-ag=                                        | Grep for a string in a root directory using =ag=.                                                                                                                                                                                                                                                |
| =C-c l=           | =M-x counsel-locate=                                    | Call a "locate" style shell command.                                                                                                                                                                                                                                                             |
| =M-y=             | =M-x counsel-yank-pop=                                  | Ivy replacement for =yank-pop=.                                                                                                                                                                                                                                                                  |
| =C-h f=           | =M-x counsel-describe-function=                         | Forward to =describe-function=.                                                                                                                                                                                                                                                                  |
| =C-h i=           | =M-x counsel-info-lookup-symbol=                        | Forward SYMBOL to =info-lookup-symbol= with ivy completion.                                                                                                                                                                                                                                      |
| =C-h j=           | =M-x counsel-set-variable=                              | Set a variable SYM with completion.                                                                                                                                                                                                                                                              |
| =C-h l=           | =M-x counsel-find-library=                              | Find Emacs Lisp source. Forward to =find-library=.                                                                                                                                                                                                                                               |
| =C-h u=           | =M-x counsel-unicode-char=                              | Insert COUNT copies of a unicode char at point.                                                                                                                                                                                                                                                  |
| =C-h v=           | =M-x counsel-describe-variable=                         | Forward to =describe-function=.                                                                                                                                                                                                                                                                  |
| =C-r=             | =M-x counsel-minibuffer-history=                        | Browse minibuffer history.                                                                                                                                                                                                                                                                       |
| =C-r=             | =M-x counsel-expression-history=                        | In =read-expression-map=                                                                                                                                                                                                                                                                         |
|-------------------+---------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| =C-x p i=         | =M-x org-cliplink=                                      | Insert [[https://orgmode.org][org-mode]] links from the clipboard.                                                                                                                                                                                                                                                        |
|-------------------+---------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| =H-c C-e=         | =M-x edit-indirect-region=                              | Edit region in separate buffer *edit-indirect buffer*                                                                                                                                                                                                                                            |
|-------------------+---------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| =H-m (=           | =M-x psimacs/pair/insert-paren=                         | Insert paranthesis =(▮)=.                                                                                                                                                                                                                                                                        |
| =H-m [=           | =M-x psimacs/pair/insert-bracket=                       | Insert brackets =[▮]=.                                                                                                                                                                                                                                                                           |
| =H-m {=           | =M-x psimacs/pair/insert-brace=                         | Insert braces ={▮}=.                                                                                                                                                                                                                                                                             |
| =H-m "=           | =M-x psimacs/pair/insert-ascii-double-quote=            | Insert ascii double quotes ="▮"=.                                                                                                                                                                                                                                                                |
| =H-m '=           | =M-x psimacs/pair/insert-ascii-single-quote=            | Insert ascii single quotes ='▮'=.                                                                                                                                                                                                                                                                |
| =H-m e=           | =M-x psimacs/pair/insert-emacs-quote=                   | Insert emacs quotes =`▮'=.                                                                                                                                                                                                                                                                       |
| =H-m ==           | =M-x psimacs/pair/insert-equal=                         | Insert equality signs ==▮==.                                                                                                                                                                                                                                                                     |
| =H-m *=           | =M-x psimacs/pair/insert-star=                          | Insert stars =*▮*=.                                                                                                                                                                                                                                                                              |
| =H-m /=           | =M-x psimacs/pair/insert-slash=                         | Insert slashes =/▮/=.                                                                                                                                                                                                                                                                            |
|-------------------+---------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| =<f12>=           | =M-x cua-mode=                                          | Toggle CUA mode.                                                                                                                                                                                                                                                                                 |
| =H-m c=           | =M-x cua-mode=                                          | Toggle CUA mode.                                                                                                                                                                                                                                                                                 |
|-------------------+---------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| =H-m C-c C-h=     | (find-file-read-only history-file)                      | Open the history file in read-only mode.                                                                                                                                                                                                                                                         |
|-------------------+---------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| =H-m C-f m=       | =M-x flyspell-mode=                                     | Minor mode performing on-the-fly spelling checking.                                                                                                                                                                                                                                              |
|-------------------+---------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| =H-m C-f r=       | =M-x flyspell-region=                                   | Checks all words inside a region.                                                                                                                                                                                                                                                                |
| =H-m C-f b=       | =M-x flyspell-buffer=                                   | Checks the whole buffer.                                                                                                                                                                                                                                                                         |
| =H-m C-f w=       | =M-x flyspell-word=                                     | Spell check a word.                                                                                                                                                                                                                                                                              |
|-------------------+---------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| =C-,=             | =M-x flyspell-goto-next-error=                          | Go to the next previously detected error.                                                                                                                                                                                                                                                        |
| =C-.=             | =M-x flyspell-auto-correct-word=                        | Automatically Correct the current word. This command proposes various successive corrections for the current word.                                                                                                                                                                               |
| =C-:=             | =M-x flyspell-auto-correct-previous-word=               | Auto correct the first mispelled word that occurs before point.                                                                                                                                                                                                                                  |
| =C-;=             | =M-x flyspell-correct-wrapper=                          | By default jumps to the first misspelled word before the point and prompts for correction and gets you back. Calling it with =C-u= gives ability to correct multiple misspelled words in one run. =C-u C-u= changes direction. =C-u C-u C-u= changes direction and enables multiple corrections. |
| =H-m C-f a=       | =M-x flyspell-correct-at-point=                         | To correct word at point.                                                                                                                                                                                                                                                                        |
| =H-m C-f p=       | =M-x flyspell-correct-previous=                         | To correct any visible word before the point.                                                                                                                                                                                                                                                    |
| =H-m C-f n=       | =M-x flyspell-correct-next=                             | To correct any visible word after the point.                                                                                                                                                                                                                                                     |
| =H-m C-f c=       | =M-x flyspell-check-previous-highlighted-word=          | Correct the closer misspelled word.                                                                                                                                                                                                                                                              |
|-------------------+---------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| =H-m C-f g=       | =M-x psimac/spell/switch-to-german=                     | Change to german language dictionary.                                                                                                                                                                                                                                                            |
| =H-m C-f e=       | =M-x psimac/spell/switch-to-english=                    | Change to english language dictionary.                                                                                                                                                                                                                                                           |
| =H-m C-f t=       | =M-x psimac/spell/toggle-language=                      | Toggle german and english language dictionaries.                                                                                                                                                                                                                                                 |
|-------------------+---------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| =H-m C-p C-p b=   | =M-x print-buffer=                                      | B/W print hardcopy of buffer on default printer                                                                                                                                                                                                                                                  |
| =H-m C-p C-p r=   | =M-x print-region=                                      | B/W print hardcopy of region on default printer                                                                                                                                                                                                                                                  |
|-------------------+---------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| =H-m C-p C-q p=   | =M-x ps-print-buffer=                                   | B/W print buffer via Ghostscript                                                                                                                                                                                                                                                                 |
| =H-m C-p C-q r=   | =M-x ps-print-region=                                   | B/W print region via Ghostscript                                                                                                                                                                                                                                                                 |
|-------------------+---------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| =H-m C-p C-f p=   | =M-x ps-print-buffer-with-faces=                        | Color print buffer via Ghostscript                                                                                                                                                                                                                                                               |
| =H-m C-p C-f r=   | =M-x ps-print-region-with-faces=                        | Color print region via Ghosts                                                                                                                                                                                                                                                                    |
|-------------------+---------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| =H-m C-s C-a c=   | =M-x avy-goto-char=                                     | Input one char, jump to it with a tree.                                                                                                                                                                                                                                                          |
| =H-m C-s C-a C=   | =M-x avy-goto-char-2=                                   | Input two consecutive chars, jump to the first one with a tree.                                                                                                                                                                                                                                  |
| =H-m C-s C-a t=   | =M-x avy-goto-char-timer=                               | Input an arbitrary amount of consecutive chars, jump to the first one with a tree.                                                                                                                                                                                                               |
| =H-m C-s C-a T=   | =M-x avy-org-goto-heading-timer=                        | Type part of an Org heading. When you stop typing it will be jumped to; if more than one matches, you can jump to a heading with Avy.                                                                                                                                                            |
| =H-m C-s C-a l=   | =M-x avy-goto-line=                                     | Input zero chars, jump to a line start with a tree.                                                                                                                                                                                                                                              |
| =H-m C-s C-a w=   | =M-x avy-goto-word-1=                                   | Input one char at word start, jump to a word start with a tree.                                                                                                                                                                                                                                  |
| =H-m C-s C-a W=   | =M-x avy-goto-word-0=                                   | Input zero chars, jump to a word start with a tree.                                                                                                                                                                                                                                              |
|-------------------+---------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| =H-m C-s a=       | =M-x swiper-all=                                        | Incrementally search in all open buffers.                                                                                                                                                                                                                                                        |
| =H-m C-s s=       | =M-x isearch-forward=                                   | Incrementally search forward.                                                                                                                                                                                                                                                                    |
| =H-m C-s r=       | =M-x isearch-backward=                                  | Incrementally search backward.                                                                                                                                                                                                                                                                   |
|-------------------+---------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| =H-m C-u C-w t=   | =M-x psimacs/which-key/toogle-sort-order=               | Toggle the which-key-mode sort order.                                                                                                                                                                                                                                                            |
| =H-m C-u C-w c=   | =M-x psimacs/which-key/cycle-sort-order=                | Cycle through the which-key-mode sort orders.                                                                                                                                                                                                                                                    |
|-------------------+---------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| =H-m C-w C-x 5 l= | =M-x psimacs/window/set-frame-creation-strategy-layout= | Place and size new frames left and right to the main frame. This is the default strategy.                                                                                                                                                                                                        |
| =H-m C-w C-x 5 m= | =M-x psimacs/window/set-frame-creation-strategy-main=   | Always use the same placement and size as the initial main frame.                                                                                                                                                                                                                                |
| =H-m C-w C-x 5 s= | =M-x psimacs/window/set-frame-creation-strategy-system= | Let Emacs and the operating system decide.                                                                                                                                                                                                                                                       |
|-------------------+---------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| =H-m C-w C-s s=   | =M-x smooth-scrolling-mode=                             | Enable or disable the smooth scrolling mode.                                                                                                                                                                                                                                                     |
|-------------------+---------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| =H-m C-w C-r=     | =M-x golden-ratio-mode=                                 | Toggle automatic window resizing with golden ratio.                                                                                                                                                                                                                                              |
|-------------------+---------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| =H-m C-x C-a=     | =M-x abbrev-mode=                                       | Enable/Disable abbreviation mode.                                                                                                                                                                                                                                                                |
|-------------------+---------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| =H-x r=           | =M-x recentf-open-files=                                | Show a dialog to open a recent file.                                                                                                                                                                                                                                                             |
| =H-x C-r=         | =M-x recentf-open-more-files=                           | Show a dialog to open a recent file that is not in the menu.                                                                                                                                                                                                                                     |
|-------------------+---------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| =H-x f=           | =M-x counsel-recentf=                                   | Find a file on recent file list.                                                                                                                                                                                                                                                                 |
| =H-x C-f=         | =M-x counsel-buffer-or-recentf=                         | Find a buffer visiting a file or file on recent file list.                                                                                                                                                                                                                                       |
|-------------------+---------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| =H-m H-h C-m=     | =M-x discover-my-major=                                 | Create a listing of all major-mode keys with their description.                                                                                                                                                                                                                                  |
| =H-m H-h M-m=     | =M-x discover-my-mode=                                  | Create a listing of all MODE keys with their description.                                                                                                                                                                                                                                        |
|-------------------+---------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| =H-m H-h b=       | =M-x helm-descbinds=                                    | Create a listing of all key bindings of current major mode.                                                                                                                                                                                                                                      |
|-------------------+---------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| =H-m H-h m=       | =M-x helm-describe-modes=                               | Create a listing of all modes of current major mode.                                                                                                                                                                                                                                             |
|-------------------+---------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
